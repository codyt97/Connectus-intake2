<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ConnectUS â€” Sales Reps â€¢ Intake</title>

<style>
  /* ===== White + Green theme ===== */
  .error { border-color: var(--danger) !important; box-shadow: 0 0 0 3px #dc262633 !important; }
.warnbox { background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; padding:10px; border-radius:10px; font-size:12px; margin-top:8px; }

  :root{
    /* palette */
    --bg:#ffffff;                /* page background */
    --ink:#0b1b12;               /* primary text (very dark green) */
    --muted:#5b6b61;             /* secondary text */
    --line:#e6efe9;              /* subtle borders */
    --card:#ffffff;              /* cards/drawers */
    --accent:#16a34a;            /* primary green */
    --accent-600:#15803d;        /* hover/active green */
    --accent-50:#ecfdf5;         /* faint green background */
    --danger:#dc2626;            /* remove buttons */
    --warn:#b45309;              /* warning */
    --ok:#15803d;                /* success */
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
  }
  .wrap{max-width:1240px;margin:24px auto;padding:0 16px}
  h1{font-size:28px;margin:0 0 10px}
  h3{margin:0 0 8px}
  .sub{color:var(--muted);font-size:13px;margin-bottom:12px}

  /* ===== Main Tabs (2 big sections) ===== */
  .maintabs{
    position:sticky; top:0; z-index:50;
    display:flex; gap:10px; align-items:center;
    padding:10px 16px; margin:-10px -16px 14px;
    background:#fffffff2; backdrop-filter:saturate(1.1) blur(6px);
    border-bottom:1px solid var(--line);
  }
  .mtab{
    padding:10px 14px; border:1px solid var(--line); border-radius:999px;
    background:#fff; color:var(--ink); cursor:pointer; font-weight:600;
  }
  .mtab.active{ background:var(--accent); color:#fff; border-color:var(--accent); }
  [data-mainpanel]{ display:none; }
  [data-mainpanel].active{ display:block; }

  /* Header bar + stepper (inside Intake panel) */
  .appbar{
    position:sticky;top:54px;z-index:40;
    display:flex;align-items:center;justify-content:space-between;
    padding:10px 16px;margin:-10px -16px 12px;
    background:#fffffff2; backdrop-filter:saturate(1.1) blur(6px);
    border-bottom:1px solid var(--line);
  }
  .brandmark{display:flex;gap:10px;align-items:center}
  .brandmark .logo{width:28px;height:28px;border-radius:8px;background:conic-gradient(from 210deg,#22c55e,#86efac);border:1px solid #bbf7d0}
  .brandmark .t{font-weight:700;letter-spacing:.2px}

  .stepper{display:flex;gap:8px;flex-wrap:wrap}
  .step{
    display:flex;gap:8px;align-items:center;
    padding:6px 10px;border-radius:999px;
    border:1px solid var(--line); background:#fff; color:var(--ink); cursor:pointer;
  }
  .step .dot{width:8px;height:8px;border-radius:50%;background:#9ca3af}
  .step.active{background:var(--accent); border-color:var(--accent); color:#fff}
  .step.active .dot{background:#fff}

  /* Chips / tabs / buttons */
  .bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
  .chip{
    border:1px solid var(--line); background:#fff; color:var(--ink);
    padding:7px 10px;border-radius:999px;font-size:12px;display:flex;align-items:center;gap:8px
  }
  .chip input{accent-color:var(--accent);transform:scale(1.05)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
  .tab{
    padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--ink);
    cursor:pointer;font-size:13px
  }
  .tab.active{background:var(--accent);border-color:var(--accent);color:#fff}

  button{
    border:1px solid var(--accent); background:var(--accent); color:#fff;
    border-radius:10px; padding:10px 14px; font-size:14px; cursor:pointer
  }
  button:hover{background:var(--accent-600); border-color:var(--accent-600)}
  .ghost{background:#fff;color:var(--accent);border-color:var(--accent)}
  .ghost:hover{background:var(--accent-50)}
  .ok{background:var(--ok); border-color:var(--ok); color:#fff}
  .warn{background:#fff;border-color:var(--warn); color:var(--warn)}
  .bad{background:#fff;border-color:var(--danger); color:var(--danger)}
  .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--ink)}
  .tiny{font-size:11px;color:var(--muted)}
  .divider{height:1px;background:var(--line);margin:8px 0 14px}

  /* Cards & inputs */
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px;
    box-shadow:0 1px 0 #edf2f7;
  }
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .two{grid-column:span 12}@media(min-width:780px){.two{grid-column:span 6}}
  .three{grid-column:span 12}@media(min-width:980px){.three{grid-column:span 4}}
  .full{grid-column:1 / -1}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,textarea{
    width:100%; background:#fff; border:1px solid #d9e6de; color:var(--ink);
    border-radius:10px; padding:10px 12px; font-size:14px; outline:none
  }
  input:focus,select:focus,textarea:focus{
    border-color:var(--accent); box-shadow:0 0 0 3px #22c55e22;
  }
  .row{display:flex;gap:10px}.row>*{flex:1}

  /* Items table */
  .table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .table th{font-size:12px;color:var(--muted);text-align:left;padding:6px 8px}
  .table td{
    background:#fff;border:1px solid var(--line);border-left:none;border-right:none;
    padding:8px;font-size:13px;vertical-align:top
  }
  .table tr td:first-child{border-radius:10px 0 0 10px;border-left:1px solid var(--line)}
  .table tr td:last-child{border-radius:0 10px 10px 0;border-right:1px solid var(--line)}

  /* Subtabs */
  .subtabs{display:flex;gap:6px;margin:10px 0;flex-wrap:wrap}
  .subtab{
    font-size:12px;border:1px solid var(--line);border-radius:999px;padding:6px 12px;background:#fff;color:var(--ink);cursor:pointer
  }
  .subtab.active{background:var(--accent);border-color:var(--accent);color:#fff}

  /* Drawers */
  .drawer{
    position:fixed;top:0;right:0;height:100%;width:min(560px,96vw);
    transform:translateX(100%);transition:transform .25s ease;z-index:60;
    background:#fff;border-left:1px solid var(--line);box-shadow:-8px 0 20px rgba(0,0,0,.06)
  }
  .drawer.active{transform:translateX(0)}
  .drawer header{
    display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line);
    background:#fff
  }
  .drawer .content{padding:14px;overflow:auto;height:calc(100% - 54px)}

  /* Summary */
  .summary-box{
    white-space:pre-wrap;background:#fff;border:1px dashed var(--line);border-radius:12px;padding:12px;
    font-family:ui-monospace,Consolas,monospace;font-size:13px;color:var(--ink)
  }

  /* CSV drawer bits */
  .emailPreview .muted, .muted{color:var(--muted);font-size:12px}

  /* Totals card */
  .totals{margin-top:12px;border:1px solid var(--line);border-radius:14px;background:#fff;padding:12px}
  .totals h4{margin:0 0 8px;font-size:14px;letter-spacing:.2px}
  .totals .rowline{display:flex;justify-content:space-between;margin:4px 0}
  
  /* ===== Intake Wizard ===== */
.wizard{ border:1px solid var(--line); border-radius:14px; padding:12px; background:#fff; margin:10px 0 14px }
.wiz-row{ display:flex; align-items:center; gap:12px; padding:8px 0 }
.wiz-row + .wiz-row{ border-top:1px dashed var(--line) }
.wiz-label{ min-width:180px; font-weight:700; font-size:13px }
.wiz-opts{ display:flex; gap:8px; flex-wrap:wrap }
.wiz-opts .chip{ cursor:pointer }
.wiz-hint{ color:var(--muted); font-size:12px; margin-top:6px }
.locked{ opacity:.55; pointer-events:none }

/* ---- Autosizing inputs in Items table ---- */
.table td input.autosize{
  width:auto !important;          /* override global 100% */
  min-width:72px;                 /* sensible floor so blank fields arenâ€™t tiny */
  max-width:560px;                /* cap so they donâ€™t blow up the row */
  display:inline-block;           /* needed so width can shrink/grow */
  box-sizing:content-box;         /* width reflects text content */
  transition:width .08s ease;     /* subtle smoothing */
}

.actions{ display:flex; gap:10px; flex-wrap:wrap; margin:6px 0 12px; }
@media (min-width:900px){ .actions{ justify-content:flex-end } }
</style>
</head>
<body>
<div class="wrap">

  <!-- ===== MAIN TABS ===== -->
  <nav class="maintabs" id="maintabs">
    <button class="mtab active" data-main="reps">Sales Rep Management</button>
    <button class="mtab" data-main="intake">Quote / Sales Order Intake</button>
  </nav>

  <!-- ========== PANEL: SALES REPS ========== -->
  <section data-mainpanel="reps" class="active">
    <h1>Sales Rep Management</h1>
    <div class="sub">Maintain the sales rep roster + email templates used by the New Customer flow.</div>

    <section class="card">
      <div class="grid">
        <section class="three">
          <h3>Add / Update Rep</h3>
          <label>Rep Name</label><input id="repNameInput" placeholder="e.g., Lucas Currin" />
          <label style="margin-top:10px">Email</label><input id="repEmailInput" type="email" placeholder="e.g., lucas.currin@connectuscorp.com" />
          <label style="margin-top:10px">Portal Slug (sales-rep)</label><input id="repSlugInput" placeholder="e.g., lucas-currin" />
          <label style="margin-top:10px">Template</label>
          <select id="repTemplatePick">
            <option value="custom">Custom (use editor below)</option>
            <option>Lucas Currin</option>
            <option>Max Mann</option>
            <option>John Tropeano</option>
            <option>Chris Samaras</option>
          </select>
          <label style="margin-top:10px">Template Editor</label>
          <textarea id="repTemplateText" rows="12" placeholder="Template text with {{ Customer First Name }} and {{Current Email}} placeholders"></textarea>
          <div class="row" style="margin-top:10px">
            <button class="ok" id="btnSaveRep">Save / Update Rep</button>
            <button class="ghost" id="btnResetRepForm">Reset</button>
          </div>
        </section>

        <section class="full">
          <h3>Current Reps</h3>
          <div class="tiny">These populate the Primary/Secondary Rep dropdowns in the Intake tab and power the New Customer invite.</div>
          <div id="repList" style="margin-top:8px"></div>
        </section>
      </div>
    </section>
  </section>

  <!-- ========== PANEL: INTAKE ========== -->
  <section data-mainpanel="intake">
    <!-- appbar -->
    <div class="appbar">
      <div class="brandmark">
        <div class="logo"></div><div class="t">ConnectUS â€” Quote / Sales Order</div>
      </div>
      <div class="stepper" id="stepper" style="display:none">
        <div class="step active" data-goto="customer"><div class="dot"></div>Customer</div>
        <div class="step" data-goto="shipping"><div class="dot"></div>Shipping</div>
        <div class="step" data-goto="items"><div class="dot"></div>Items</div>
        <div class="step" data-goto="mdm"><div class="dot"></div>Pro Services</div>
      </div>
    </div>

    <h1>Quote / Sales Order Intake</h1>
    <div class="sub">Tabs: <span class="pill">Customer</span> Â· <span class="pill">Shipping</span> Â· <span class="pill">Items</span> Â· <span class="pill">MDM</span></div>
    <!-- ===== INTAKE WIZARD (gates the rest) ===== -->
<section class="card wizard" id="intakeWizard">
      <!-- Step 1 -->
  <div class="wiz-row" id="wizStepRep">
    <div class="wiz-label">1) Sales Rep</div>
    <div class="wiz-opts" style="min-width:260px">
      <select id="wizRepPick" style="min-width:240px;padding:8px;border:1px solid var(--line);border-radius:10px">
        <option value="">Select Primary Sales Repâ€¦</option>
      </select>
    </div>
  </div>

    
  <!-- Step 2 -->
  <div class="wiz-row" id="wizStep1">
    <div class="wiz-label">2) Customer Type</div>
    <div class="wiz-opts">
      <label class="chip"><input type="radio" name="wizCustomerType" value="new"> New customer</label>
      <label class="chip"><input type="radio" name="wizCustomerType" value="existing"> Current customer</label>
    </div>
  </div>

  <!-- Step 3 -->
  <div class="wiz-row" id="wizStep2" style="display:none">
  <div class="wiz-label">3) Document Type</div>
  <div class="wiz-opts" id="wizDocTypeOpts">
      <label class="chip"><input type="radio" name="wizDocType" value="QUOTE" checked> QUOTE</label>
      <label class="chip"><input type="radio" name="wizDocType" value="SALES ORDER"> SALES ORDER</label>
      <!-- ðŸ‘‡ New option for current-customer only -->
      <label class="chip" id="wizCloneRow" style="display:none">
        <input type="radio" name="wizDocType" value="CLONE"> Clone Existing Order
      </label>
  </div>
</div>


  <!-- Step 4 -->
  <div class="wiz-row" id="wizStep3" style="display:none">
    <div class="wiz-label">4) Scope</div>
    <div class="wiz-opts">
      <label class="chip"><input type="radio" name="wizScope" value="hardware"> Hardware/Licenses</label>
      <label class="chip"><input type="radio" name="wizScope" value="hardware+pro"> Hardware + Pro services</label>
    </div>
  </div>
   
  <!-- Step 5 -->
  <div class="wiz-row" id="wizStep4" style="display:none">
    <div class="wiz-label">5) Order Instruction</div>
    <div class="wiz-opts" style="min-width:260px">
      <select id="oiType" style="min-width:240px;padding:8px;border:1px solid var(--line);border-radius:10px">
        <option value="">Select Order Instructionâ€¦</option>
        <option>Standard Order</option>
        <option>Ship to 3PL</option>
        <option>CUSTOM-Order and shipping instructions</option>
        <option>CUSTOM-Order Instructions</option>
        <option>CUSTOM-Shipping Instruction</option>
      </select>
    </div>
  </div>

  <div class="wiz-hint" id="wizHint">Complete steps 1â€“4 to unlock the intake tabs.</div>
</section>
 

    <!-- toggles -->
    <div class="bar" id="toggleBar" style="display:none" aria-hidden="true">
      <label class="chip"><input type="checkbox" id="flagNewCustomer"> NEW Customer</label>
      <label class="chip"><input type="checkbox" id="flagWCP"> WCP</label>
      <label class="chip"><input type="checkbox" id="flagCurrentCustomer"> Current Customer</label>
      <label class="chip"><input type="checkbox" id="flag3PL"> 3PL Restock Order</label>
      <label class="chip"><input type="radio" name="doctype" value="QUOTE" checked> QUOTE</label>
      <label class="chip"><input type="radio" name="doctype" value="SALES ORDER"> SALES ORDER</label>
      <button class="ghost" id="btnDemoFlow" title="Runs a full current-customer example">Demo: Current Customer Flow</button>
    </div>

    <!-- tabs -->
    <div class="tabs" id="intakeTabs" style="display:none">
      <button class="tab active" data-tab="customer">Customer</button>
      <button class="tab" data-tab="shipping">Shipping</button>
      <button class="tab" data-tab="items">Items</button>
      <button class="tab" data-tab="mdm">Pro Services</button>
    </div>
    <!-- Global action: keep original format/logic, always visible -->
<div class="actions">
  <button class="ghost" id="btnOpenEmail" data-open-email onclick="openEmailDrawerGuarded()">Email Order Management</button>
  <!-- <button class="ok" id="btnSubmitIntake">Submit Intake</button> -->

  <!-- NEW: Save / Clear draft buttons -->
  <button class="ghost" id="btnSaveDraft" type="button">Save Draft</button>
  <button class="ghost" id="btnClearDraft" type="button">Clear Saved Draft</button>

  <span id="submitStatus" class="tiny" style="margin-left:10px"></span>
</div>

<script>
  function openEmailDrawerGuarded(){
  const { ok, missing } = validateRequiredForEmail();
  if (!ok){ showValidationWarning(missing); return; }
  openDrawer('drawerEmail');
}
</script>
<script>
// === Auto-close "Email Order Management" drawer on outside click / Esc ===
// === Auto-close "Email Order Management" drawer on outside click / Esc ===
window.addEventListener('DOMContentLoaded', function initEmailDrawerAutoClose(){
  const drawer = document.getElementById('drawerEmail');
  if (!drawer) return;

  // Treat as visible when .active is present (matches your CSS)
  const isVisible = () => drawer.classList.contains('active');

  // Close helper (reuse your global close fn if present)
  function closeEmailDrawer(){
    if (typeof closeDrawer === 'function') closeDrawer('drawerEmail');
    else drawer.classList.remove('active');
  }

  // Ignore clicks that occur inside the drawer or on openers
  function shouldIgnore(target){
    if (!target) return false;
    if (drawer.contains(target)) return true;
    if (target.closest('[data-open-email]')) return true;
    // Optional: ignore common floating UI bits
    if (target.closest('.datepicker, .flatpickr-calendar, .dropdown-menu, .select-menu')) return true;
    return false;
  }

  // Close on outside click/tap (capture to beat stopPropagation)
  document.addEventListener('pointerdown', function(e){
    if (!isVisible()) return;
    if (shouldIgnore(e.target)) return;
    closeEmailDrawer();
  }, true);

  // Close on Escape
  document.addEventListener('keydown', function(e){
    if (!isVisible()) return;
    if (e.key === 'Escape') closeEmailDrawer();
  });

  // Also close when switching main tabs or subtabs (prevents stale views)
  const tabSelectors = '[data-main], .tab, .subtab, [data-tab]';
  document.querySelectorAll(tabSelectors).forEach(btn => {
    // Skip the email opener
    if (btn.matches('[data-open-email]')) return;
    btn.addEventListener('click', () => { if (isVisible()) closeEmailDrawer(); });
  });
});
</script>

    <!-- CUSTOMER -->
    <section class="card" data-panel="customer">
      <div class="grid">
        <section class="three">
          <h3>Sales & Partner</h3>
          <label>Primary Sales Rep</label>
          <select id="rep1"></select>
          <label style="margin-top:10px">Secondary Sales Rep</label>
          <select id="rep2"></select>
          <div class="divider"></div>
          <label>Referral Partner</label>
          <select id="refPartner"><option>None</option><option>AT&T</option><option>Verizon</option><option>T-Mobile</option><option>Other</option></select>
        </section>

        <section class="three">
          <h3>Carrier / Activation</h3>
          <label>Carrier Rep Name</label><input id="carrierRepName" placeholder="First Last" />
          <label style="margin-top:10px">Carrier Rep Email</label><input id="carrierRepEmail" type="email" placeholder="rep@carrier.com" />
          <label style="margin-top:10px">Internal Activation CUC Rep</label><input id="cucRep" placeholder="Name / Team" />
        </section>

        <section class="two">
          <h3>Billing Info</h3>
          <label>Company Name</label><input id="billCompany" />
          <div class="row"><div><label>Contact Name</label><input id="billContact" /></div><div><label>Contact Phone</label><input id="billPhone" /></div></div>
          <label>Email</label><input id="billEmail" type="email" />
          <div class="row"><div><label>Street Address</label><input id="billStreet" /></div><div><label>Floor / Suite</label><input id="billSuite" /></div></div>
          <div class="row"><div><label>City</label><input id="billCity" /></div><div><label>State</label><input id="billState" /></div><div><label>Zip Code</label><input id="billZip" /></div></div>
        </section>

        <section class="two">
          <h3>Payment & Tax</h3>
          <select id="payMethod">
  <option value="">Select Payment Methodâ€¦</option>
  <option>ACH</option>
  <option>Bill.com</option>
  <option>BOBO Verizon</option>
  <option>Check</option>
  <option>ConnectUs Leasing</option>
  <option>Credit Card</option>
  <option>DaaS</option>
  <option>Financing Partner</option>
  <option>PayPal</option>
  <option>Wire Transfer</option>
</select>

<!-- Conditional: only when Payment Method = BOBO Verizon -->
<div id="boboBlock" style="display:none; margin-top:8px">
  <label>BOBO Acct #</label>
  <input id="boboAcct" placeholder="Enter BOBO account number" />
</div>

          <label style="margin-top:10px">Payment Terms Procedure</label><input id="payTerms" placeholder="e.g., Net 30, upfront %" />
          <label class="chip" style="margin-top:10px"><input type="checkbox" id="hasAgreement"> Purchase Agreement (no POs)</label>
          <label class="chip" style="margin-top:6px"><input type="checkbox" id="taxExempt"> Tax Exempt? (attach certificate)</label>
        </section>
      </div>
    </section>

    <!-- SHIPPING -->
    <section class="card" data-panel="shipping" style="display:none">
      <div class="grid">
        <section class="two">
          <h3>Shipping Info <label class="chip" style="margin-left:6px"><input type="checkbox" id="resShip"> Residence</label></h3>
          <label>Company Name / Care Of</label><input id="shipCompany" />
          <div class="row"><div><label>Contact Name</label><input id="shipContact" /></div><div><label>Contact Phone</label><input id="shipPhone" /></div></div>
          <label>Email</label><input id="shipEmail" type="email" />
          <div class="row"><div><label>Street Address</label><input id="shipStreet" /></div><div><label>Floor / Suite</label><input id="shipSuite" /></div></div>
          <div class="row"><div><label>City</label><input id="shipCity" /></div><div><label>State</label><input id="shipState" /></div><div><label>Zip Code</label><input id="shipZip" /></div></div>
          <div class="row"><div><label>Customer Requested Ship Date</label><input id="reqShipDate" type="date" /></div></div>
        </section>

        <section class="three">
          <h3>Shipping Options</h3>

<!-- NEW: Carrier method -->
<label>Ship Method</label>
<select id="shipMethod"></select>
<label>Shipping Payment Method</label>
<select id="shipPayMethod">
  <option value="">Select Shipping Payment Method</option>
  <option>Bill to ConnectUs UPS Account</option>
  <option>Bill to ConnectUs FedEx Account</option>
  <option>Bill to ConnectUs FedEx Account and Charge Cust.</option>
  <option>Bill to ConnectUs UPS Account and Charge Cust</option>
  <option>Customer UPS Account</option>
  <option>Customer FedEx Account</option>
  <option>Customer Provided Label</option>
  <option>N/A</option>
</select>



<!-- NEW: Only visible when 3rd Party is chosen -->
<div id="thirdPartyBlock" style="display:none; margin-top:8px">
  <label id="thirdPartyLabel">Account #</label>
  <input id="thirdPartyAcct" placeholder="Enter account number" />
  <div class="tiny">Shown only for 3rd Party billing; label adapts to chosen carrier.</div>
</div>
<label style="margin-top:10px">Freight Type</label>
<select id="freightType">
  <option value="">Select Freight Type</option>
  <option>[TPB] Third Party Billing, to the account number supplied below</option>
  <option>N/A</option>
</select>

<!-- Tech Zone requirement (new) -->
<div style="margin-top:10px">
  <label class="chip"><input type="checkbox" id="techZoneReq"> Tech Zone Required</label>
</div>


<div style="margin-top:10px">
  <label class="chip"><input type="checkbox" id="allowPartial"> Allow Partial Ship</label>
  <label class="chip" style="margin-left:10px"><input type="checkbox" id="blindShip"> Blind Ship</label>
</div>
  


</section>

        <section class="full">
          <h3>Internal Notes</h3>
          <textarea id="notes" rows="4" placeholder="Any Tech Zone scope, PS details, or routing notes"></textarea>
        </section>
      </div>
    </section>

    <!-- ITEMS -->
    <section class="card" data-panel="items" style="display:none">
      <h3>Items</h3>
      <div class="grid">
        <section class="three">
          <label>Quote Request ID (Sales â†’ Purchasing)</label>
          <div class="row"><input id="qrid" placeholder="e.g., QR-2025-00123" /><button class="ghost" id="btnLoadQR">Load by ID</button></div>
          <div class="tiny">Enter a QR ID to prefill the line. Subtabs appear for Accessory, Insurance, SIM/Pairing, and Licenses.</div>
        </section>
        <section class="full" id="itemsCard">
          <div class="row" style="gap:10px;margin-bottom:6px"><button onclick="addRow()">+ Add Line</button><button class="ghost" onclick="autoExample()">Load Example</button></div>
          <div class="table-wrap" style="overflow:auto;margin-top:8px">
            <table class="table" id="itemsTbl"><thead><tr>
              <th>Description (Mfg / Model / Size / Color)</th>
<th>OrderTime SKU</th>
<th>Qty</th>
<th>Sell Price</th>
<th>Line Instruction</th>
<th>Model / Part #</th>
<th>Color</th>
<th>LTE / Wi-Fi / Both</th>
<th>Carrier</th>
<th>Act Payout $</th>
<th>MSRP</th>
<th>Disc %</th>
<th>New / CPO</th>
<th>In Stock?</th>
<th>Vendor</th>
<th>Quoted Cost</th>
<th>DLL / SPA Price / Deal Reg #</th>
<th>Hold/Reservation #</th>
<th>Delivery Lead Time</th>
<th>EOL Confirm</th>
<th>Remove</th>

            </tr></thead><tbody id="itemsBody"></tbody></table>
          </div>

          <!-- Subtabs -->
          <div id="subtabsArea" class="subtabs" style="display:none">
  <button class="subtab active" data-sub="sim">SIM / Pairing</button>
  <button class="subtab" data-sub="insurance">Insurance</button>
  <button class="subtab" data-sub="licenses">Licenses</button>
  <!-- NEW: visible only when needed -->
  <button class="subtab" data-sub="newdevice" id="tabNewDevice" style="display:none">New Device Details</button>
</div>



          <!-- Subtab panels -->
          <div id="subtabPanels" style="margin-top:8px;display:none">
            <!-- Accessory -->
            <div data-subpanel="accessory">
              <div class="grid">
                <section class="three">
                  <label>Accessory SKU</label><input id="accSku" />
                  <label style="margin-top:8px">Accessory Description</label><input id="accDesc" />
                  <label class="chip" style="margin-top:10px"><input type="checkbox" id="bcInclude"> Include Brick + Cable kit</label>
                </section>
                <section class="three">
                  <label>Accessory Qty (per unit)</label><input id="accQty" type="number" min="0" value="0" />
                  <label style="margin-top:8px">Accessory Sell Price</label><input id="accSell" type="number" step="0.01" />
                </section>
              </div>
            </div>

    

            <!-- Insurance -->
            <div data-subpanel="insurance" style="display:none">
              <div class="grid">
                <section class="three">
                  <label>Insurance Plan</label>
                  <select id="insPlan">
                  <option>None</option>
                  <option>AKKO</option>
                  </select>
                  <label style="margin-top:8px">Deductible</label><select id="insDed"><option>$0</option><option>$50</option><option>$100</option></select>
                </section>
                <section class="three">
                  <label>Coverage Length</label><select id="insTerm"><option>0 year</option><option>1 year</option><option>2 year</option><option>3 year</option></select>
                  <label style="margin-top:8px">Insurance Sell Price</label><input id="insSell" type="number" step="0.01" />
                </section>
              </div>
            </div>

            <!-- SIM / Pairing -->
<div data-subpanel="sim">
  <div class="grid">
    <section class="three">
      <label>SIM Card</label>
      <select id="simCard"></select>

      <label style="margin-top:8px">Pairing Option</label>
      <select id="pairingOption"></select>
    </section>
    <section class="three">
      <label>SIM Handling</label>
      <select id="simHandling"></select>
    </section>
  </div>
</div>


            <!-- Licenses -->
            <div data-subpanel="licenses" style="display:none">
              <div class="grid">
                <section class="three">
                  <label>License Vendor</label><input id="licVendor" />
                  <label style="margin-top:8px">License Duration</label><input id="licDuration" placeholder="e.g., 1 year, 3 years" />
                  <label style="margin-top:8px">Prorated Price</label><input id="licProrated" type="number" step="0.01" />
                </section>
                <section class="three">
                  <label>License Key / Simba Code</label><input id="licKey" />
                  <label style="margin-top:8px">New SKU Contact</label><input id="licContact" placeholder="Name / email" />
                </section>
              </div>
            </div>
          </div>

          <!-- NEW: New Device Details (shown when any SKU ends with 00) -->
<div data-subpanel="newdevice" id="panelNewDevice" style="display:none">
  <div class="grid">
    <section class="three">
      <label>Vendor* (Must enter Vendor for New Devices)</label>
      <input id="ndVendor" placeholder="e.g., Ingram" />

      <label style="margin-top:8px">SPA PRICE / DEAL REGISTRATION #</label>
      <input id="ndDealReg" placeholder="e.g., DR-12345 or SPA $310" />

      <label style="margin-top:8px">Deal registration expiration date</label>
      <input id="ndDealExp" type="date" />
      
      <label style="margin-top:8px">Vendor Hold # / Reservation #</label>
      <input id="ndHoldNo" placeholder="e.g., RES-9981" />

      <label style="margin-top:8px">End of life date*</label>
      <input id="ndEOL" type="date" />

      <label style="margin-top:8px">Confirm availability of stock for the SO qty*</label>
      <select id="ndStockOK">
        <option value="">Select</option>
        <option>Yes</option>
        <option>No</option>
      </select>

      <div id="ndLeadWrap" style="display:none; margin-top:8px">
        <label>If No â€” enter lead time date</label>
        <input id="ndLeadDate" type="date" />
      </div>

      <label style="margin-top:8px">Expected Ship By Date*</label>
      <input id="ndExpShipBy" type="date" />
    </section>

    <section class="three">
      <label>Quantity Required</label>
      <input id="ndQtyRequired" type="number" min="0" />

      <label style="margin-top:8px">Same Shipping Address</label>
      <select id="ndSameShip">
        <option value="">Select</option>
        <option>Yes</option>
        <option>No</option>
      </select>

      <div id="ndAltShipWrap" style="display:none; margin-top:8px">
        <label>Alternate Shipping Address</label>
        <textarea id="ndAltShip" rows="6" placeholder="Company / Contact / Phone / Email
Street / Suite
City, State ZIP"></textarea>
      </div>

      <label style="margin-top:8px">Services Stay The Same</label>
      <select id="ndSvcSame">
        <option value="">Select</option>
        <option>Yes</option>
        <option>No</option>
      </select>

      <div id="ndSvcWrap" style="display:none; margin-top:8px">
        <label>If No â€” enter new / additional services SKU</label>
        <input id="ndSvcSKU" placeholder="e.g., Proservices_Tier2" />
      </div>
    </section>
  </div>
  <div class="tiny" style="margin-top:8px">
    This panel appears when any lineâ€™s OrderTime SKU ends with <strong>00</strong> (new-device workflow).
  </div>
</div>

          
          <!-- Totals -->
          <div class="totals" id="totalsBox" style="display:none">
            <h4>Totals (current document)</h4>
            <div class="rowline"><span>Lines Subtotal</span><strong id="tLines">$0.00</strong></div>
            <div class="rowline"><span>Accessories</span><strong id="tAcc">$0.00</strong></div>
            <div class="rowline"><span>Services</span><strong id="tSvc">$0.00</strong></div>
            <div class="rowline"><span>Insurance</span><strong id="tIns">$0.00</strong></div>
            <div class="rowline"><span>Tax</span><strong id="tTax">$0.00</strong></div>
            <div class="divider"></div>
            <div class="rowline"><span><strong>Grand Total</strong></span><strong id="tGrand">$0.00</strong></div>
            <div class="tiny" id="taxNote"></div>
          </div>
        </section>
      </div>
    </section>

    <!-- MDM -->
    <section class="card" data-panel="mdm" style="display:none">
      <div class="grid">
        <section class="three">
          <h3>MDM & Pro Services</h3>
          <label class="chip"><input type="checkbox" id="carrierSPF"> Carrier SPF Subsidy</label>
          <label style="margin-top:8px">Business Internet Plan Code</label><input id="planCode" />
          <label class="chip" style="margin-top:8px"><input type="checkbox" id="subsidyNote"> Include Subsidy Verbiage</label>
        </section>
        <section class="three">
          <h3 style="visibility:hidden">.</h3>
          <label class="chip"><input type="checkbox" id="mdmABM"> ABM (Apple Business Manager)</label>
          <label class="chip" style="margin-top:6px"><input type="checkbox" id="mdmKnox"> Samsung Knox (KME)</label>
          <label style="margin-top:8px">Knox Account #</label><input id="knoxAccount" />
          <label class="chip" style="margin-top:8px"><input type="checkbox" id="mdmZeroTouch"> Android Zero Touch Enrollment</label>
        </section>
        <!-- ðŸ” MOVED HERE from Items: Services (same IDs preserved) -->
<section class="full">
  <h3>Pro Services (per device)</h3>
  <div class="grid">
    <section class="three">
      <label class="chip"><input type="checkbox" id="svcEnabled"> Include Services for this item</label>
      <label style="margin-top:10px">Tier</label>
      <select id="svcTier">
        <option value="0">N/A</option>
        <option value="0">Tier 0 (under ~5 min)</option>
        <option value="1">Tier 1 (â‰¤ 15 min)</option>
        <option value="2">Tier 2 (â‰¤ 30 min)</option>
        <option value="3">Tier 3 (â‰¤ 45 min)</option>
        <option value="4">Tier 4 (â‰¤ 60 min)</option>
      </select>
      <label style="margin-top:10px">SKU</label>
      <input id="svcSKU" readonly />
    </section>
    <section class="three">
      <label>Minutes (per device)</label>
      <input id="svcMinutes" type="number" min="1" value="5" />
      <label style="margin-top:10px">Cost per device ($0.80/min)</label>
      <input id="svcCostPer" type="number" step="0.01" readonly />
      <label style="margin-top:10px">Total Services Cost</label>
      <input id="svcCostTotal" type="number" step="0.01" readonly />
    </section>
  </div>
  <div class="tiny">Tier 0 defaults to 5 minutes. Tiers 1â€“4 auto-set minutes = tier Ã— 15.</div>
</section>

        <section class="full">
          <label class="chip"><input type="checkbox" id="mdmPro"> MDM Pro-Services</label>
          <label style="margin-top:8px">MDM Notes / Description</label><textarea id="mdmNotes" rows="4"></textarea>
        </section>
        <section class="full">
          <div class="row" style="gap:10px">
            <button class="ok" onclick="buildSummary()">Generate Summary</button>
            <button class="ghost" onclick="copySummary()">Copy Summary</button>
            <button class="warn" onclick="validateForm()">Quick Validate</button>
            <button class="bad" onclick="clearAll()">Clear Form</button>
          </div>
          <div id="summary" class="summary-box" style="margin-top:12px"></div>
        </section>
      </div>
    </section>
  </section>
</div>

<!-- ===== DRAWERS ===== -->

<!-- WCP helper -->
<aside class="drawer" id="drawerWCP" aria-label="WCP Drawer">
  <header><strong>Current Customer â€” OrderTime Search</strong><button class="ghost" onclick="closeDrawer('drawerWCP')">Close</button></header>
  <div class="content">
    <label class="tiny">Search in OrderTime (opens in a new tab)</label>
    <div class="row"><input id="wcpQuery" placeholder="Type company nameâ€¦" /><button onclick="openOTSearch()" class="ghost">Search</button></div>
    <div id="wcpResults" class="tiny" style="margin-top:8px"></div>
    <div class="divider"></div>
    <div class="tiny">After selecting the customer in OrderTime, paste the exported details below (JSON or key:value). Supports billing, shipping, payment, shipping options.</div>
    <textarea id="wcpPaste" rows="10" style="width:100%;margin-top:8px" placeholder='{
  "company":"Acme Corp",
  "billing":{"contact":"John","phone":"555-1111","email":"billing@acme.com","street":"1 Main","suite":"Ste 100","city":"Phila","state":"PA","zip":"19104"},
  "shipping":{"company":"Acme WH","contact":"Jane","phone":"555-2222","email":"wh@acme.com","street":"500 Dock","suite":"","city":"Phila","state":"PA","zip":"19112"},
  "payment":{"method":"Net Terms","terms":"Net 30","taxExempt":true,"agreement":false},
  "shippingOptions":{"pay":"Prepaid","speed":"Ground","shortShip":"No"},
  "carrierRep":{"name":"Verizon Rep","email":"vrep@vz.com"},
  "rep":{"primary":"Chris Samaras","secondary":"â€”"}
}'></textarea>
    <div class="row" style="gap:10px;margin-top:8px"><button class="ok" onclick="applyPastedCustomer('wcpPaste')">Apply to Form</button><button class="ghost" onclick="fillWCPExample()">Load Example</button></div>
  </div>
</aside>

<!-- Clone Existing Order -->
<aside class="drawer" id="drawerClone" aria-label="Clone Sales Order Drawer">
  <header>
    <strong>Clone Existing Order â€” OrderTime</strong>
    <button class="ghost" onclick="closeDrawer('drawerClone')">Close</button>
  </header>
  <!-- In-App Sales Order Search -->
<div class="card" style="margin-bottom:12px">
  <h3>Find Existing Sales Orders</h3>
  <div class="row">
    <input id="soSearchInput" placeholder="Search by SO #, customer, or statusâ€¦" />
    <button class="ghost" id="btnSoSearch">Search</button>
  </div>
  <div id="soSearchResults" class="tiny" style="margin-top:8px"></div>
</div>
    
    <div class="tiny">
      After selecting a Sales Order in OrderTime, paste the exported details below (JSON).
      Supports <em>customer</em>, <em>shipping</em>, <em>payment</em>, <em>shippingOptions</em>,
      <em>items</em> (array), and <em>mdm</em>.
    </div>

    <textarea id="clonePaste" rows="12" style="width:100%;margin-top:8px" placeholder='{
  "so":"SO-2025-00456",
  "customer":{
    "company":"Acme Corp",
    "billing":{"contact":"John","phone":"555-1111","email":"john@acme.com","street":"1 Main","suite":"Ste 100","city":"Philadelphia","state":"PA","zip":"19104"}
  },
  "shipping":{
    "company":"Acme Warehouse",
    "contact":"Jane","phone":"555-2222","email":"wh@acme.com",
    "street":"500 Dock Rd","suite":"","city":"Philadelphia","state":"PA","zip":"19112",
    "residence":false
  },
  "payment":{"method":"Net Terms","terms":"Net 30","taxExempt":true,"agreement":false},
  "shippingOptions":{"pay":"Prepaid","speed":"Ground","shortShip":"No"},
  "items":[
    {
      "desc":"Apple iPad 10.2\" 128GB â€” Silver", "model":"MK2K3LL/A", "color":"Silver", "sku":"IPAD10-128-SLV",
      "qty":25, "net":"LTE", "carrier":"AT&T", "payout":50, "msrp":429.99, "disc":10, "sell":386.99,
      "cond":"New", "stock":"Yes", "vendor":"Ingram", "cost":330.00,
      "deal":"DLL-$310 / DR-12345", "hold":"RES-9981", "leadtime":"2-3 wks", "eol":"No",
      "accessory":{"sku":"CASE-IPAD10-RUG","desc":"Rugged Case","qty":1,"sell":29.99},
      "insurance":{"plan":"AKKO","ded":"$100","term":"2 year","sell":69.00},
      "services":{"enabled":true,"tier":1},
      "sim":{"card":"AT-SIM3IN1","pairing":"SIM PAIR ONLY","handling":"Install SIM Card"},
      "lic":{"vendor":"Jamf","duration":"1 year","prorated":"12.00","key":"SIMBA-ABC123","contact":"licenses@vendor.com"}
    }
  ],
  "mdm":{"carrierSPF":false,"planCode":"","subsidyNote":false,"abm":true,"knox":false,"knoxAccount":"","zeroTouch":true,"pro":true,"notes":"Clone from SO"}
}'></textarea>

    <div class="row" style="gap:10px;margin-top:8px">
      <button class="ok" onclick="applyClonedOrder()">Apply to Form</button>
      <button class="ghost" onclick="fillCloneExample()">Load Example</button>
    </div>
  </div>
</aside>

<!-- NEW Customer invite -->
<!-- NEW Customer invite -->
<aside class="drawer" id="drawerNew" aria-label="New Customer Drawer">
  <header><strong>NEW Customer â€” SSP Invite</strong><button class="ghost" onclick="closeDrawer('drawerNew')">Close</button></header>
  <div class="content">
    <label>Customer Email To:</label><input id="sspTo" type="email" placeholder="customer@email.com" />
    <label style="margin-top:8px">Subject</label><input id="sspSubject" />
    <label style="margin-top:8px">Body</label><textarea id="sspBody" rows="12"></textarea>

    <div class="row" style="gap:10px;margin-top:8px">
      <button class="ok" onclick="copySSP()">Copy to Clipboard</button>
      <button class="ghost" onclick="composeSSP()">Open Mail Client</button>
      <!-- âœ¨ Add this new Gmail button -->
      <button type="button" class="ok" onclick="composeSSPInGmail()">Open in Gmail</button>
    </div>

    <div class="tiny">Primary Rep & Billing Contact should be set. Template auto-fills from the rep database.</div>
  </div>
</aside>


<!-- Email OM with CSV -->
<aside class="drawer" id="drawerEmail" aria-label="Email OM Drawer">
  <header><strong>Email Order Management â€” CSV Summary</strong><button class="ghost" onclick="closeDrawer('drawerEmail')">Close</button></header>
  <div class="content">
    <label>To</label>
    <input id="emailTo" type="email" value="service@connectuscorp.com" />
    <label style="margin-top:8px">Subject</label>
    <input id="emailSubject" value="New Intake â€” CSV Summary" />

    <div class="divider"></div>
    <label>CSV Preview (included in email body)</label>
    <textarea id="csvPreview" rows="14" style="width:100%;font-family:ui-monospace,Consolas,monospace"></textarea>

    <div class="row" style="gap:10px;margin-top:12px">
  <button class="ok" onclick="copyCSVToClipboard()">Copy CSV</button>
  <button class="ghost" onclick="downloadHeaderCSVFile()">Download Sales Order Header (CSV)</button>
  <button class="ghost" onclick="downloadLineCSVFile()">Download Sales Order Line (CSV)</button>
  <button type="button" class="ok" onclick="openGmailWithCSV()">Open in Gmail (CSV in body)</button>

</div>

    <div class="tiny" style="margin-top:8px">
      Or use a direct mailto link:
      <a id="mailtoHref" href="#" target="_blank" rel="noopener">Open in default mail app</a>
    </div>
  </div>
</aside>

<script>
    // ---------- Gmail compose helpers ----------
function openGmailWithCSV() {
  const { ok, missing } = validateRequiredForEmail();
  if (!ok){ showValidationWarning(missing); return; }

  const toRaw   = document.getElementById('emailTo')?.value || 'service@connectuscorp.com';
  const subjRaw = document.getElementById('emailSubject')?.value || 'New Intake â€” CSV Summary';
  const csv     = document.getElementById('csvPreview')?.value || buildCSV();
  const oiText  = getSelText('oiType') || 'Standard Order';

  const header = `Hello Order Management,\n\nPlease find the intake details below in CSV format.\n\n`;
  const footer = `\n\nâ€” ConnectUS Intake`;
  const body   = `${header}${csv}${footer}`;

  openGmailCompose({ to: toRaw, subject: subjRaw, body });
}

/* ===== Small helpers ===== */
function isMissingSelectOrEmpty(el){
  if (!el) return true;
  const raw  = (el.value || '').trim();
  const text = (el.options && el.selectedIndex >= 0) ? (el.options[el.selectedIndex].text || '').trim() : '';
  return !raw || /^select/i.test(text);
}
function markErr(id){ const el = document.getElementById(id); if (el) el.classList.add('error'); }
function clearErr(id){ const el = document.getElementById(id); if (el) el.classList.remove('error'); }
function statusBox(){ const b = document.getElementById('submitStatus'); if (b) b.innerHTML=''; return b; }

function validateRequiredForEmail(){
  const miss = [];

  // Clear previous error highlights
  [
    'shipPayMethod','shipMethod','freightType','reqShipDate',
    'simCard','pairingOption','simHandling','insPlan',
    'payMethod','billCompany','shipCompany'
  ].forEach(clearErr);
  clearErr('itemsCard');

  const checkSel = (id, label)=>{
    const el = document.getElementById(id);
    if (isMissingSelectOrEmpty(el)){ miss.push(label); markErr(id); }
  };

  const checkText = (id, label)=>{
    const el = document.getElementById(id);
    const val = (el?.value || '').trim();
    if (!val){ miss.push(label); markErr(id); }
  };

  // Shipping-related required selects
  checkSel('shipPayMethod','Shipping Payment Method');
  checkSel('shipMethod','Ship Method');
  checkSel('freightType','Freight Type');

  // Dates
  const rqd = document.getElementById('reqShipDate');
  if (!rqd || !(rqd.value||'').trim()){
    miss.push('Customer Requested Ship Date');
    markErr('reqShipDate');
  }

  // SIM / Insurance
  checkSel('simCard','SIM Card');
  checkSel('pairingOption','Pairing Option');
  checkSel('simHandling','SIM Handling');
  checkSel('insPlan','Insurance Plan');

  // NEW: core billing & payment fields required
  checkSel('payMethod','Payment Method');
  checkText('billCompany','Billing Company Name');
  checkText('shipCompany','Shipping Company / Care Of');

  // Items: at least one valid line with SKU + Sell Price
  const body = document.getElementById('itemsBody');
  let anyValidLine = false;
  if (body){
    [...body.querySelectorAll('tr')].forEach((tr, idx)=>{
      const skuEl   = tr.querySelector('[data-key="sku"]');
      const priceEl = tr.querySelector('[data-key="price"], [data-key="sell"]') ||
                      tr.querySelectorAll('td')[11]?.querySelector('input,textarea,select');
      const sku   = (skuEl?.value || '').trim();
      const price = (priceEl?.value || '').trim();
      const rowHasAnyInput = [...tr.querySelectorAll('input,select,textarea')]
        .some(i => (i.value||'').trim());
      const inPlay = rowHasAnyInput || sku || price;

      const errs = [];
      if (inPlay && !sku){ errs.push('OrderTime SKU'); skuEl && skuEl.classList.add('error'); }
      if (inPlay && !price){ errs.push('Sell Price'); priceEl && priceEl.classList.add('error'); }
      if (errs.length) miss.push(`Line ${idx+1}: ${errs.join(', ')}`);
      if (sku && price) anyValidLine = true;
    });
  }
  if (!anyValidLine){
    miss.push('At least one line with OrderTime SKU and Sell Price');
    markErr('itemsCard');
  }

  return { ok: miss.length === 0, missing: miss };
}


function showValidationWarning(missing){
  const box = statusBox();
  const html = `
    <div class="warnbox">
      <strong>Complete these before emailing Order Management:</strong>
      <ul style="margin:6px 0 0 18px">${missing.map(m=>`<li>${m}</li>`).join('')}</ul>
    </div>`;
  if (box) box.innerHTML = html; else alert(`Please complete:\n- ${missing.join('\n- ')}`);
}

// Keep your Quick Validate button useful
window.validateForm = function(){
  const { ok, missing } = validateRequiredForEmail();
  const box = statusBox();
  if (ok){ if (box) box.innerHTML = '<span class="tiny" style="color:var(--ok)">All required fields look good.</span>'; }
  else { showValidationWarning(missing); }
};
  

// ---- Helper: map current wizard doc type to ERP TranType code
function getDocTypeCode() {
  // radios in Step 3 (Document Type): QUOTE / SALES ORDER / CLONE (clone still resolves to a base type)
  const picked = (document.querySelector('input[name="wizDocType"]:checked')?.value || '').toUpperCase();
  // ERP mapping per your email: Quote=13, Sales Order=7
  if (picked === 'QUOTE') return 13;
  if (picked === 'SALES ORDER') return 7;
  // For CLONE, infer base from currently selected chipâ€”fallback to Sales Order
  return 7;
}

// ---- Helper: get current DocNo (optional UX field; safe if absent)
function getDocNo() {
  // If you add an input for DocNo, support any of these IDs
  const ids = ['docNo', 'soDocNo', 'quoteDocNo'];
  for (const id of ids) {
    const v = document.getElementById(id)?.value?.trim();
    if (v) return v;
  }
  // If cloning, maybe stored on a hidden field from the JSON paste (optional: add if you wish)
  const cloneVal = window.__cloneDocNo;
  if (cloneVal) return String(cloneVal).trim();
  return ''; // blank is acceptable for header import if your ERP assigns numbers server-side
}

// ---- Helper: preferred Customer (Billing Company)
function getCustomerName() {
  return (document.getElementById('billCompany')?.value || '').trim();
}

// ---- Helper: Customer PO (optional field; safe if absent)
function getCustomerPO() {
  const ids = ['custPO', 'customerPO', 'poNumber', 'po'];
  for (const id of ids) {
    const v = document.getElementById(id)?.value?.trim();
    if (v) return v;
  }
  return '';
}

// ---- CSV + DocNo helpers (NEW) --------------------------------------------

// Seed a temporary DocNo (numeric) if the page doesn't already provide one.
// Stays constant for the session so Header + Lines share the same DocNo.
function __genDocNo() {
  return String(Date.now()); // 13-digit time-based numeric string
}
function getOrSeedDocNo() {
  const existing = (typeof getDocNo === 'function' ? getDocNo() : '')?.trim();
  if (existing) return existing;
  if (!window.__tempDocNo) window.__tempDocNo = __genDocNo();
  return window.__tempDocNo;
}

// CSV field escaper (kept same semantics you already use)
function csvEscape(v) {
  const s = (v ?? '').toString();
  if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
  return s;
}

// ---------------------------------------------------------------------------

/* ===== Small helpers ===== */
function val(id){ return (document.getElementById(id)?.value || '').trim(); }
function bool(id){ return !!document.getElementById(id)?.checked; }
function getSelText(id){
  const el = document.getElementById(id);
  if(!el) return '';
  const i = el.selectedIndex;
  return i >= 0 ? (el.options[i].text || '').trim() : '';
}

/* ===== Payment: BOBO Verizon toggle ===== */
function updateBoboUI(){
  const pm = (document.getElementById('payMethod')?.value || '').toLowerCase();
  document.getElementById('boboBlock').style.display = (pm === 'bobo verizon') ? '' : 'none';
}

/* ===== Shipping: show/hide 3rd-party account + label ===== */
function updateThirdPartyUI(){
  const sel   = document.getElementById('shipPayMethod');
  const val   = (sel && sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].text : '').trim();
  const block = document.getElementById('thirdPartyBlock');
  const label = document.getElementById('thirdPartyLabel');
  const input = document.getElementById('thirdPartyAcct');

  const lower = (val || '').toLowerCase();
  const isUPS   = lower.includes('ups');
  const isFedEx = lower.includes('fedex');

  // Show the block for ANY UPS/FedEx selection (Customer or ConnectUs-billed variants)
  const needsAcct = isUPS || isFedEx;
  block.style.display = needsAcct ? '' : 'none';

  // Label + placeholder reflect grouping
  if (label){
    if (isUPS)       label.textContent = 'UPS Account #';
    else if (isFedEx) label.textContent = 'FedEx Account #';
    else             label.textContent = 'Account #';
  }
  if (input){
    if (isUPS)       input.placeholder = 'Enter UPS account number';
    else if (isFedEx) input.placeholder = 'Enter FedEx account number';
    else             input.placeholder = 'Enter account number';
  }

  // --- Auto-fill for ConnectUS-billed methods (prefix match) ---
  // Matches both the base option and the "... and Charge Cust" variants.
  const startsWith = (s, prefix) => s.startsWith(prefix.toLowerCase());
  const isConnectUsUPS   = startsWith(lower, 'bill to connectus ups account');
  const isConnectUsFedEx = startsWith(lower, 'bill to connectus fedex account');

  // Respect manual edits: only overwrite if empty OR previously auto-filled
  const wasAuto = input?.dataset?.autofill === 'true';
  const isEmpty = !input?.value?.trim();

  if (needsAcct) {
    if (isConnectUsUPS && (isEmpty || wasAuto)) {
      input.value = CONNECTUS_UPS_ACCT;
      input.dataset.autofill = 'true';
    } else if (isConnectUsFedEx && (isEmpty || wasAuto)) {
      input.value = CONNECTUS_FEDEX_ACCT;
      input.dataset.autofill = 'true';
    } else if (!isConnectUsUPS && !isConnectUsFedEx && wasAuto) {
      // Switching away from ConnectUS-billed: clear previous auto-fill
      input.value = '';
      input.dataset.autofill = 'false';
    }
  } else if (wasAuto) {
    // Hide path: clear auto-filled value to avoid stale data
    input.value = '';
    input.dataset.autofill = 'false';
  }
}


// ===== Ship Method catalog (from your screenshots) =====
const SHIP_METHOD_OPTIONS = [
  '3PL KOP',
  'CUSTOMER PICKING UP AT WAREHOUSE',
  'Customer Provided Label or TRUCK/LTL (SEE ROUTING GUIDE) - RTG',
  'FedEx 2 Day - FED2',
  'FedEx Express Saver (Three Day) - FEES',
  'FedEx First Overnight 8:30AM - FED0',
  'FedEx Ground Delivery - RPSC',
  'FedEx Ground Home Delivery - RPHD',
  'FedEx International Economy - FIES',
  'FedEx International Priority - FIPS',
  'FedEx OneRate 2-day',
  'FedEx Priority Overnight - FED1',
  'FedEx Priority Overnight P1 Saturday - FEDS',
  'FreeEconomy Econ US Dom',
  'N/A',
  'NextDay Next US D2D Dom',
  'SecondDay Second US D2D Dom',
  'Standard Std US D2D Dom',
  'UPS 2nd Day Air A.M. - UPA2',
  'UPS 2nd Day Air - UPA2',
  'UPS 3 Day (Commercial) - UPS3',
  'UPS Canada Standard - UPCG',
  'UPS Ground (Commercial) - UPSC',
  'UPS Ground (Residential) - UPSR',
  'UPS Next Day Air - UPS1',
  'UPS Next Day Air Early A.M. - UPSE',
  'UPS Next Day Air Saver - UPSA',
  'USPS 1st Class Large Envelope (Machine Processable) - PP1E',
  'USPS First-class Mail - PP1',
  'USPS Priority Express Mail (1-Day) - PPA',
  'USPS Priority Mail (3-Day) - PPPR',
  'USPSParcel'
];



// Try to get a field by data-key, else fallback by column index
function _getCellInput(tr, key, fallbackColIdx){
  let el = tr.querySelector(`[data-key="${key}"]`);
  if (el) return el;
  if (typeof fallbackColIdx === 'number'){
    const td = tr.querySelectorAll('td')[fallbackColIdx];
    if (td) el = td.querySelector('input,textarea,select');
  }
  return el || null;
}

function findDeclineRow(){
  const body = document.getElementById('itemsBody');
  if (!body) return null;
  return [...body.querySelectorAll('tr')].find(tr => tr.dataset.decline === 'true') || null;
}



function createDeclineRow(){
  const body = document.getElementById('itemsBody');
  if (!body) return null;
  if (typeof window.addRow === 'function') addRow();
  const tr = [...body.querySelectorAll('tr')].slice(-1)[0] || null;
  if (tr) tr.dataset.decline = 'true';
  return tr;
}


function upsertDeclineInsuranceLine(){
  let tr = findDeclineRow();
  if (!tr){
    tr = createDeclineRow();
    if (!tr) return;
  }
  const descEl  = _getCellInput(tr, 'desc', 0);
  const skuEl   = _getCellInput(tr, 'sku', 1);
  const priceEl = _getCellInput(tr, 'price', 3) || _getCellInput(tr, 'sell', 11);

  if (descEl)  descEl.value  = DECLINE_DESC;
  if (skuEl)   skuEl.value   = DECLINE_SKU;
  if (priceEl) priceEl.value = DECLINE_PRICE;

  tr.dataset.decline = 'true';
}


function removeDeclineInsuranceLine(){
  const tr = findDeclineRow();
  if (!tr) return;
  tr.parentElement?.removeChild(tr); // remove the dedicated decline row entirely
}


// Do NOT auto-insert anything for insurance.
// Only remove any legacy "decline of protection" lines if present.
function onInsurancePlanChange(){
  purgeDeclineRows();
}

 
function populateShipMethod(){
  const sel = document.getElementById('shipMethod');
  if (!sel) return;
  sel.innerHTML = '';
  const ph = document.createElement('option');
  ph.value = ''; ph.textContent = 'Select Ship Method';
  sel.appendChild(ph);
  SHIP_METHOD_OPTIONS.forEach(txt => {
    const o = document.createElement('option');
    o.textContent = txt;
    sel.appendChild(o);
  });
}
function initMainTabs(){
  const tabs = document.querySelectorAll('.mtab');
  const panels = document.querySelectorAll('[data-mainpanel]');
  if (!tabs.length || !panels.length) return;

  function activate(name){
    // buttons
    tabs.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.main === name);
    });
    // panels
    panels.forEach(p => {
      p.classList.toggle('active', p.getAttribute('data-mainpanel') === name);
    });
  }

  tabs.forEach(btn => {
    btn.addEventListener('click', () => activate(btn.dataset.main));
  });

  // keep current selection (uses the button with .active, defaults to "reps")
  const current = document.querySelector('.mtab.active')?.dataset?.main || 'reps';
  activate(current);
}



/* ===== Wire up events on load ===== */
window.addEventListener('DOMContentLoaded', () => {
  const pm = document.getElementById('payMethod');
  if (pm) { pm.addEventListener('change', updateBoboUI); updateBoboUI(); }

  const spm = document.getElementById('shipPayMethod');
  if (spm) spm.addEventListener('change', updateThirdPartyUI);
  updateThirdPartyUI();
    // If user types in the account field, stop future auto-overwrites
  const tpInput = document.getElementById('thirdPartyAcct');
  if (tpInput) {
    tpInput.addEventListener('input', () => { tpInput.dataset.autofill = 'false'; });
  }

  // Populate the new Ship Method list
  populateShipMethod();

  // Enable main tabs (Sales Reps â†” Intake)
  initMainTabs();
  const insSel = document.getElementById('insPlan');
if (insSel){
  insSel.addEventListener('change', onInsurancePlanChange);
}
// Always purge any legacy decline rows on boot
purgeDeclineRows();

    // Reveal wizard Step 5 once Step 4 (Scope) has a selection
  const scopeRadios = document.querySelectorAll('input[name="wizScope"]');
  if (scopeRadios && scopeRadios.length){
    scopeRadios.forEach(r => r.addEventListener('change', () => {
      const s5 = document.getElementById('wizStep4');
      if (s5) s5.style.display = '';
    }));
  }


});
  




  
// ---- Build Header CSV: DocNo,Customer,CustomerPO,TranType,Ship To,Is New
// Requirements:
// - Ship To = "Primary"
// - Is New = "TRUE"
// - TranType: Quote=13, Sales Order=7 (getDocTypeCode should map this)
// - DocNo shared with Lines via getOrSeedDocNo()
function buildHeaderCSV() {
  // Columns (now includes Ship Method and Internal Notes)
  const headers = [
    'DocNo','Customer','CustomerPO','TranType','Ship To','Is New','Customer Requested Ship Date',
    'Terms','Payment Method','BOBO Acct #','Ship Method','Freight Type','Shipping Payment Method','FedEx Account #','UPS Account #',
    'Allow Partial Ship','Blind Ship','Primary Sales Rep','Secondary Sales Rep','Carrier Rep','Carrier Rep Email','Carrier Rep Phone',
    'Company Name / Care Of','Contact Name','Contact Phone','Email','Street Address','Floor / Suite','City','State','Zip Code',
    'Internal Notes','Order Instruction Type'
  ];

  const get = (id)=> (document.getElementById(id)?.value || '').trim();
  const checked = (id)=> !!document.getElementById(id)?.checked;

  const docNo   = getOrSeedDocNo();
  const cust    = getCustomerName();
  const po      = getCustomerPO();
  const tran    = getDocTypeCode();

  const reqDate    = get('reqShipDate');
  const terms      = get('payTerms');
  const payMeth    = get('payMethod');
  const bobo       = (String(payMeth).toLowerCase() === 'bobo verizon') ? get('boboAcct') : '';
  const shipMethod = getSelText('shipMethod');
  const otShip     = getSelText('shipPayMethod'); // exact OT string

  // Third-party account routing (UPS/FedEx keyword)
    // Third-party account routing (UPS/FedEx keyword)
  let fedexAcct = '', upsAcct = '';
  const acct = get('thirdPartyAcct');
  const selLower = (otShip || '').toLowerCase();
  if (selLower.includes('ups'))   upsAcct = acct;
  if (selLower.includes('fedex')) fedexAcct = acct;

  // If only one carrier account is present, set the other to "N/A" for clarity in the header export
  if (fedexAcct && !upsAcct) upsAcct = 'N/A';
  else if (upsAcct && !fedexAcct) fedexAcct = 'N/A';
  // (If both are blank or both are filled, leave as-is)


  const freight      = get('freightType');
  const allowPartial = checked('allowPartial') ? 'TRUE' : 'FALSE';
  const blindShip    = checked('blindShip') ? 'TRUE' : 'FALSE';

  const rep1      = getSelText('rep1');
  const rep2      = getSelText('rep2');
  const crep      = get('carrierRepName');
  const crepEmail = get('carrierRepEmail');
  const crepPhone = get('carrierRepPhone');

  // Ship-to
  const shipCompany = get('shipCompany');
  const shipContact = get('shipContact');
  const shipPhone   = get('shipPhone');
  const shipEmail   = get('shipEmail');
  const shipAddr1   = get('shipStreet');
  const shipAddr2   = get('shipSuite');
  const shipCity    = get('shipCity');
  const shipState   = get('shipState');
  const shipZip     = get('shipZip');

  // Internal Notes
  const notesVal = (document.getElementById('notes')?.value || '').trim();
  const oiType = getSelText('oiType');


  const row = [
    docNo, cust, po, tran,
    'Primary', 'TRUE', reqDate,
    terms, payMeth, bobo, shipMethod, freight, otShip, fedexAcct, upsAcct,
    allowPartial, blindShip, rep1, rep2, crep, crepEmail, crepPhone,
    shipCompany, shipContact, shipPhone, shipEmail, shipAddr1, shipAddr2, shipCity, shipState, shipZip,
    notesVal, getSelText('oiType')
  ];

  return headers.join(',') + '\n' + row.map(csvEscape).join(',');
}






// ---- Build Lines CSV to match required template:
// No.,Customer,Item,ItemType,Line Instructions,Quantity,Price,Tran Type
function buildLineCSV() {
  const docNo    = getOrSeedDocNo();
  const tranType = (typeof getDocTypeCode === 'function' ? getDocTypeCode() : '').toString();
  const customer = (typeof getCustomerName === 'function' ? getCustomerName() : '').trim();
  const body     = document.getElementById('itemsBody');

  // Keep your existing helper
  const getField = (tr, key, sel = 'input') =>
    (tr.querySelector(`td ${sel}[data-key="${key}"]`)?.value || '').toString().trim();

  // Column indexes (from the table header)
  if (typeof window.COL_DESC === 'undefined') window.COL_DESC = 0;
if (typeof window.COL_SKU  === 'undefined') window.COL_SKU  = 1;
const COL_PAYOUT = (typeof window.COL_PAYOUT !== 'undefined') ? window.COL_PAYOUT : 9;  // "Act Payout $" col
const COL_SELL   = (typeof window.COL_SELL   !== 'undefined') ? window.COL_SELL   : 3;  // "Sell Price" col


  // Robust getters for payout & price
  function getPayout(tr) {
    // Try data-key first
    let v = getField(tr, 'payout');
    if (v) return v;
    // Fallback by column index
    const el = tr?.querySelectorAll('td')[COL_PAYOUT]?.querySelector('input,textarea,select');
    return (el?.value || '').toString().trim();
  }

  function getSellPrice(tr) {
    // Preferred: data-key="price"
    let v = getField(tr, 'price');
    if (v) return v;
    // Fallback: data-key="sell"
    v = getField(tr, 'sell');
    if (v) return v;
    // Fallback: by column index (Sell Price column)
    const el = tr?.querySelectorAll('td')[COL_SELL]?.querySelector('input,textarea,select');
    return (el?.value || '').toString().trim();
  }

  const rows = [];
  if (body) {
    [...body.querySelectorAll('tr')].forEach(tr => {
      const sku      = getField(tr, 'sku');                    // Item
      const qty      = getField(tr, 'qty');                    // Quantity
      const instr    = getField(tr, 'lineInstr');              // Line Instruction
      let   itemType = getField(tr, 'itemType', 'select');     // ItemType
      if (!itemType) itemType = 'Part';
      if (!sku) return; // skip incomplete rows

      const price     = getSellPrice(tr);                      // ðŸ‘ˆ robust Sell Price â†’ Price
      const actPayout = getPayout(tr);                         // ðŸ‘ˆ Act Payout $

      rows.push([
        '',                  // id
        docNo,               // No.
        customer,            // Customer
        sku,                 // Item
        itemType || 'Part',  // ItemType
        instr,               // Line Instruction
        qty,                 // Quantity
        price,               // Price (Sell Price)
        actPayout,           // ðŸ‘ˆ Act Payout $
        tranType             // Tran Type
      ]);
    });
  }

  const headers = ['id','No.','Customer','Item','ItemType','Line Instruction','Quantity','Price','Act Payout $','Tran Type']; // ðŸ‘ˆ NEW header
  const lines = rows.map(r => r.map(csvEscape).join(',')).join('\n');
  return headers.join(',') + '\n' + lines;
}





/* ==== New-Device CSV (row-scoped, line-per-line) ==== */

// Produce a CSV row for each line that qualifies (SKU ends with 00 AND NOT a license line)
const ND_CSV_HEADERS = [
  'Line#',
  'OrderTime SKU',
  'Vendor*',
  'SPA/Deal Reg #',
  'Deal Reg Expiration',
  'Vendor Hold/Reservation #',
  'End of Life Date*',
  'Stock Available for SO Qty*',
  'Lead Time Date (if No)',
  'Expected Ship By Date*',
  'Quantity Required',
  'Same Shipping Address',
  'Alternate Shipping Address (if No)',
  'Services Stay The Same',
  'New/Additional Services SKU (if No)'
];

if (typeof getRowSku !== 'function') {
  function getRowSku(tr){
    const tds  = tr?.querySelectorAll('td') || [];
    const el   = tds[window.COL_SKU]?.querySelector('input,textarea,select');
    return (el?.value || '').trim();
  }
}
if (typeof getNdData !== 'function') {
  function getNdData(tr){
    try { return JSON.parse(tr?.dataset?.nd || '{}'); } catch { return {}; }
  }
}


function buildNewDeviceCSV(){
  const body = document.getElementById('itemsBody');
  if (!body) return '';

  // Gather qualifying rows (license rows do NOT qualify)
  const rows = [...body.querySelectorAll('tr')].filter(tr => rowQualifiesNewDevice(tr));
  if (!rows.length) return '';

  // Read current panel values (they reflect the "current" row), but we persist per-row in dataset
  let csv = ND_CSV_HEADERS.join(',') + '\n';
  rows.forEach((tr, i)=>{
    const data = getNdData(tr);
    const sku  = getRowSku(tr);
    const lineNo = i + 1;

    const row = [
      lineNo,
      sku,
      data.ndVendor || '',
      data.ndDealReg || '',
      data.ndDealExp || '',
      data.ndHoldNo || '',
      data.ndEOL || '',
      data.ndStockOK || '',
      (data.ndStockOK === 'No' ? (data.ndLeadDate || '') : ''),
      data.ndExpShipBy || '',
      data.ndQtyRequired || '',
      data.ndSameShip || '',
      (data.ndSameShip === 'No' ? (data.ndAltShip || '') : ''),
      data.ndSvcSame || '',
      (data.ndSvcSame === 'No' ? (data.ndSvcSKU || '') : '')
    ];

    csv += row.map(csvEscape).join(',') + '\n';
  });

  return csv.trimEnd();
}


/* ==== Combined CSV for preview + Gmail body ==== */
function buildCSV(){
  const parts = [];
  // Header CSV
  parts.push('=== Sales Order Header ===\n' + buildHeaderCSV());
  // Lines CSV
  parts.push('=== Sales Order Lines ===\n' + buildLineCSV());
  // New Device CSV (conditional)
  const ndCsv = buildNewDeviceCSV();
  if (ndCsv) parts.push('=== New Device Details ===\n' + ndCsv);
  return parts.join('\n\n');
}
 
// ---- Download helpers
function downloadBlobCSV(filename, csvText) {
  const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
}


function downloadHeaderCSVFile() {
  const csv   = buildHeaderCSV();
  const docNo = getOrSeedDocNo();
  const name  = `sales-order-header_${docNo}.csv`;
  downloadBlobCSV(name, csv);
}


function downloadLineCSVFile() {
  const csv   = buildLineCSV();
  const docNo = getOrSeedDocNo();
  const name  = `sales-order-lines_${docNo}.csv`;
  downloadBlobCSV(name, csv);
}




// Reliable mailto opener
function openMailto(url){
  const a = document.createElement('a');
  a.href = url;
  a.style.display = 'none';
  a.setAttribute('target', '_self'); // ensure same window
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* ===== CONFIG ===== */
// Browser never talks to OrderTime directly. Use same-origin proxy.
const API_BASE = '/api';
const TAX_RATE = 0.08;
const RATE_PER_MIN = 0.80;
const SSP_INVITE_SUBJECT = "Set up your ConnectUS Self-Service Portal (SSP)";

// ConnectUS carrier accounts for auto-fill
const CONNECTUS_UPS_ACCT   = '5116V0';
const CONNECTUS_FEDEX_ACCT = '407700201';

async function api(path, { method='GET', headers={}, body } = {}){
  const res = await fetch(`${API_BASE}${path}`, {
    method,
    headers: { 'Content-Type':'application/json', ...headers },
    credentials: 'include',
    body: body ? JSON.stringify(body) : undefined
  });
  if(!res.ok){
    const text = await res.text().catch(()=> '');
    throw new Error(`API ${method} ${path} failed: ${res.status} ${text}`);
  }
  const ct = res.headers.get('content-type') || '';
  return ct.includes('application/json') ? res.json() : res.text();
}




/* ===== SIM / Pairing option catalogs ===== */
// Seeded from your template screenshot. Add/adjust as needed.
const SIM_CARD_OPTIONS = [
  'VZ-SIM3IN1',
  'AT-SIM3IN1',
  'AT-FIRSTSIMA00',
  'TM-SIM3IN14G',
  'HE-HELIXTRIAA00',
  'Helix eSIM(TriA)',
  'HE TRI-B Static IP Helix',
  'MW-SIMVZTMATT-E',
  'US-SIM3IN15G',
  'eSIM Embendded in the phone',
  'NO SIM CARD',
];
 // Exact mapping from visible SIM dropdown option to OrderTime SKU + Description
const SIM_CARD_SKU_MAP = {
  'VZ-SIM3IN1': {
    sku: 'VZ-SIM3IN1',
    desc: '3IN1 Verizon Locked 5G SIM Card (Black)',
    price: '0'

  },
  'AT-SIM3IN1': {
    sku: 'AT-SIM3IN1',
    desc: '3 in 1 AT&T SIM Card',
    price: '0'
  },
  'AT-FIRSTSIMA00': {
    sku: 'AT-FIRSTSIMA00',
    desc: '3 in 1 FirstNet AT&T Locked 5G SIM Card (Black)',
    price: '0'
  },
  'TM-SIM3IN14G': {
    sku: 'TM-SIM3IN14G',
    desc: '3 in 1 T-Mobile Locked 4G SIM Card',
    price: '0'
  },
  'HE-HELIXTRIAA00': {
    sku: 'HE-HELIXTRIAA00',
    desc: 'Helix Wireless Tri A SIM Card',
    price: '0'
  },
  'Helix eSIM(TriA)': {
    sku: 'HE-eSIM-TRIA',
    desc: 'Helix Wireless eSIM (TriA)',
    price: '0'
  },
  'HE TRI-B Static IP Helix': {
    sku: 'HE-0007SFFB00',
    desc: 'Helix Wireless SIM Card TRI-B for Static IP (EID required)',
    price: '0'
  },
  'MW-SIMVZTMATT-E': {
    sku: 'MW-SIMVZTMATT-E',
    desc: 'ConnectUs Dynamic IP Multi-Carrier Access 3in1 SIM Card â€“ VZ/ATT/TMO',
    price: '0'
  },
  'US-SIM3IN15G': {
    sku: 'US-SIM3IN15G',
    desc: '3 in 1 US Cellular Locked 5G SIM Card',
    price: '0'
  },
  'eSIM Embendded in the phone': {
    sku: 'ESIM-EMBED',
    desc: 'eSIM embedded in the phone',
    price: '0'
  },
  
};

// Set of SKUs we consider â€œSIM linesâ€ â€” used for delete/replace enforcement.
const SIM_SKUS = new Set(Object.values(SIM_CARD_SKU_MAP).map(v => v.sku));


// If your Word template has the full lists, add them here later.
const SIM_HANDLING_OPTIONS = [
  'Install SIM Card',
  'Tape SIM Card to Box',
  'Embedded SIM',
  'No Sim Card',
];

const PAIRING_OPTIONS = [
  'SIM PAIR ONLY',
  'SIM PAIR & CARRIER ACTIVATION',
  'SIM PAIR, BENCH TEST / ACTIVE TO ENSURE OPTIMAL PERFORMANCE',
  'VERIZON eSIM PAIRING',
  'SIM PAIR w/ STATIC IP & DEVICE ACTIVATION, BENCH TEST TO ENSURE OPTIMAL PERFORMANCE',
  'CUSTOM CONFIG DEVICE ACTIVATION, BENCH TEST TO ENSURE OPTIMAL PERFORMANCE / SOW REQUIRED',
  'INTERNAL CUC SIM PAIR & ACTIVATION',
  'N/A',
];


  // === Pairing â†’ SKU/Description mapping ===
const PAIRING_SKU_MAP = {
  // Map each pairing option text to an OrderTime SKU + Description.
  // Use the exact visible text options in your dropdown.
  'SIM PAIR ONLY': {
    sku: 'SIM PAIRING',
    desc: 'SIM PAIRING',
    price: '0'
  },
  'SIM PAIR & CARRIER ACTIVATION': {
    sku: 'DEVICE ACTIVATION & SIM PAIR',
    desc: 'SIM PAIRING & DEVICE ACTIVATION, BENCH TEST TO ENSURE OPTIMAL PERFORMANCE',
    price: '0'
  },
  'VERIZON eSIM PAIRING': {
    sku: 'VERIZON eSIM PAIRING',
    desc: 'VERIZON eSIM PAIRING â€” Please send IMEI listing to Verizon Rep to activate eSIM',
    price: '0'
  },
  'SIM PAIR, BENCH TEST / ACTIVE TO ENSURE OPTIMAL PERFORMANCE': {
    sku: 'CUSTCONFIG, DEV ACTIV&SIMPAIR',
    desc: 'SIM PAIRING, DEVICE ACTIVATION, & CUSTOM CONFIGURATION SERVICES, BENCH TEST TO ENSURE OPTIMAL PERFORMANCE/SOW REQUIRED',
    price: '0'
  },
  'SIM PAIR w/ STATIC IP & DEVICE ACTIVATIO< BENCH TEST TO ENSURE OPTIOMAL PERFORMANCE': {
    sku: 'STATIC IP SIMPAIR+DEVICE ACTIV',
    desc: 'SIM PAIRING & DEVICE ACTIVATION, BENCH TEST TO ENSURE OPTIMAL PERFORMANCE W/ STATIC IP',
    price: '0'
  },
  'iNTERNAL cuc SIM PAIR & ACTIVATION': {
    sku: 'INT DEVICE ACTIVATE/SIM PAIR',
    desc: 'NON-CARRIER SIM PAIRING & DEVICE ACTIVATION',
    price: '0'
  }
  // Add more mappings here as you add more pairing options/SKUs.
  
};

  // A lowercase set of all pairing SKUs so we can identify & remove them
const PAIRING_SKUS = new Set(Object.values(PAIRING_SKU_MAP).map(x => String(x.sku || '').toLowerCase()));
// === Column safeguards (align with your table header) ===
if (typeof window.COL_DESC === 'undefined') window.COL_DESC = 0;
if (typeof window.COL_SKU  === 'undefined') window.COL_SKU  = 1;
if (typeof window.COL_price  === 'undefined') window.COL_price  = 2;
// ===== Row-scoped "New Device Details" with License override =====

// Read inputs from a row
function getTdInput(tr, colIdx){
  return tr?.querySelectorAll('td')[colIdx]?.querySelector('input,textarea,select') || null;
}
function getRowSku(tr){ return (getTdInput(tr, window.COL_SKU)?.value || '').trim(); }
function getRowDesc(tr){ return (getTdInput(tr, window.COL_DESC)?.value || '').trim(); }
function isLicenseDesc(desc){ return /license/i.test(String(desc || '')); }

// Qualifier for this row:
// - SKU ends with "00"  â†’ candidate â€œNewâ€
// - EXCLUDE if Description contains "license"
// - EXCLUDE if Description contains "sim" or "card"
// - EXCLUDE if Description contains "AKKO"
// - EXCLUDE if SKU starts with "AO" (insurance SKUs)
function rowQualifiesNewDevice(tr){
  if (!tr) return false;

  const skuRaw = String(getRowSku(tr) || '');
  const sku    = skuRaw.trim().toLowerCase();
  const desc   = String(getRowDesc(tr) || '');

  // License rows go to the Licenses subtab (handled elsewhere)
  const isLic       = isLicenseDesc(desc);

  // ND-specific exclusions
  const isSimOrCard = /\b(sim|sim card|card)\b/i.test(desc);
  const isAkkoText  = /akko/i.test(desc);
  const isAoSku     = /^ao\b/.test(sku); // case-safe "AO", with or without hyphen

  return sku.endsWith('00') && !isLic && !isSimOrCard && !isAkkoText && !isAoSku;
}




// Per-row data storage for ND panel, persisted on the <tr>
function getNdData(tr){ try { return JSON.parse(tr.dataset.nd || '{}'); } catch { return {}; } }
function setNdData(tr, obj){ tr.dataset.nd = JSON.stringify(obj || {}); }

// Track the "current" row that the ND panel is editing
let __currentRow = null;
function setCurrentRow(tr){
  __currentRow = tr;

  // Optional highlight
  document.querySelectorAll('#itemsBody tr').forEach(r => r.classList.remove('nd-current'));
  tr?.classList.add('nd-current');

  // Decide which subtab to activate for this row
  const desc = getRowDesc(tr);
  if (isLicenseDesc(desc)) {
    activateSubtab('licenses'); // license rows go to Licenses subtab
  } else if (rowQualifiesNewDevice(tr)) {
    ensureNewDeviceTabVisibility();
    activateSubtab('newdevice');
    loadNdPanelFromRow(tr);
  }
  // keep Insurance subtab fields in sync with the selected row
if (typeof syncSubtabFromRow === 'function') syncSubtabFromRow(tr);

}

// ND panel fields we persist per-row
const ND_IDS = [
  'ndVendor','ndDealReg','ndDealExp','ndHoldNo','ndEOL','ndStockOK',
  'ndLeadDate','ndExpShipBy','ndQtyRequired','ndSameShip','ndAltShip',
  'ndSvcSame','ndSvcSKU'
];

function readVal(id){ return (document.getElementById(id)?.value || '').trim(); }
function setVal(id, v){
  const el = document.getElementById(id);
  if (el) { el.value = v ?? ''; el.dispatchEvent(new Event('input', {bubbles:true})); }
}

function loadNdPanelFromRow(tr){
  const data = getNdData(tr);
  ND_IDS.forEach(k => setVal(k, data[k] ?? ''));
  toggleNdDependents();
}
function saveNdPanelToRow(){
  if (!__currentRow) return;
  const data = {};
  ND_IDS.forEach(k => data[k] = readVal(k));
  setNdData(__currentRow, data);
}

// ---- Licenses tab visibility: only show when row Description contains "license"
function toggleLicensesTabForRow(tr){
  const isLic = isLicenseDesc(getRowDesc(tr));
  const licTab   = document.querySelector('#subtabsArea .subtab[data-sub="licenses"]');
  const licPanel = document.querySelector('#subtabPanels [data-subpanel="licenses"]');

  if (licTab)   licTab.style.display   = isLic ? '' : 'none';
  if (licPanel) licPanel.style.display = (isLic && licTab.classList.contains('active')) ? '' : 'none';

  if (isLic) {
    // Show Licenses subtab for this row
    activateSubtab('licenses');
  } else {
    // If Licenses was active and no longer applicable, fall back to New Device (if qualifies) else Accessory
    if (licTab && licTab.classList.contains('active')) {
      if (rowQualifiesNewDevice(tr)) activateSubtab('newdevice');
      else activateSubtab('accessory');
    }
  }
}

// Hide Licenses tab by default on load
(function initLicensesHidden(){
  const licTab = document.querySelector('#subtabsArea .subtab[data-sub="licenses"]');
  if (licTab) licTab.style.display = 'none';
})();

// Show the "New Device Details" tab only if ANY row qualifies (license rows do NOT qualify)
function anyRowQualifiesNewDevice(){
  const body = document.getElementById('itemsBody');
  if (!body) return false;
  for (const tr of body.querySelectorAll('tr')) {
    if (rowQualifiesNewDevice(tr)) return true;
  }
  return false;
}
function ensureNewDeviceTabVisibility(){
  const show = anyRowQualifiesNewDevice();
  const tab  = document.getElementById('tabNewDevice');
  const pane = document.getElementById('panelNewDevice');
  if (tab)  tab.style.display  = show ? '' : 'none';
  if (pane) pane.style.display = show ? '' : 'none';
}

// Hook row selection and SKU/Description edits
(function hookRowScope(){
  const body = document.getElementById('itemsBody');
  if (!body) return;

  // Click any row to make it "current" for the ND panel
  body.addEventListener('click', (e)=>{
    const tr = e.target.closest('tr');
    if (tr) setCurrentRow(tr);
    toggleLicensesTabForRow(tr);
  });

  // When SKU or Description changes, recompute visibility; for current row, sync panel/subtab
  body.addEventListener('input', (e)=>{
    const tr = e.target.closest('tr'); if (!tr) return;
    const td = e.target.closest('td'); if (!td) return;
    const idx = [...tr.children].indexOf(td);
    if (idx === window.COL_SKU || idx === window.COL_DESC) {
      ensureNewDeviceTabVisibility();
      if (__currentRow === tr) {
        if (isLicenseDesc(getRowDesc(tr))) {
          activateSubtab('licenses');
        } else if (rowQualifiesNewDevice(tr)) {
          activateSubtab('newdevice');
          loadNdPanelFromRow(tr);
        }
      }
    }
    toggleLicensesTabForRow(tr)
  });

  // Watch for newly added rows (addRow / clone)
  const mo = new MutationObserver(()=> ensureNewDeviceTabVisibility());
  mo.observe(body, { childList:true });
})();

// Persist ND panel edits back into the current rowâ€™s dataset
ND_IDS.forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('input', saveNdPanelToRow);
});

// Dependent ND UI (lead time, alt ship, services)
function toggleNdDependents(){
  const stockOK = readVal('ndStockOK');
  const sameShip = readVal('ndSameShip');
  const svcSame  = readVal('ndSvcSame');

  const leadWrap = document.getElementById('ndLeadWrap');
  if (leadWrap) leadWrap.style.display = (stockOK === 'No') ? '' : 'none';

  const altWrap = document.getElementById('ndAltShipWrap');
  if (altWrap) altWrap.style.display = (sameShip === 'No') ? '' : 'none';

  const svcWrap = document.getElementById('ndSvcWrap');
  if (svcWrap) svcWrap.style.display = (svcSame === 'No') ? '' : 'none';
}
['ndStockOK','ndSameShip','ndSvcSame'].forEach(id=>{
  const el = document.getElementById(id);
  if (el) el.addEventListener('change', ()=>{ toggleNdDependents(); saveNdPanelToRow(); });
});

// Generic subtab activator (uses your existing subtabs DOM)
function activateSubtab(key){
  const tabs = document.querySelectorAll('#subtabsArea .subtab');
  const panels = document.querySelectorAll('#subtabPanels [data-subpanel]');
  tabs.forEach(t => t.classList.toggle('active', t.getAttribute('data-sub') === key));
  panels.forEach(p => p.style.display = (p.getAttribute('data-subpanel') === key) ? '' : 'none');
}

  // Column index for "New / CPO" (0-based from your header)
if (typeof window.COL_COND === 'undefined') window.COL_COND = 11;

// Suffix rules:
// - ends with 00  -> "New"
// - ends with 10,20,29,31 -> "CPO"
const CPO_SUFFIXES = new Set(['10','20','29','31']);

function inferCondFromSku(skuRaw){
  const sku = String(skuRaw || '').trim();
  if (!sku) return null;
  const last2 = sku.slice(-2); // last two characters
  if (last2 === '00') return 'New';
  if (CPO_SUFFIXES.has(last2)) return 'CPO';
  return null; // no change
}

function applyCondForRow(tr){
  const tds = tr?.querySelectorAll('td');
  if (!tds || !tds.length) return;

  const skuEl  = tds[window.COL_SKU ]?.querySelector('input,textarea,select');
  const condEl = tds[window.COL_COND]?.querySelector('input,textarea,select');
  if (!skuEl || !condEl) return;

  const inferred = inferCondFromSku(skuEl.value);
  if (inferred) {
    condEl.value = inferred;
    condEl.dispatchEvent(new Event('input', { bubbles: true }));
  }

  // Optional: keep the New Device Details tab in sync if you have UI toggling elsewhere
  if (typeof ensureNewDeviceTabVisibility === 'function') {
  ensureNewDeviceTabVisibility();
}

}

// 1) React when the SKU cell is edited
const itemsBody = document.getElementById('itemsBody');
if (itemsBody){
  itemsBody.addEventListener('input', (e)=>{
    const td = e.target.closest('td');
    if (!td) return;
    const tr = e.target.closest('tr');
    const idx = [...tr.children].indexOf(td);
    if (idx === window.COL_SKU) applyCondForRow(tr);
  });

  // 2) Also react when rows are added (from addRow/clone/etc.)
  const mo = new MutationObserver((muts)=>{
    for (const m of muts){
      m.addedNodes.forEach(n=>{
        if (n.nodeType === 1 && n.tagName === 'TR') applyCondForRow(n);
      });
    }
  });
  mo.observe(itemsBody, { childList:true });
}

// 3) One-time sweep in case SKUs already exist (e.g., after paste/clone/load)
(function initialSweep(){
  document.querySelectorAll('#itemsBody tr').forEach(applyCondForRow);
})();

/* ================== ROW-SCOPED INSURANCE (Deductible + Sell) ================== */
/* Features:
   - Adds 2 UI fields to each item row (Ins Deductible, Ins Sell $/device) without shifting your existing column indexes.
   - Keeps Insurance subtab (#insPlan, #insDed, #insSell) in 2-way sync with the current row.
   - If Plan = "None" -> add/update ONE linked decline line (SKU: CUSTOMER DECLINE OF PROTECTION).
   - If Plan = a catalog SKU -> add/update ONE linked insurance line using that SKU/Description.
   - Real-time totals: whenever row Ins Sell changes, we call refreshTotals() if present.
*/

/* ---------- Config ---------- */
const INS_DECLINE_SKU  = 'CUSTOMER DECLINE OF PROTECTION';
const INS_DECLINE_DESC = 'Customer has declined device protection/insurance';
const INS_DED_OPTS     = ['None', '$0', '$50', '$100']; // customize as needed
const INS_PLAN_NONE_VAL = '__NONE__';                   // value used in #insPlan

/* ---------- Utilities ---------- */
function callRefreshTotals() {
  if (typeof window.refreshTotals === 'function') {
    try { window.refreshTotals(); } catch {}
  }
}
function q$(sel, root=document) { return root.querySelector(sel); }
function qAll(sel, root=document) { return [...root.querySelectorAll(sel)]; }
function ensureEl(tag, attrs={}, text='') {
  const el = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) el.setAttribute(k, v);
  if (text) el.textContent = text;
  return el;
}

/* ---------- Add header columns at runtime (non-breaking) ---------- */
(function ensureInsuranceHeaderCols(){
  const headRow = q$('#itemsHead tr');
  if (!headRow) return;
  const hasInsCols = q$('#itemsHead th[data-ins-col="ded"]') || q$('#itemsHead th[data-ins-col="sell"]');
  if (hasInsCols) return;
  headRow.appendChild(ensureEl('th', {'data-ins-col':'ded'}, 'Ins Deductible'));
  headRow.appendChild(ensureEl('th', {'data-ins-col':'sell'}, 'Ins Sell $/device'));
})();

/* ---------- Ensure every row has Ins Deductible + Ins Sell cells ---------- */
function ensureInsuranceCellsForRow(tr){
  if (!tr || tr.dataset.insAugmented === '1') return;

  // Create cells
  const tdDed  = ensureEl('td');
  const tdSell = ensureEl('td');

  // Ins Deductible (select)
  const sel = ensureEl('select', {'data-role':'insDed'});
  INS_DED_OPTS.forEach(opt => sel.appendChild(ensureEl('option', {value:opt}, opt)));
  if (tr.dataset.insDed && INS_DED_OPTS.includes(tr.dataset.insDed)) sel.value = tr.dataset.insDed;

  // Ins Sell $/device (number)
  const inp = ensureEl('input', {'data-role':'insSell', 'type':'number', 'min':'0', 'step':'0.01', 'inputmode':'decimal', 'placeholder':'0.00'});
  if (tr.dataset.insSell) inp.value = tr.dataset.insSell;

  tdDed.appendChild(sel);
  tdSell.appendChild(inp);
  tr.appendChild(tdDed);
  tr.appendChild(tdSell);

  sel.addEventListener('change', ()=>{
    tr.dataset.insDed = sel.value;
    if (__currentRow === tr) {
      const tabDed = q$('#insDed'); if (tabDed) tabDed.value = sel.value;
    }
  });

  inp.addEventListener('input', ()=>{
    const v = (inp.value || '').trim();
    tr.dataset.insSell = v;
    if (__currentRow === tr) {
      const tabSell = q$('#insSell'); if (tabSell) { tabSell.value = v; tabSell.dispatchEvent(new Event('input', {bubbles:true})); }
    }
    callRefreshTotals();
  });

  tr.dataset.insAugmented = '1';
}

/* ---------- MutationObserver to auto-augment rows as theyâ€™re added ---------- */
(function watchItemRowsForInsuranceCols(){
  const body = q$('#itemsBody'); if (!body) return;
  qAll('tr', body).forEach(ensureInsuranceCellsForRow);
  const mo = new MutationObserver((muts)=>{
    muts.forEach(m=>{
      m.addedNodes.forEach(n=>{
        if (n.nodeType === 1 && n.tagName === 'TR') ensureInsuranceCellsForRow(n);
      });
      m.removedNodes.forEach(n=>{
        if (n.nodeType === 1 && n.tagName === 'TR') handleRowRemovalCleanup(n);
      });
    });
  });
  mo.observe(body, {childList:true});
})();

/* ---------- Link management: one linked line per base row (decline OR plan) ---------- */
function getRowSku(tr){
  const tds = tr.querySelectorAll('td');
  const el = tds[window.COL_SKU]?.querySelector('input,textarea,select');
  return (el?.value || '').trim();
}
function setRowSkuAndDesc(tr, sku, desc){
  const tds = tr.querySelectorAll('td');
  const skuEl  = tds[window.COL_SKU ]?.querySelector('input,textarea,select');
  const descEl = tds[window.COL_DESC]?.querySelector('input,textarea,select');
  if (skuEl)  { skuEl.value  = sku ?? '';  skuEl.dispatchEvent(new Event('input', {bubbles:true})); }
  if (descEl) { descEl.value = desc ?? ''; descEl.dispatchEvent(new Event('input', {bubbles:true})); }
}

function nextUid(){ return String(Date.now()) + Math.random().toString(16).slice(2); }

function ensureLinkedLineAfter(baseTr){
  const uid = baseTr.dataset.rowUid || (baseTr.dataset.rowUid = nextUid());
  let link = q$(`#itemsBody tr[data-linked-for-uid="${uid}"]`);
  if (link) return link;

  let newTr = null;
  if (typeof window.addRow === 'function') {
    const before = qAll('#itemsBody tr').length;
    try { window.addRow(); } catch {}
    const afterRows = qAll('#itemsBody tr');
    newTr = afterRows[afterRows.length - 1] || null;
  }
  if (!newTr) {
    const last = qAll('#itemsBody tr').at(-1);
    newTr = last ? last.cloneNode(true) : ensureEl('tr');
    if (!last) {
      const cols = (window.COL_COND || 11) + 2;
      for (let i=0;i<cols;i++) newTr.appendChild(ensureEl('td'));
    }
    qAll('input,textarea,select', newTr).forEach(el=>{
      if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = '';
    });
    baseTr.after(newTr);
  }

  newTr.dataset.linkedForUid = uid;
  newTr.dataset.isInsuranceLinked = '1';

  ensureInsuranceCellsForRow(newTr);
  return newTr;
}

function removeLinkedLine(baseTr){
  const uid = baseTr?.dataset?.rowUid;
  if (!uid) return;
  const link = q$(`#itemsBody tr[data-linked-for-uid="${uid}"]`);
  if (link && link.parentElement) link.parentElement.removeChild(link);
}

function handleRowRemovalCleanup(removedTr){
  if (removedTr.dataset && removedTr.dataset.rowUid) {
    const link = q$(`#itemsBody tr[data-linked-for-uid="${removedTr.dataset.rowUid}"]`);
    if (link && link.parentElement) link.parentElement.removeChild(link);
  }
  if (removedTr.dataset && removedTr.dataset.linkedForUid) {
    const base = q$(`#itemsBody tr[data-row-uid="${removedTr.dataset.linkedForUid}"]`);
    if (base) delete base.dataset.insLinkedRowUid;
  }
}

/* ---------- Catalog loader (CSV) + Plan dropdown population ---------- */
let INS_CATALOG = []; // [{sku, desc}]
async function loadInsuranceCatalogFromCSV(url){
  try {
    const res = await fetch(url, {cache:'no-cache'});
    const text = await res.text();
    const lines = text.split(/\r?\n/).filter(Boolean);
    INS_CATALOG = [];
    for (let i=0;i<lines.length;i++){
      const raw = lines[i].split(',');
      const sku = (raw[0] || '').trim();
      const desc = (raw[1] || '').trim();
      if (!sku || !desc) continue;
      INS_CATALOG.push({sku, desc});
    }
  } catch (e) {
    console.warn('Insurance CSV load failed, falling back to minimal options.', e);
    INS_CATALOG = [];
  }
}

function populateInsurancePlanDropdown(){
  const sel = q$('#insPlan'); if (!sel) return;
  const keep = sel.value;
  sel.innerHTML = '';

  // Always include "None"
  sel.appendChild(ensureEl('option', {value:INS_PLAN_NONE_VAL}, 'None'));

  // Prefer real AKKO from catalog if available; else add a safe fallback
  let akko = null;
  if (Array.isArray(INS_CATALOG) && INS_CATALOG.length){
    akko = INS_CATALOG.find(it => {
      const d = (it.desc || '').toLowerCase();
      const s = (it.sku  || '').toLowerCase();
      return d.includes('akko') || s.includes('akko');
    }) || null;
  }

  if (akko){
    const label = `${akko.desc} (${akko.sku})`;
    sel.appendChild(ensureEl('option', {
      value: akko.sku,
      'data-sku': akko.sku,
      'data-desc': akko.desc
    }, label));
  } else {
    // Fallback if CSV is missing or fetch failed
    sel.appendChild(ensureEl('option', {
      value: 'AKKO',
      'data-sku': 'AKKO',
      'data-desc': 'AKKO Insurance'
    }, 'AKKO'));
  }

  // Keep prior selection if still valid; otherwise default to None
  sel.value = (keep && [...sel.options].some(o => o.value === keep)) ? keep : INS_PLAN_NONE_VAL;
}



(async function initInsuranceCatalog(){
  // â›³ Update this path to where you host the CSV publicly in your app:
  await loadInsuranceCatalogFromCSV('/data/ItemAll_20250927193107.csv');
  populateInsurancePlanDropdown();
})();

/* ---------- Per-row <-> Insurance subtab 2-way sync ---------- */
function syncSubtabFromRow(tr){
  const planSel = q$('#insPlan');
  const tabDed  = q$('#insDed');
  const tabSell = q$('#insSell');
  if (!tr) return;

  const rowDed  = tr.dataset.insDed || 'None';
  const rowSell = tr.dataset.insSell || '';
  if (tabDed)  tabDed.value = rowDed;
  if (tabSell) { tabSell.value = rowSell; tabSell.dispatchEvent(new Event('input', {bubbles:true})); }

  const planSku = tr.dataset.insPlanSku || INS_PLAN_NONE_VAL;
  if (planSel) planSel.value = planSku;
}
function syncRowFromSubtab(tr){
  const planSel = q$('#insPlan');
  const tabDed  = q$('#insDed');
  const tabSell = q$('#insSell');
  if (!tr) return;

  const ded = tabDed ? tabDed.value : 'None';
  const sell = tabSell ? (tabSell.value || '').trim() : '';
  tr.dataset.insDed = ded;
  tr.dataset.insSell = sell;

  const rowDedSel  = tr.querySelector('select[data-role="insDed"]');  if (rowDedSel)  rowDedSel.value = ded;
  const rowSellInp = tr.querySelector('input[data-role="insSell"]');  if (rowSellInp) { rowSellInp.value = sell; rowSellInp.dispatchEvent(new Event('input', {bubbles:true})); }

  const sku = planSel ? (planSel.value || '') : INS_PLAN_NONE_VAL;
  tr.dataset.insPlanSku = sku;

  callRefreshTotals();
}

/* Hook into row selection: click row -> sync Insurance subtab */
(function hookRowSelectionForInsurance(){
  const body = q$('#itemsBody'); if (!body) return;
  body.addEventListener('click', (e)=>{
    const tr = e.target.closest('tr'); if (!tr) return;
    ensureInsuranceCellsForRow(tr);
    if (typeof setCurrentRow === 'function') {
      queueMicrotask(()=>{ syncSubtabFromRow(tr); });
    } else {
      __currentRow = tr;
      syncSubtabFromRow(tr);
    }
  });
})();

/* ---------- Plan change -> manage linked line (decline vs catalog) ---------- */
function ensureInsuranceLineForRow(baseTr){
  const planSel = q$('#insPlan');
  if (!baseTr || !planSel) return;

  const planVal = planSel.value || INS_PLAN_NONE_VAL;
    // When Insurance = None -> ensure a $0 "decline" line on the current row
  

  const skuEl   = baseTr.querySelector('[data-key="sku"]')   || baseTr.querySelectorAll('td')[3]?.querySelector('input,textarea,select');
  const descEl  = baseTr.querySelector('[data-key="desc"]')  || baseTr.querySelectorAll('td')[0]?.querySelector('input,textarea,select');
  const priceEl = baseTr.querySelector('[data-key="price"]') || baseTr.querySelector('[data-key="sell"]') || baseTr.querySelectorAll('td')[11]?.querySelector('input,textarea,select');

  if (String(planVal) === String(INS_PLAN_NONE_VAL)) {
    if (descEl)  descEl.value  = DECLINE_DESC;
    if (skuEl)   skuEl.value   = DECLINE_SKU;
    if (priceEl) priceEl.value = '0.00';
    baseTr.dataset.decline = 'true';
  } else {
    // If switching away from None and this row was a decline row, clear it
    if (baseTr.dataset.decline === 'true') {
      if (descEl)  descEl.value  = '';
      if (skuEl)   skuEl.value   = '';
      if (priceEl) priceEl.value = '';
      delete baseTr.dataset.decline;
    }
  }

  let sku = '', desc = '';
  if (planVal === INS_PLAN_NONE_VAL) {
    sku = INS_DECLINE_SKU;
    desc = INS_DECLINE_DESC;
  } else {
    const found = INS_CATALOG.find(x => x.sku === planVal);
    if (found) { sku = found.sku; desc = found.desc; }
    else { sku = planVal; desc = 'Insurance Plan'; }
  }

  const link = ensureLinkedLineAfter(baseTr);
  setRowSkuAndDesc(link, sku, desc);

  // (Optional) Zero out price on the linked line if you have a Sell Price column constant.

  baseTr.dataset.insLinkedRowUid = link.dataset.linkedForUid;
}

/* ---------- Subtab event hooks ---------- */
(function wireInsuranceSubtabEvents(){
  const elPlan = q$('#insPlan');
  const elDed  = q$('#insDed');
  const elSell = q$('#insSell');

  if (elPlan) elPlan.addEventListener('change', ()=>{
    if (!__currentRow) return;
    __currentRow.dataset.insPlanSku = elPlan.value || INS_PLAN_NONE_VAL;
    ensureInsuranceLineForRow(__currentRow);
  });

  if (elDed) elDed.addEventListener('change', ()=>{
    if (!__currentRow) return;
    syncRowFromSubtab(__currentRow);
  });

  if (elSell) elSell.addEventListener('input', ()=>{
    if (!__currentRow) return;
    syncRowFromSubtab(__currentRow);
  });
})();

// === Helper: add/update a line from Pairing selection ===
function addOrUpdatePairingLineFromSelect() {
  const sel = document.getElementById('pairingOption');
  if (!sel) return;

  const chosen = (sel.value || '').trim();
  const map = PAIRING_SKU_MAP[chosen];
  if (!map) return;

  const body = document.getElementById('itemsBody');
  if (!body) return;

  const desiredSkuL = String(map.sku || '').toLowerCase();
  const rows = [...body.querySelectorAll('tr')];

  // Find all existing "pairing" lines (any whose SKU is in PAIRING_SKUS)
  let pairingRows = [];

  rows.forEach(tr => {
    const skuEl = tr.querySelector('input[data-key="sku"]');
    const skuValL = String(skuEl?.value || '').trim().toLowerCase();
    if (PAIRING_SKUS.has(skuValL)) {
      pairingRows.push(tr);
    }
  });

  // If exactly one pairing row exists and it's already the desired SKU, do nothing
  if (pairingRows.length === 1) {
    const skuEl = pairingRows[0].querySelector('input[data-key="sku"]');
    const existingSkuL = String(skuEl?.value || '').trim().toLowerCase();
    if (existingSkuL === desiredSkuL) {
      return; // already the correct single line
    }
  }

  // Remove all existing pairing lines (enforce "only one" rule)
  pairingRows.forEach(tr => tr.remove());

  // Add a fresh line for the newly selected pairing option
  if (typeof addRow === 'function') {
    addRow();
  } else {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="autosize" data-key="desc" /></td>
      <td><input class="autosize" data-key="sku" /></td>
      <td><input class="autosize" data-key="qty" /></td>
      <td><input class="autosize" data-key="sell" /></td>
      <td><input class="autosize" data-key="lineInstr" /></td>
      <td><input class="autosize" /></td>
      <td><input class="autosize" /></td>
      <td><input class="autosize" /></td>
      <td><input class="autosize" /></td>
      <td><input class="autosize" /></td>
      <td><input class="autosize" /></td>
      <td><input class="autosize" /></td>
      <td><input class="autosize" /></td>
      <td><input class="autosize" /></td>
      <td><input class="autosize" /></td>
      <td><input class="autosize" /></td>
      <td><input class="autosize" /></td>
      <td><input class="autosize" /></td>
      <td><input class="autosize" /></td>
      <td><button class="bad" onclick="this.closest('tr').remove()">Remove</button></td>
    `;
    body.appendChild(tr);
  }

  // Populate the newly added pairing row from the map
  const newRow   = body.lastElementChild;
  if (!newRow) return;

  const descEl  = newRow.querySelector('input[data-key="desc"]');
  const skuEl   = newRow.querySelector('input[data-key="sku"]');
  const qtyEl   = newRow.querySelector('input[data-key="qty"]');
  const priceEl = newRow.querySelector('input[data-key="sell"]');

  if (descEl)  descEl.value  = map.desc || '';
  if (skuEl)   skuEl.value   = map.sku  || '';
  if (qtyEl && !qtyEl.value) qtyEl.value = '1';

  // Pairing line should always be $0 (or whatever you set in PAIRING_SKU_MAP)
  if (priceEl) priceEl.value = map.price ?? '0';

  [descEl, skuEl, qtyEl, priceEl].forEach(el => {
    if (el) el.dispatchEvent(new Event('input', { bubbles:true }));
  });
}

  
/* Build the three selects and keep prior values (if any) */
function populateSimDropdowns(){
  const map = [
    { id:'simCard',        opts: SIM_CARD_OPTIONS,        placeholder: 'Select SIM card' },
    { id:'pairingOption',  opts: PAIRING_OPTIONS,         placeholder: 'Select Pairing option' },
    { id:'simHandling',    opts: SIM_HANDLING_OPTIONS,    placeholder: 'Select SIM handling' }
  ];
  map.forEach(({id, opts, placeholder})=>{
    const sel = document.getElementById(id);
    if(!sel) return;

    // Preserve any pre-existing value (e.g., from QR load)
    const prev = (sel.value || '').trim();

    sel.innerHTML = '';
    const ph = document.createElement('option');
    ph.value = '';
    ph.textContent = placeholder;
    ph.disabled = false; ph.selected = !prev;
    sel.appendChild(ph);

    opts.forEach(v=>{
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v;
      sel.appendChild(o);
    });

    // If prior value matches a known option, select it
    if(prev){
      const match = [...sel.options].find(o => o.value === prev);
      if(match) sel.value = prev;
    }
  });
}

/* ===== Rep Database (localStorage-backed) ===== */
const LS_REPS_KEY = "CUC_REPS_V1";

const BASE_TEMPLATES = {
  "Lucas Currin": ` Hello {{ Customer First Name}}, 

We are excited to share that we have created a self service customer portal to make engaging with ConnectUs an easier and more seamless experience. 

From this portal you will be able to: 
View Order Statuses See order historyView Tracking InformationRetrieve IMEI & Sim Information (When applicable)Manage Billing & Shipping AddressesView & download invoicesAnd More! 

Click here to create your user name and password:  https://connectuscorp.com/my-account/?salep-rep=lucas-currin 

Your email will serve as the admin for this account. You can add additional users once you register. If you would like to change the admin email, please email me. 

This is only the beginning! In the not so distant future, you will be able to place orders directly  from the portal which will save you time and provide you information you need in real time. 

Our goal is to save you time and provide you the information you need on-demand. 

We welcome you to provide any feedback you would like to see for future improvements or features. We will continually strive to improve your interactions with ConnectUs to make doing business with us an enjoyable experience. 

Further instructions to follow once your account is created. 

If we can help in any way, please do not hesitate to reach out. 

Your business is greatly appreciated!

With Warmest Regards,
 Lucas Currin `,
  "Max Mann": ` Hello {{ Customer First Name}}, 

We are excited to share that we have created a self service customer portal to make engaging with ConnectUs an easier and more seamless experience. 

From this portal you will be able to: 
View Order Statuses See order historyView Tracking InformationRetrieve IMEI & Sim Information (When applicable)Manage Billing & Shipping AddressesView & download invoicesAnd More! 

Click here to create your user name and password:  https://connectuscorp.com/my-account/?salep-rep=max-mann 

Your email will serve as the admin for this account. You can add additional users once you register. If you would like to change the admin email, please email me. 

This is only the beginning! In the not so distant future, you will be able to place orders directly  from the portal which will save you time and provide you information you need in real time. 

Our goal is to save you time and provide you the information you need on-demand. 

We welcome you to provide any feedback you would like to see for future improvements or features. We will continually strive to improve your interactions with ConnectUs to make doing business with us an enjoyable experience. 

Further instructions to follow once your account is created. 

If we can help in any way, please do not hesitate to reach out. 

Your business is greatly appreciated!

With Warmest Regards,
Max Mann

 `,
  "John Tropeano": `  Hello {{ Customer First Name}}, 

We are excited to share that we have created a self service customer portal to make engaging with ConnectUs an easier and more seamless experience. 

From this portal you will be able to: 
View Order Statuses See order historyView Tracking InformationRetrieve IMEI & Sim Information (When applicable)Manage Billing & Shipping AddressesView & download invoicesAnd More! 

Click here to create your user name and password:  https://connectuscorp.com/my-account/?salep-rep=john-tropeano 

Your email will serve as the admin for this account. You can add additional users once you register. If you would like to change the admin email, please email me. 

This is only the beginning! In the not so distant future, you will be able to place orders directly  from the portal which will save you time and provide you information you need in real time. 

Our goal is to save you time and provide you the information you need on-demand. 

We welcome you to provide any feedback you would like to see for future improvements or features. We will continually strive to improve your interactions with ConnectUs to make doing business with us an enjoyable experience. 

Further instructions to follow once your account is created. 

If we can help in any way, please do not hesitate to reach out. 

Your business is greatly appreciated!

With Warmest Regards,
John Tropeano

 `
};

/* ===== Payment: BOBO Verizon toggle ===== */
function updateBoboUI(){
  const sel = document.getElementById('payMethod');
  const block = document.getElementById('boboBlock');
  if(!sel || !block) return;
  const val = (sel.value || '').toLowerCase();
  block.style.display = (val === 'bobo verizon') ? '' : 'none';
}

  
/* ===== Shipping: 3rd party toggle ===== */
function updateThirdPartyAccountUI(){
  const pay = document.getElementById('shipPay')?.value || '';
  const method = document.getElementById('shipMethod')?.value || '';
  const block = document.getElementById('thirdPartyBlock');
  const label = document.getElementById('thirdPartyLabel');
  if(!block || !label) return;

  const isThird = String(pay).toLowerCase() === '3rd party';
  block.style.display = isThird ? '' : 'none';

  if(isThird){
    // Label adapts to chosen carrier
    if(method === 'FedEx') label.textContent = 'FedEx Account #';
    else if(method === 'UPS') label.textContent = 'UPS Account #';
    else label.textContent = 'Carrier Account #';
  }
}

// Bind events once DOM is ready
window.addEventListener('DOMContentLoaded', () => {
  const payMethodSel = document.getElementById('payMethod');
  if (payMethodSel){ payMethodSel.addEventListener('change', updateBoboUI); updateBoboUI(); }
  const paySel = document.getElementById('shipPay');
  const methodSel = document.getElementById('shipMethod');
  if(paySel)   paySel.addEventListener('change', updateThirdPartyAccountUI);
  if(methodSel) methodSel.addEventListener('change', updateThirdPartyAccountUI);
  // init
  updateThirdPartyAccountUI();

  const pairingSel = document.getElementById('pairingOption');
  if (pairingSel) {
    pairingSel.addEventListener('change', addOrUpdatePairingLineFromSelect);
  }
  // SIM change â†’ add/replace SIM line item
const simSel = document.getElementById('simCard');
if (simSel) {
  simSel.addEventListener('change', addOrUpdateSimLineFromSelect);
}

  function addOrUpdateSimLineFromSelect() {
  const sel = document.getElementById('simCard');
  if (!sel) return;

  const chosen = (sel.value || '').trim();
  if (!chosen) return;

  const map = SIM_CARD_SKU_MAP[chosen];
  if (!map) return; // dropdown text must exactly match map key

  const body = document.getElementById('itemsBody');
  if (!body) return;

  // 1) remove any existing SIM line (enforce "only one")
  const rows = [...body.querySelectorAll('tr')];
  for (const tr of rows) {
    const skuEl = tr.cells?.[window.COL_SKU]?.querySelector('input,textarea,select');
    const sku = (skuEl?.value || '').trim();
    if (SIM_SKUS.has(sku)) tr.remove();
  }

  // 2) add a fresh row (use your addRow() if available)
  let tr;
  if (typeof addRow === 'function') {
    addRow();
    tr = body.lastElementChild;
  } else {
    tr = document.createElement('tr');
    const cellsNeeded = Math.max(window.COL_SKU + 1, 20);
    for (let i = 0; i < cellsNeeded; i++) {
      const td = document.createElement('td');
      const inp = document.createElement('input');
      inp.type = 'text';
      inp.className = 'autosize';
      td.appendChild(inp);
      tr.appendChild(td);
    }
    // add Remove button in last cell
    const td = document.createElement('td');
    td.innerHTML = `<button class="bad" onclick="this.closest('tr').remove()">Remove</button>`;
    tr.appendChild(td);
    body.appendChild(tr);
  }

  // 3) field-map desc + sku + qty=1
    // 3) field-map desc + sku + qty=1 + Sell Price = 0
  const descEl  = tr.querySelector('input[data-key="desc"]');
  const skuEl   = tr.querySelector('input[data-key="sku"]');
  const qtyEl   = tr.querySelector('input[data-key="qty"]');
  const priceEl = tr.querySelector('input[data-key="sell"]');

  if (descEl) descEl.value = map.desc;
  if (skuEl)  skuEl.value  = map.sku;

  // default to 1 if qty is blank
  if (qtyEl && !qtyEl.value) qtyEl.value = '1';

  // force SIM card lines to be $0 unless you change the map
  if (priceEl) priceEl.value = map.price ?? '0';

  [descEl, skuEl, qtyEl, priceEl].forEach(el => {
    if (el) el.dispatchEvent(new Event('input', { bubbles:true }));
  });

}

// Wire up on page load
document.addEventListener('DOMContentLoaded', () => {
  // ensure dropdowns are populated
  if (typeof populateSimDropdowns === 'function') populateSimDropdowns();

  // SIM change â†’ add/replace
  const simSel = document.getElementById('simCard');
  if (simSel) simSel.addEventListener('change', addOrUpdateSimLineFromSelect);

  // Pairing change â†’ existing pairing handler
  const pairingSel = document.getElementById('pairingOption');
  if (pairingSel) pairingSel.addEventListener('change', addOrUpdatePairingLineFromSelect);
});

});

  
function loadReps(){
  let reps = [];
  try{ reps = JSON.parse(localStorage.getItem(LS_REPS_KEY)||"[]"); }catch(_){}
  if(!reps || reps.length===0){
    // Seed with reps
    reps = [
      {name:"Lucas Currin", email:"lucas.currin@connectuscorp.com", slug:"lucas-currin", template:BASE_TEMPLATES["Lucas Currin"]},
      {name:"Max Mann", email:"max.mann@connectuscorp.com", slug:"max-mann", template:BASE_TEMPLATES["Max Mann"]},
      {name:"John Tropeano", email:"john.tropeano@connectuscorp.com", slug:"john-tropeano", template:BASE_TEMPLATES["John Tropeano"]},
      {name:"Greg Weichert", email:"greg.weichert@connectuscorp.com", slug:"Greg Weichert", template:BASE_TEMPLATES["Greg Weichert"]}
    ];
    localStorage.setItem(LS_REPS_KEY, JSON.stringify(reps));
  } 
  return reps;
}
function saveReps(reps){ localStorage.setItem(LS_REPS_KEY, JSON.stringify(reps||[])); }
function getReps(){ return loadReps(); }
function getRepByName(name){ return getReps().find(r=>r.name===name); }

/* ===== Main Tabs ===== */
document.querySelectorAll('.mtab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.mtab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('[data-mainpanel]').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    document.querySelector(`[data-mainpanel="${btn.dataset.main}"]`).classList.add('active');
    if(btn.dataset.main==='reps') renderRepList();
  });
});

/* ===== Intake Tabs + Stepper ===== */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('[data-panel]').forEach(p=>p.style.display='none');
    btn.classList.add('active');
    document.querySelector(`[data-panel="${btn.dataset.tab}"]`).style.display='';
    document.querySelectorAll('#stepper .step').forEach(x=>x.classList.toggle('active', x.getAttribute('data-goto')===btn.dataset.tab));
  });
});
document.querySelectorAll('#stepper .step').forEach(s=>{
  s.addEventListener('click', ()=>document.querySelector(`.tab[data-tab="${s.getAttribute('data-goto')}"]`)?.click());
});

/* ===== Wizard Gate ===== */
const WIZ_DONE_KEY = "CUC_WIZ_DONE_V1";

function setWizardDone(isDone){
  sessionStorage.setItem(WIZ_DONE_KEY, isDone ? "1" : "0");
}
// After renderRepList() in init()
populateWizardRepSelect();

 

/* ===== Wizard: Step 1 (Sales Rep) ===== */
function populateWizardRepSelect(){
  const sel = document.getElementById('wizRepPick');
  if(!sel) return;
  // clear except placeholder
  sel.innerHTML = '<option value="">Select Primary Sales Repâ€¦</option>';
  const reps = getReps(); // already defined in your file
  reps.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r.name;
    opt.textContent = r.name;
    sel.appendChild(opt);
  });
  // add Other at the end
  const other = document.createElement('option');
  other.value = 'Other';
  other.textContent = 'Other';
  sel.appendChild(other);
}


function isWizardDone(){
  return sessionStorage.getItem(WIZ_DONE_KEY) === "1";
}

function showIntakeWork(show){
  const tabs = document.getElementById('intakeTabs');
  const stepper = document.getElementById('stepper');

  if(show){
    if(tabs) tabs.style.display = '';
    if(stepper) stepper.style.display = '';
    document.querySelector('.tab[data-tab="customer"]')?.click();
  }else{
    if(tabs) tabs.style.display = 'none';
    if(stepper) stepper.style.display = 'none';
    document.querySelectorAll('[data-panel]').forEach(p => p.style.display='none');
  }
}

function showMDM(show){
  const mdmTab   = document.querySelector('.tab[data-tab="mdm"]');
  const mdmPanel = document.querySelector('[data-panel="mdm"]');
  const mdmStep  = document.querySelector('#stepper .step[data-goto="mdm"]');

  if (show) {
    if (mdmTab)  mdmTab.style.display = '';
    if (mdmStep) mdmStep.style.display = '';
    // don't auto-switch tabs here; we only reveal it
  } else {
    // if user was on MDM, push them back to Items
    if (mdmTab && mdmTab.classList.contains('active')) {
      document.querySelector('.tab[data-tab="items"]')?.click();
    }
    if (mdmPanel) mdmPanel.style.display = 'none';
    if (mdmTab)   mdmTab.style.display = 'none';
    if (mdmStep)  mdmStep.style.display = 'none';
  }
}



/* ===== Wizard Behavior ===== */
// Step index meanings now:
// 1 = Sales Rep, 2 = Customer Type, 3 = Document Type, 4 = Scope

function resetWizardBelow(step){
  // Hide/clear anything below the given step
  if(step <= 1){
    document.getElementById('wizStep1').style.display = 'none';   // Customer Type row (now Step 2)
    document.getElementById('wizStep2').style.display = 'none';   // Document Type row (now Step 3)
    document.getElementById('wizStep3').style.display = 'none';   // Scope row (now Step 4)
    document.querySelectorAll('input[name="wizCustomerType"]').forEach(i=>i.checked=false);
    document.querySelectorAll('input[name="wizDocType"]').forEach(i=>i.checked=false);
    document.querySelectorAll('input[name="wizScope"]').forEach(i=>i.checked=false);
  }else if(step === 2){
    document.getElementById('wizStep2').style.display = 'none';
    document.getElementById('wizStep3').style.display = 'none';
    document.querySelectorAll('input[name="wizDocType"]').forEach(i=>i.checked=false);
    document.querySelectorAll('input[name="wizScope"]').forEach(i=>i.checked=false);
  }else if(step === 3){
    document.getElementById('wizStep3').style.display = 'none';
    document.querySelectorAll('input[name="wizScope"]').forEach(i=>i.checked=false);
  }
  setWizardDone(false);
  showIntakeWork(false);
}

function onWizardStepRep(repName){
  // Mirror to the real Primary Sales Rep <select id="rep1">
  const repSel = document.getElementById('rep1');
  if(repSel){
    // try to select exact text match; fall back to 'Other'
    let matched = false;
    [...repSel.options].forEach((o,i)=>{
      if(o.text.trim() === repName.trim()){ repSel.selectedIndex = i; matched = true; }
    });
    if(!matched){
      // ensure 'Other' exists in the real select
      let otherIndex = -1;
      [...repSel.options].forEach((o,i)=>{ if(o.text.trim()==='Other') otherIndex = i; });
      if(otherIndex >= 0) repSel.selectedIndex = otherIndex;
    }
  }
  // Unlock next step (Customer Type)
  document.getElementById('wizStep1').style.display = ''; // Customer Type row (now Step 2)
  resetWizardBelow(2);
}

function onWizardStep1(val){ // Customer Type (Step 2)
  // Sync to existing flags + open drawers
  document.getElementById('flagNewCustomer').checked = false;
  document.getElementById('flagCurrentCustomer').checked = false;
  document.getElementById('flag3PL').checked = false;
  document.getElementById('flagWCP').checked = false;

  const cloneRow = document.getElementById('wizCloneRow');
  if(val === 'new'){
    document.getElementById('flagNewCustomer').checked = true;
    refreshSSPTemplate();
    openDrawer('drawerNew');
    if(cloneRow) cloneRow.style.display = 'none';
  }else if(val === 'existing'){
    document.getElementById('flagCurrentCustomer').checked = true;
    openDrawer('drawerWCP');
    if(cloneRow) cloneRow.style.display = '';
  }else{
    if(cloneRow) cloneRow.style.display = 'none';
  }

  document.getElementById('wizStep2').style.display = ''; // Document Type (now Step 3)
  resetWizardBelow(3);
}

function onWizardStep2(val){ // Document Type (Step 3)
  // Mirror QUOTE/SALES ORDER/CLONE to underlying doc type radios
  const radios = document.querySelectorAll('input[name="doctype"]');
  let matched = false;
  radios.forEach(r => { r.checked = (r.value === val); if(r.checked) matched = true; });

  if(val === 'CLONE'){
    sessionStorage.setItem('CUC_CLONE_MODE','1');
    openDrawer('drawerClone'); // ðŸ‘ˆ open the new drawer
  }else{
    sessionStorage.removeItem('CUC_CLONE_MODE');
  }

  document.getElementById('wizStep3').style.display = ''; // Scope (now Step 4)
  resetWizardBelow(4);
}


function onWizardComplete(scope){
  // Mirror services toggle to scope (unchanged)
  if (scope === 'hardware') {
    document.getElementById('svcEnabled').checked = false;
    tierToMinutes(); recalcServices();
    showMDM(false);
  } else {
    document.getElementById('svcEnabled').checked = true;
    document.getElementById('svcTier').value = '1';
    tierToMinutes(); recalcServices();
    showSubtabs();
    showMDM(true);
  }

  // Only reveal Step 5 and update the hint; do NOT unlock tabs yet
  const s5 = document.getElementById('wizStep4');
  if (s5) s5.style.display = '';
  setWizardDone(false);
  showIntakeWork(false);
  document.getElementById('wizHint').textContent =
    'Pick Order Instruction (Step 5) to unlock the intake tabs.';
}




/* Wire listeners */
(function wireWizard(){
  // Step 1 (Rep)
  const wizRep = document.getElementById('wizRepPick');
  if(wizRep){
    wizRep.addEventListener('change', e=>{
      const v = (e.target.value || '').trim();
      if(!v) { resetWizardBelow(1); return; }
      onWizardStepRep(v);
      // Default: hide MDM until wizard scope = hardware+pro
     showMDM(false);

    });
  }
  // Step 2 (Customer Type)
  document.querySelectorAll('input[name="wizCustomerType"]').forEach(i=>{
    i.addEventListener('change', e => onWizardStep1(e.target.value));
  });
  // Step 3 (Doc Type)
  document.querySelectorAll('input[name="wizDocType"]').forEach(i=>{
    i.addEventListener('change', e => onWizardStep2(e.target.value));
  });
  // Step 4 (Scope)
  document.querySelectorAll('input[name="wizScope"]').forEach(i=>{
    i.addEventListener('change', e => onWizardComplete(e.target.value));
  });
    // Step 5 (Order Instruction) â€” unlock when selected
  const oi = document.getElementById('oiType');
  if (oi){
    oi.addEventListener('change', e => {
      const picked = (e.target.value || '').trim();
      if (!picked) {
        setWizardDone(false);
        showIntakeWork(false);
        document.getElementById('wizHint').textContent = 'Pick Order Instruction (Step 5) to unlock the intake tabs.';
        return;
      }
      setWizardDone(true);
      showIntakeWork(true);
      document.getElementById('wizHint').textContent = 'Wizard complete â€” tabs unlocked.';
    });
  }

})();



/* ===== Drawers ===== */
function openDrawer(id){ document.getElementById(id).classList.add('active'); }
function closeDrawer(id){ document.getElementById(id).classList.remove('active'); }

/* WCP open behavior */
document.getElementById('flagWCP').addEventListener('change', e=>{ /* no-op */ });
document.getElementById('flagCurrentCustomer').addEventListener('change', e=>{ if(e.target.checked) openDrawer('drawerWCP'); });
document.getElementById('flag3PL').addEventListener('change', e=>{ if(e.target.checked) openDrawer('drawerWCP'); });

/* NEW CUSTOMER: open drawer + auto-build + compose */
document.getElementById('flagNewCustomer').addEventListener('change', e=>{
  if(e.target.checked){
    refreshSSPTemplate();
    openDrawer('drawerNew');
    tryAutoComposeSSP();
  }
});

/* ===== WCP helper ===== */
async function openOTSearch(){
  const q=(document.getElementById('wcpQuery').value||document.getElementById('billCompany').value||'').trim();
  const target=document.getElementById('wcpResults');
  if(!q){ target.innerHTML='Enter a query first.'; return; }
  target.innerHTML='Searchingâ€¦';
  try{
    const results = await api(`/ordertime/customers/search?q=${encodeURIComponent(q)}`);
    if(!Array.isArray(results) || results.length===0){ target.innerHTML='No matches.'; return; }
    target.innerHTML = results.slice(0,25).map(r=>`
      <div class="card" style="margin:6px 0;padding:10px">
        <div><strong>${r.company||'â€”'}</strong></div>
        <div class="tiny">${r.city||''} ${r.state||''} ${r.zip||''}</div>
        <div class="row" style="margin-top:6px">
          <button class="ghost" onclick='applyCustomerFromApi(${JSON.stringify(r).replace(/'/g,"&#39;")})'>Apply</button>
        </div>
      </div>
    `).join('');
  }catch(err){
    target.innerHTML = `<span style="color:#b45309">Search failed: ${err.message}</span>`;
  }
}


async function applyCustomerFromApi(r){
  // pick an ID from the row
  const id =
    r?.Id ?? r?.ID ?? r?.id ??
    r?.CustomerId ?? r?.CustomerID ??
    r?.CustomerRef?.Id ?? r?.CustomerRef?.ID ?? r?.CustomerRef?.id;
  if (!id) { alert('No customer ID on this row.'); return; }

  // fetch normalized detail from our backend (already shaped to UI fields)
  let data;
  try {
    data = await api(`/ordertime/customers/${encodeURIComponent(id)}`);
  } catch (e) {
    console.error('Customer detail fetch failed', e);
    alert('Failed to load customer details.');
    return;
  }

  // sanity (temporary): see what we got
  try { console.table({
    company: data.company,
    billStreet: data.billing?.street, billCity: data.billing?.city, billState: data.billing?.state, billZip: data.billing?.zip,
    shipStreet: data.shipping?.street, shipCity: data.shipping?.city, shipState: data.shipping?.state, shipZip: data.shipping?.zip
  }); } catch {}

  // hand off to the existing applier (expects {company, billing{...}, shipping{...}, ...})
  const ta = document.getElementById('wcpPaste');
  if (ta) ta.value = JSON.stringify(data, null, 2);
  applyPastedCustomer('wcpPaste');

  // optional: show the Shipping tab so reps see both sides filled
  if (typeof openTab === 'function') openTab('shipping');
}





// ---- apply customer from textarea paste (JSON or key: value lines)
function applyPastedCustomer(textareaId){
  const raw = (document.getElementById(textareaId)?.value || '').trim();
  if (!raw) { alert('Paste customer details first.'); return; }

  // Parse JSON or key:value text
  let data = {};
  try { data = JSON.parse(raw); }
  catch {
    raw.split(/\r?\n/).forEach(line=>{
      const m = line.match(/^([^:]+):\s*(.*)$/);
      if (!m) return;
      setByPath(data, m[1].trim(), m[2].trim());
    });
  }
  const pick = (...vals) => vals.find(v => v !== undefined && v !== null && String(v).trim() !== '') || '';

  // Billing
  setVal('billCompany', pick(data.company, data.billing?.company));
  setVal('billContact', pick(data.billing?.contact));
  setVal('billPhone',   pick(data.billing?.phone));
  setVal('billEmail',   pick(data.billing?.email));
  setVal('billStreet',  pick(data.billing?.street));
  setVal('billSuite',   pick(data.billing?.suite));
  setVal('billCity',    pick(data.billing?.city));
  setVal('billState',   pick(data.billing?.state));
  setVal('billZip',     pick(data.billing?.zip));

  // Shipping (fallback to billing)
  setVal('shipCompany', pick(data.shipping?.company, data.company));
  setVal('shipContact', pick(data.shipping?.contact, data.billing?.contact));
  setVal('shipPhone',   pick(data.shipping?.phone,   data.billing?.phone));
  setVal('shipEmail',   pick(data.shipping?.email,   data.billing?.email));
  setVal('shipStreet',  pick(data.shipping?.street,  data.billing?.street));
  setVal('shipSuite',   pick(data.shipping?.suite,   data.billing?.suite));
  setVal('shipCity',    pick(data.shipping?.city,    data.billing?.city));
  setVal('shipState',   pick(data.shipping?.state,   data.billing?.state));
  setVal('shipZip',     pick(data.shipping?.zip,     data.billing?.zip));
  const resEl = document.getElementById('resShip');
  if (resEl) resEl.checked = !!data.shipping?.residence;

  // Payment & options
  const pm = pick(data.payment?.method); if (pm) selectByTextExact('payMethod', pm);
  setVal('payTerms', pick(data.payment?.terms));
  const tax = document.getElementById('taxExempt');    if (tax) tax.checked = !!data.payment?.taxExempt;
  const agr = document.getElementById('hasAgreement'); if (agr) agr.checked = !!data.payment?.agreement;

  if (data.shippingOptions?.pay)   selectByTextExact('shipPay',   data.shippingOptions.pay);
  if (data.shippingOptions?.speed) selectByTextExact('shipSpeed', data.shippingOptions.speed);
  if (data.shippingOptions?.shortShip) selectByTextExact('shortShip', data.shippingOptions.shortShip);

  // Reps / carrier
  if (pick(data.rep?.primary))   selectByTextExact('rep1', pick(data.rep?.primary));
  if (pick(data.rep?.secondary)) selectByTextExact('rep2', pick(data.rep?.secondary));
  setVal('carrierRepName',  pick(data.carrierRep?.name));
  setVal('carrierRepEmail', pick(data.carrierRep?.email));

  // Show filled UI
  try { if (typeof showIntakeWork === 'function') showIntakeWork(true); } catch {}
  document.querySelector('.tab[data-tab="customer"]')?.click();

  // Close the search drawer if present and recompute totals
  closeDrawer?.('drawerWCP');
  refreshTotals?.();
}

// Search sales orders for cloning
async function openSOSearch(){
  const q = (document.getElementById('cloneQuery').value || '').trim();
  const target = document.getElementById('cloneResults');
  if(!q){ target.innerHTML = 'Enter a query first.'; return; }
  target.innerHTML = 'Searchingâ€¦';
  try{
    // Use non-hyphen route and destructure the array from { results }
    const { results } = await api(`/ordertime/salesorders/search?q=${encodeURIComponent(q)}`);
    if(!Array.isArray(results) || results.length === 0){
      target.innerHTML = 'No matches.'; return;
    }
    target.innerHTML = results.slice(0,25).map(so => `

      <div class="card" style="margin:6px 0;padding:10px">
        <div><strong>${so.number || so.id || 'SO'}</strong> â€” ${so.customerName || ''}</div>
        <div class="tiny">${so.date || ''} â€¢ ${so.status || ''}</div>
        <div class="row" style="margin-top:6px">
          <button class="ghost" onclick="loadSO('${so.id || so.number}')">Preview</button>
          <button class="ok" onclick="applySO('${so.id || so.number}')">Apply</button>
        </div>
      </div>
    `).join('');
  }catch(err){
    target.innerHTML = `<span style="color:#b45309">Search failed: ${err.message}</span>`;
  }
}

async function loadSO(id){
  try{
    // Use the docNo-based endpoint we control
    const raw = await api(`/ordertime/salesorders/get?docNo=${encodeURIComponent(id)}`);

    // Some backends return { ok, order }, others return the raw SO.
    const base = raw?.order ?? raw;

    // Normalize to the JSON shape your applyClonedOrder() already expects
    const get = (o, p, d='') => {
      try { return p.split('.').reduce((x,k)=>x?.[k], o) ?? d; } catch { return d; }
    };

    const billing = {
      contact: get(base,'BillTo.ContactName'),
      phone:   get(base,'BillTo.Phone'),
      email:   get(base,'BillTo.Email'),
      street:  get(base,'BillTo.Address1'),
      suite:   get(base,'BillTo.Address2'),
      city:    get(base,'BillTo.City'),
      state:   get(base,'BillTo.State'),
      zip:     get(base,'BillTo.Zip'),
    };

    const shipping = {
      company: get(base,'ShipTo.Company') || get(base,'CustomerRef.Name') || get(base,'CustomerName'),
      contact: get(base,'ShipTo.ContactName'),
      phone:   get(base,'ShipTo.Phone'),
      email:   get(base,'ShipTo.Email'),
      street:  get(base,'ShipTo.Address1'),
      suite:   get(base,'ShipTo.Address2'),
      city:    get(base,'ShipTo.City'),
      state:   get(base,'ShipTo.State'),
      zip:     get(base,'ShipTo.Zip'),
      residence: !!get(base,'ShipTo.Residential', false),
    };

    const items = (base?.Lines || base?.LineItems || []).map(L => ({
      sku:   get(L,'ItemRef.Code') || get(L,'ItemCode') || get(L,'SKU') || '',
      desc:  get(L,'Description') || get(L,'ItemRef.Name') || '',
      qty:   Number(get(L,'Quantity', 0)),
      sell:  Number(get(L,'UnitPrice', 0)),
      // Optional attribute passthroughs your UI knows how to show:
      carrier: get(L,'Custom.Carrier') || get(L,'Carrier') || '',
      cond:    get(L,'Custom.New_CPO') || get(L,'New_CPO') || '',
    }));

    const shaped = {
      customer: {
        company: get(base,'CustomerRef.Name') || get(base,'CustomerName') || '',
        billing
      },
      billing,
      shipping,
      items,
      payment: {
        method: get(base,'PaymentMethod') || '',
        terms:  get(base,'Terms') || ''
      },
      shippingOptions: {
        pay:       get(base,'ShipPayMethod') || '',
        speed:     get(base,'ShipSpeed') || '',
        shortShip: get(base,'ShortShip') || ''
      }
    };

    document.getElementById('clonePaste').value = JSON.stringify(shaped, null, 2);
  }catch(err){
    alert(`Load SO failed: ${err.message}`);
  }
}

// Pull + apply (uses your existing applyClonedOrder mapper)
async function applySO(id){
  await loadSO(id);
  applyClonedOrder(); // your JSONâ†’form function already in the file
}

function fillWCPExample(){
  document.getElementById('wcpQuery').value='Acme Corp';
  document.getElementById('wcpPaste').value = JSON.stringify(DEMO_CUSTOMER_FULL, null, 2);
}

function applyClonedOrder(){
  const raw = (document.getElementById('clonePaste').value || '').trim();
  if(!raw){ alert('Paste a Sales Order export JSON first.'); return; }

  let data = {};
  try{ data = JSON.parse(raw); }
  catch(_){ alert('Invalid JSON. Make sure you pasted a valid Sales Order JSON.'); return; }

  // ----- Customer / Billing
  setVal('billCompany', data.customer?.company || data.company || '');
  const b = data.customer?.billing || data.billing || {};
  setVal('billContact', b.contact || ''); setVal('billPhone', b.phone || '');
  setVal('billEmail', b.email || ''); setVal('billStreet', b.street || '');
  setVal('billSuite', b.suite || ''); setVal('billCity', b.city || '');
  setVal('billState', b.state || ''); setVal('billZip', b.zip || '');

  // ----- Shipping
  const s = data.shipping || {};
  setVal('shipCompany', s.company || ''); setVal('shipContact', s.contact || '');
  setVal('shipPhone', s.phone || ''); setVal('shipEmail', s.email || '');
  setVal('shipStreet', s.street || ''); setVal('shipSuite', s.suite || '');
  setVal('shipCity', s.city || ''); setVal('shipState', s.state || ''); setVal('shipZip', s.zip || '');
  document.getElementById('resShip').checked = !!s.residence;

  // ----- Payment & Shipping Options
  const p = data.payment || {};
  if(p.method) selectByTextExact('payMethod', p.method);
  setVal('payTerms', p.terms || '');
  document.getElementById('taxExempt').checked = !!p.taxExempt;
  document.getElementById('hasAgreement').checked = !!p.agreement;

  const so = data.shippingOptions || {};
  if(so.pay) selectByTextExact('shipPay', so.pay);
  if(so.speed) selectByTextExact('shipSpeed', so.speed);
  if(so.shortShip) selectByTextExact('shortShip', so.shortShip);

  // ----- Items (replace current rows with cloned items)
  document.getElementById('itemsBody').innerHTML = '';
  const lines = Array.isArray(data.items) ? data.items : [];
  if(lines.length === 0) addRow(); // keep one blank if no items

  lines.forEach((l, idx)=>{
    const prefill = {
      desc:l.desc, model:l.model, color:l.color, sku:l.sku, qty:l.qty,
      net:l.net, carrier:l.carrier, payout:l.payout, msrp:l.msrp, disc:l.disc, sell:l.sell,
      cond:l.cond, stock:l.stock, vendor:l.vendor, cost:l.cost,
      deal:l.deal, hold:l.hold, leadtime:l.leadtime, eol:l.eol
    };
    addRow(prefill);

    // Accessory / Insurance / Services / SIM / Licences â†’ most-recent item panels
    if(l.accessory){ setVal('accSku', l.accessory.sku || ''); setVal('accDesc', l.accessory.desc || ''); setVal('accQty', l.accessory.qty || 0); setVal('accSell', l.accessory.sell || ''); }
    if(l.insurance){ selectByTextExact('insPlan', l.insurance.plan || 'None'); selectByTextExact('insDed', l.insurance.ded || '$0'); selectByTextExact('insTerm', l.insurance.term || '1 year'); setVal('insSell', l.insurance.sell || ''); }

    if(l.services){
      document.getElementById('svcEnabled').checked = !!l.services.enabled;
      document.getElementById('svcTier').value = String(l.services.tier ?? 0);
      tierToMinutes(); recalcServices();
    }

    if(l.sim){
      // these are dropdowns now
      if(l.sim.card)      document.getElementById('simCard').value = l.sim.card;
      if(l.sim.pairing)   document.getElementById('pairingOption').value = l.sim.pairing;
      if(l.sim.handling)  document.getElementById('simHandling').value = l.sim.handling;
    }

    if(l.lic){
      setVal('licVendor', l.lic.vendor || ''); setVal('licDuration', l.lic.duration || '');
      setVal('licProrated', l.lic.prorated || ''); setVal('licKey', l.lic.key || '');
      setVal('licContact', l.lic.contact || '');
    }
  });

  // ----- MDM
  const m = data.mdm || {};
  document.getElementById('carrierSPF').checked = !!m.carrierSPF;
  setVal('planCode', m.planCode || '');
  document.getElementById('subsidyNote').checked = !!m.subsidyNote;
  document.getElementById('mdmABM').checked = !!m.abm;
  document.getElementById('mdmKnox').checked = !!m.knox;
  setVal('knoxAccount', m.knoxAccount || '');
  document.getElementById('mdmZeroTouch').checked = !!m.zeroTouch;
  document.getElementById('mdmPro').checked = !!m.pro;
  setVal('mdmNotes', m.notes || '');

  // ----- Wrap up
  closeDrawer('drawerClone');
  refreshTotals();
  buildSummary();       // keep Summary and CSV in sync
  refreshCSVPreview();
}

/* ===== Clone Existing Order helper ===== */
// ---------- Clone Existing Sales Order (OrderTime) ----------
async function openSOSearch(){
  const q = (document.getElementById('cloneQuery').value || '').trim();
  const target = document.getElementById('cloneResults');
  if(!q){ target.innerHTML = 'Enter a query first.'; return; }
  target.innerHTML = 'Searchingâ€¦';
  try{
    // GET /api/ordertime/salesorders/search returns { results: [...] }
    const { results } = await api(`/ordertime/salesorders/search?q=${encodeURIComponent(q)}`);
    if(!Array.isArray(results) || results.length === 0){
      target.innerHTML = 'No matches.'; return;
    }
    target.innerHTML = results.slice(0,25).map(so => `
      <div class="card" style="margin:6px 0;padding:10px">
        <div><strong>${so.number || so.id || 'SO'}</strong> â€” ${so.customerName || ''}</div>
        <div class="tiny">${so.date || ''} â€¢ ${so.status || ''}</div>
        <div class="row" style="margin-top:6px">
          <button class="ghost" onclick="loadSO('${so.id || so.number}')">Preview</button>
          <button class="ok" onclick="applySO('${so.id || so.number}')">Apply</button>
        </div>
      </div>
    `).join('');
  }catch(err){
    target.innerHTML = `<span style="color:#b45309">Search failed: ${err.message}</span>`;
  }
}


async function loadSO(id){
  try{
    // Use the docNo-based endpoint we control
    const raw = await api(`/ordertime/salesorders/get?docNo=${encodeURIComponent(id)}`);

    // Some backends return { ok, order }, others return the raw SO.
    const base = raw?.order ?? raw;

    // Normalize to the JSON shape your applyClonedOrder() already expects
    const get = (o, p, d='') => { try { return p.split('.').reduce((x,k)=>x?.[k], o) ?? d; } catch { return d; } };

    const billing = {
      contact: get(base,'BillTo.ContactName'),
      phone:   get(base,'BillTo.Phone'),
      email:   get(base,'BillTo.Email'),
      street:  get(base,'BillTo.Address1'),
      suite:   get(base,'BillTo.Address2'),
      city:    get(base,'BillTo.City'),
      state:   get(base,'BillTo.State'),
      zip:     get(base,'BillTo.Zip'),
    };

    const shipping = {
      company: get(base,'ShipTo.Company') || get(base,'CustomerRef.Name') || get(base,'CustomerName'),
      contact: get(base,'ShipTo.ContactName'),
      phone:   get(base,'ShipTo.Phone'),
      email:   get(base,'ShipTo.Email'),
      street:  get(base,'ShipTo.Address1'),
      suite:   get(base,'ShipTo.Address2'),
      city:    get(base,'ShipTo.City'),
      state:   get(base,'ShipTo.State'),
      zip:     get(base,'ShipTo.Zip'),
      residence: !!get(base,'ShipTo.Residential', false),
    };

    const items = (base?.Lines || base?.LineItems || []).map(L => ({
      sku:   get(L,'ItemRef.Code') || get(L,'ItemCode') || get(L,'SKU') || '',
      desc:  get(L,'Description') || get(L,'ItemRef.Name') || '',
      qty:   Number(get(L,'Quantity', 0)),
      sell:  Number(get(L,'UnitPrice', 0)),
      carrier: get(L,'Custom.Carrier') || get(L,'Carrier') || '',
      cond:    get(L,'Custom.New_CPO') || get(L,'New_CPO') || '',
    }));

    const shaped = {
      customer: { company: get(base,'CustomerRef.Name') || get(base,'CustomerName') || '', billing },
      billing,
      shipping,
      items,
      payment: { method: get(base,'PaymentMethod') || '', terms: get(base,'Terms') || '' },
      shippingOptions: { pay: get(base,'ShipPayMethod') || '', speed: get(base,'ShipSpeed') || '', shortShip: get(base,'ShortShip') || '' }
    };

    document.getElementById('clonePaste').value = JSON.stringify(shaped, null, 2);
  }catch(err){
    alert(`Load SO failed: ${err.message}`);
  }
}


async function applySO(id){
  await loadSO(id);     // puts the JSON into #clonePaste
  applyClonedOrder();   // reuses your existing JSONâ†’form mapper
}


function fillCloneExample(){
  document.getElementById('cloneQuery').value = 'Acme Corp';
  document.getElementById('clonePaste').value = JSON.stringify(CLONE_ORDER_EXAMPLE, null, 2);
}

/* ===== SSP invite ===== */
function sspInviteBody(rep,company){
  return `Hi there,

Weâ€™re getting your account set up with ConnectUS. Please register in our Self-Service Portal (SSP) so we can finalize your quote/order.

Registration link:
https://connectuscorp.com/my-account/?salep-rep=${encodeURIComponent((rep||'').toLowerCase().replace(/\s+/g,'-'))}

Company: ${company||""}

Thanks,
${rep||"ConnectUS Sales"}
ConnectUS Corp`;
}
function getCustomerFirstName(){
  const full=(document.getElementById('billContact')?.value||'').trim();
  if(!full) return '';
  const parts=full.split(/\s+/);
  return parts[0]||'';
}
function refreshSSPTemplate(){
  const repName=(document.getElementById('rep1').value||'').trim();
  const rep = getRepByName(repName);
  const firstName = getCustomerFirstName() || 'there';
  const custEmail = (document.getElementById('billEmail').value||'').trim();

  let body;
  if(rep){
    body = (rep.template||'')
      .replace(/\{\{\s*Customer First Name\s*\}\}/g, firstName)
      .replace(/\{\{\s*Current Email\s*\}\}/g, custEmail || '(your email)');
    if(rep.slug){
      body = body.replace(/(my-account\/\?salep-rep=)[^\s]+/g, `$1${rep.slug}`);
    }
  }else{
    body = sspInviteBody(repName, (document.getElementById('billCompany').value||''));
  }

  document.getElementById('sspSubject').value=SSP_INVITE_SUBJECT;
  document.getElementById('sspBody').value=body;
  document.getElementById('sspTo').value=custEmail;
}
function tryAutoComposeSSP(){
  const to=(document.getElementById('billEmail').value||'').trim();
  const repName=(document.getElementById('rep1').value||'').trim();
  if(!repName){ alert('Select a Primary Sales Rep first.'); return; }
  if(!to){ alert('Add Billing Email before sending the invite.'); return; }
  refreshSSPTemplate();
  composeSSP();
}
function copySSP(){
  const text=`To: ${document.getElementById('sspTo').value||'(add recipient)'}\nSubject: ${document.getElementById('sspSubject').value}\n\n${document.getElementById('sspBody').value}`;
  navigator.clipboard.writeText(text);
  alert('SSP email copied.');
}
function composeSSP(){
  const to=encodeURIComponent(document.getElementById('sspTo').value||'');
  const subj=encodeURIComponent(document.getElementById('sspSubject').value||'');
  const body=encodeURIComponent(document.getElementById('sspBody').value||'');
  window.location.href=`mailto:${to}?subject=${subj}&body=${body}`;
}

function composeSSPInGmail(){
  const toEl   = document.getElementById('sspTo');
  const subEl  = document.getElementById('sspSubject');
  const bodyEl = document.getElementById('sspBody');
  const to      = toEl ? toEl.value : '';
  const subject = subEl ? subEl.value : '';
  const body    = bodyEl ? bodyEl.value : '';
  openGmailCompose({ to, subject, body });
}

function openGmailCompose({to, subject, body}) {
  const base = "https://mail.google.com/mail/?view=cm&fs=1";
  const url =
    `${base}&to=${encodeURIComponent(to || "")}` +
    `&su=${encodeURIComponent(subject || "")}` +
    `&body=${encodeURIComponent(body || "")}`;

  // Open ONLY in a new tab
  const a = document.createElement('a');
  a.href = url;
  a.target = '_blank';
  a.rel = 'noopener';
  document.body.appendChild(a);
  a.click();
  a.remove();
}



/* ===== Items & example ===== */
const QUOTE_REQUEST_MAP={
  "QR-2025-00123":{
    desc:'Apple iPad 10.2" 128GB â€” Silver', model:'MK2K3LL/A', color:'Silver', sku:'IPAD10-128-SLV', qty:25, net:'LTE', carrier:'AT&T',
    payout:50, msrp:429.99, disc:10, sell:386.99, cond:'New', stock:'Yes', vendor:'Ingram', cost:330.00,
    deal:'DLL-$310 / DR-12345', hold:'RES-9981', leadtime:'2-3 wks', eol:'No',
    accessory:{ sku:'CASE-IPAD10-RUG', desc:'Rugged Case', qty:1, sell:29.99 },
    insurance:{ plan:'AKKO', ded:'$100', term:'2 year', sell:69.00 },
    services:{ enabled:true, tier:1 },
    sim:{ card:'n/a', pairing:'Option 1', handling:'Preinstall', questionnaire:'https://example.com/helix' },
    lic:{ vendor:'Jamf', duration:'1 year', prorated:'12.00', key:'SIMBA-ABC123', contact:'licenses@vendor.com' }
  }
};
function el(tag,attrs={},children=[]){const e=document.createElement(tag);Object.entries(attrs).forEach(([k,v])=>{if(k==='class')e.className=v;else if(k==='html')e.innerHTML=v;else if(k==='onclick')e.onclick=v;else e.setAttribute(k,v)});children.forEach(c=>e.appendChild(c));return e;}
function addRow(prefill){
  const tr=el('tr');
  const cols = [
  {key:'desc',     ph:'e.g., Apple iPad 256GB Space Gray'},
  {key:'sku',      ph:'ORDERTIME-SKU'},
  {key:'qty',      ph:'Qty', type:'number', min:1, val:1},
  {key:'sell',     ph:'$', type:'number', step:'0.01'},           // Sell Price
  {key:'lineInstr',ph:'Line Instruction'},
  {key:'model',    ph:'Model / Part #'},
  {key:'color',    ph:'Color'},
  {key:'net',      ph:'LTE / Wi-Fi / Both'},
  {key:'carrier',  ph:'Carrier'},
  {key:'payout',   ph:'$', type:'number', step:'0.01'},
  {key:'msrp',     ph:'$', type:'number', step:'0.01'},
  {key:'disc',     ph:'%', type:'number', step:'0.01'},
  {key:'cond',     ph:'New / CPO'},
  {key:'stock',    ph:'Yes/No'},
  {key:'vendor',   ph:'Vendor'},
  {key:'cost',     ph:'$', type:'number', step:'0.01'},
  {key:'deal',     ph:'DLL/SPA Price / Deal Reg #'},
  {key:'hold',     ph:'Hold/Reservation #'},
  {key:'leadtime', ph:'Delivery Lead Time'},
  {key:'eol',      ph:'EOL Confirm (Yes/No)'}
];

  cols.forEach(c=>{
  const td = el('td');
  const inp = el('input',{placeholder:c.ph});
  inp.dataset.key = c.key;
  if(c.type) inp.type = c.type;
  if(c.min!==undefined) inp.min = c.min;
  if(c.step) inp.step = c.step;
  if(c.val!==undefined) inp.value = c.val;

  // existing totals wiring
  inp.addEventListener('input', refreshTotals);

  // NEW: autosize wiring
  wireAutosize(inp);

  td.appendChild(inp);
  tr.appendChild(td);
});

  const rm=el('td',{},[el('button',{class:'bad',onclick:()=>{tr.remove(); refreshTotals();}},[document.createTextNode('Remove')])]); tr.appendChild(rm);
  document.getElementById('itemsBody').appendChild(tr);

  if(prefill){
    [...tr.querySelectorAll('input')].forEach(inp=>{ const k=inp.dataset.key; if(prefill[k]!==undefined) inp.value=prefill[k]; });
    showSubtabs();
    if(prefill.accessory){ setVal('accSku',prefill.accessory.sku); setVal('accDesc',prefill.accessory.desc); setVal('accQty',prefill.accessory.qty); setVal('accSell',prefill.accessory.sell); }
    if(prefill.insurance){ selectByTextExact('insPlan',prefill.insurance.plan); selectByTextExact('insDed',prefill.insurance.ded); selectByTextExact('insTerm',prefill.insurance.term); setVal('insSell',prefill.insurance.sell); }
    if(prefill.services){ document.getElementById('svcEnabled').checked=!!prefill.services.enabled; document.getElementById('svcTier').value=String(prefill.services.tier||0); tierToMinutes(); recalcServices(); }
    if(prefill.sim){ setVal('simCard',prefill.sim.card); setVal('pairingOption',prefill.sim.pairing); setVal('simHandling',prefill.sim.handling); setVal('simQuestionnaire',prefill.sim.questionnaire); }
    if(prefill.lic){ setVal('licVendor',prefill.lic.vendor); setVal('licDuration',prefill.lic.duration); setVal('licProrated',prefill.lic.prorated); setVal('licKey',prefill.lic.key); setVal('licContact',prefill.lic.contact); }
  }
  document.getElementById('totalsBox').style.display='';
  refreshTotals();
}
function getItems(){
  const rows = [...document.querySelectorAll('#itemsBody tr')];
  return rows.map(r=>{
    const obj = {};
    [...r.querySelectorAll('input')].forEach(i => obj[i.dataset.key] = i.value.trim());
    return obj;
  }).filter(o => Object.values(o).some(v => v));
}


  
function getCurrentRowQty(){
  const lastRow=document.querySelector('#itemsBody tr:last-child');
  const qty=lastRow?parseFloat(lastRow.querySelector('input[data-key="qty"]')?.value||'0'):0;
  return isFinite(qty)?qty:0;
}
function autoExample(){ addRow(QUOTE_REQUEST_MAP["QR-2025-00123"]); }
document.getElementById('btnLoadQR').addEventListener('click', ()=>{
  const id=(document.getElementById('qrid').value||'').trim();
  if(!id){ alert('Enter a Quote Request ID.'); return; }
  const data = QUOTE_REQUEST_MAP[id];
  if(!data){ alert('No mapping found for that ID.'); return; }
  addRow(data);
});

/* ===== Subtabs ===== */
function showSubtabs(){ document.getElementById('subtabsArea').style.display=''; document.getElementById('subtabPanels').style.display=''; }
document.querySelectorAll('.subtab').forEach(s=>{
  s.addEventListener('click',()=>{
    document.querySelectorAll('.subtab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('[data-subpanel]').forEach(p=>p.style.display='none');
    s.classList.add('active');
    document.querySelector(`[data-subpanel="${s.dataset.sub}"]`).style.display='';
  });
});

/* ===== Accessory Brick + Cable ===== */
document.getElementById('bcInclude').addEventListener('change', e=>{
  if(e.target.checked){
    if(!val('accSku')) setVal('accSku','PWR-BRICK-CABLE');
    if(!val('accDesc')) setVal('accDesc','Power Brick + Cable Kit');
    if(!val('accQty')) setVal('accQty','1');
    if(!val('accSell')) setVal('accSell','0.00');
  }
  refreshTotals();
});

/* ===== Services logic ===== */
document.getElementById('svcTier').addEventListener('change', ()=>{ tierToMinutes(); recalcServices(); });
document.getElementById('svcMinutes').addEventListener('input', recalcServices);
document.getElementById('svcEnabled').addEventListener('change', recalcServices);
document.getElementById('itemsBody').addEventListener('input', e=>{
  if(e.target?.dataset?.key==='qty') recalcServices();
});
function tierToMinutes(){
  const tier=parseInt(document.getElementById('svcTier').value||'0',10);
  const minutes = tier===0 ? 5 : tier*15;
  document.getElementById('svcMinutes').value = minutes;
  document.getElementById('svcSKU').value = `PROSERV-TIER-${tier}`;
}
function recalcServices(){
  const enabled = document.getElementById('svcEnabled').checked;
  const minutes = parseFloat(document.getElementById('svcMinutes').value||'0');
  const per = enabled ? minutes * RATE_PER_MIN : 0;
  setVal('svcCostPer', per.toFixed(2));
  const qty = getCurrentRowQty();
  setVal('svcCostTotal', (per*qty).toFixed(2));
  if(enabled && !document.getElementById('svcSKU').value){
    document.getElementById('svcSKU').value=`PROSERV-TIER-${parseInt(document.getElementById('svcTier').value||'0',10)}`;
  }
  refreshTotals();
}

/* ===== Totals ===== */
function parseNum(x){ const n=parseFloat(String(x).replace(/[^0-9.\-]/g,'')); return isFinite(n)?n:0; }
function fmt(n){ return `$${(Math.round(n*100)/100).toFixed(2)}`; }

function computeTotals(){
  const items=getItems();
  let linesSubtotal=0;
  items.forEach(l=>{
    const qty=parseNum(l.qty), price=parseNum(l.sell);
    linesSubtotal += qty*price;
  });

  const qty = getCurrentRowQty();
  const accQty=parseNum(val('accQty')); const accSell=parseNum(val('accSell'));
  const accTotal = accQty*accSell*qty;

  const svcEnabled=document.getElementById('svcEnabled').checked;
  const svcPer=parseNum(val('svcCostPer'));
  const svcTotal = svcEnabled ? svcPer*qty : 0;

  const insSell=parseNum(val('insSell'));
  const insTotal = insSell*qty;

  const taxExempt = document.getElementById('taxExempt').checked;
  const taxable = linesSubtotal + accTotal + svcTotal + insTotal;
  const tax = taxExempt ? 0 : taxable*TAX_RATE;
  const grand = taxable + tax;

  return {linesSubtotal, accTotal, svcTotal, insTotal, tax, grand, taxable, taxExempt};
}
function refreshTotals(){
  const t=computeTotals();
  document.getElementById('tLines').textContent=fmt(t.linesSubtotal);
  document.getElementById('tAcc').textContent=fmt(t.accTotal);
  document.getElementById('tSvc').textContent=fmt(t.svcTotal);
  document.getElementById('tIns').textContent=fmt(t.insTotal);
  document.getElementById('tTax').textContent=fmt(t.tax);
  document.getElementById('tGrand').textContent=fmt(t.grand);
  document.getElementById('totalsBox').style.display='';
  document.getElementById('taxNote').textContent = t.taxExempt ? 'Tax Exempt: tax not applied.' : `Tax rate: ${(TAX_RATE*100).toFixed(2)}%`;
}

/* ===== Summary / Validation ===== */
function val(id){return (document.getElementById(id)?.value||'').trim()}
function bool(id){return document.getElementById(id)?.checked}
function getSelText(id){
  const el = document.getElementById(id);
  if(!el) return '';
  const i = el.selectedIndex;
  return i>=0 ? (el.options[i].text||'').trim() : '';
}
function buildSummary(){
  const docType=[...document.querySelectorAll('input[name="doctype"]')].find(x=>x.checked)?.value||'QUOTE';
  const lines=getItems();
  const t=computeTotals();
  const parts=[];
  parts.push(`DOCUMENT: ${docType}`);
  parts.push(`Flags: ${bool('flagNewCustomer')?'NEW Customer; ':''}${bool('flagWCP')?'WCP; ':''}${bool('flagCurrentCustomer')?'Current Customer; ':''}${bool('flag3PL')?'3PL; ':''}`.replace(/; $/,''));
  parts.push('');
  parts.push('SALES / PARTNER');
  parts.push(`- Primary Rep: ${val('rep1')||'â€”'}; Secondary: ${val('rep2')||'â€”'}; Referral: ${val('refPartner')||'â€”'}`);
  parts.push(`- Carrier Rep: ${val('carrierRepName')} <${val('carrierRepEmail')||'â€”'}>; CUC Rep: ${val('cucRep')||'â€”'}`);
  parts.push('');
  parts.push('BILLING');
  parts.push(`- ${val('billCompany')} â€” ${val('billContact')} (${val('billPhone')}) <${val('billEmail')}>`);
  parts.push(`- ${val('billStreet')} ${val('billSuite')}, ${val('billCity')}, ${val('billState')} ${val('billZip')}`);
  parts.push('');
  parts.push('PAYMENT');
  parts.push(`- Method: ${val('payMethod')||'â€”'}; Terms: ${val('payTerms')||'â€”'}; Agreement: ${bool('hasAgreement')?'Yes':'No'}; Tax Exempt: ${bool('taxExempt')?'Yes':'No'}`);
  parts.push('');
  parts.push('SHIPPING');
  parts.push(`- ${val('shipCompany')} â€” ${val('shipContact')} (${val('shipPhone')}) <${val('shipEmail')}> ${bool('resShip')?'[Residence]':''}`);
  parts.push(`- ${val('shipStreet')} ${val('shipSuite')}, ${val('shipCity')}, ${val('shipState')} ${val('shipZip')}`);
  parts.push(`- Options: Pay ${val('shipPay')||'â€”'}; Speed ${val('shipSpeed')||'â€”'}; Short Ship ${val('shortShip')||'â€”'}; Req ${val('reqShipDate')||'â€”'}; Expected ${val('expShipDate')||'â€”'}`);
  parts.push('');
  parts.push('LINES');
  if(lines.length===0){ parts.push('  (none)'); }
  lines.forEach((l,i)=>parts.push(`  ${i+1}. ${l.desc||'â€”'} | Model ${l.model||'â€”'} | Color ${l.color||'â€”'} | SKU ${l.sku||'â€”'} | Qty ${l.qty||'â€”'} | ${l.net||'â€”'} | ${l.carrier||'â€”'} | Sell $${l.sell||'â€”'} | ${l.cond||'â€”'} | In-Stock ${l.stock||'â€”'} | Vendor ${l.vendor||'â€”'} | Cost $${l.cost||'â€”'} | Deal ${l.deal||'â€”'} | Hold ${l.hold||'â€”'} | Lead ${l.leadtime||'â€”'} | EOL ${l.eol||'â€”'}`));
  parts.push('');
  parts.push('ACCESSORY / SERVICES / INSURANCE (most-recent item)');
  parts.push(`- Acc: Brick+Cable ${document.getElementById('bcInclude').checked?'Yes':'No'} | SKU ${val('accSku')||'â€”'} | ${val('accDesc')||'â€”'} | Qty/Unit ${val('accQty')||0} | Sell $${val('accSell')||'â€”'}`);
  parts.push(`- Svc: Included ${bool('svcEnabled')?'Yes':'No'} | Tier ${val('svcTier')||'0'} | Minutes ${val('svcMinutes')||'0'} | SKU ${val('svcSKU')||'â€”'} | $/device ${val('svcCostPer')||'0.00'}`);
  parts.push(`- Ins: Plan ${val('insPlan')||'None'} | Ded ${val('insDed')||'â€”'} | Term ${val('insTerm')||'â€”'} | Sell $${val('insSell')||'â€”'}`);
  parts.push('');
  parts.push('SIM / PAIRING (most-recent item)');
  parts.push(`- SIM ${val('simCard')||'â€”'} | Pairing ${val('pairingOption')||'â€”'} | Handling ${val('simHandling')||'â€”'} | Helix ${val('simQuestionnaire')||'â€”'}`);
  parts.push('');
  parts.push('LICENSES (most-recent item)');
  parts.push(`- Vendor ${val('licVendor')||'â€”'} | Duration ${val('licDuration')||'â€”'} | Prorated $${val('licProrated')||'â€”'} | Key ${val('licKey')||'â€”'} | Contact ${val('licContact')||'â€”'}`);
  parts.push('');
  parts.push('MDM & CARRIER SUBSIDY');
  parts.push(`- Carrier SPF: ${bool('carrierSPF')?'Yes':'No'} | Plan Code: ${val('planCode')||'â€”'} | Subsidy Verbiage: ${bool('subsidyNote')?'Yes':'No'}`);
  parts.push(`- ABM: ${bool('mdmABM')?'Yes':'No'} | Knox (KME): ${bool('mdmKnox')?'Yes':'No'} | Knox Account #: ${val('knoxAccount')||'â€”'} | Zero Touch: ${bool('mdmZeroTouch')?'Yes':'No'} | MDM Pro: ${bool('mdmPro')?'Yes':'No'}`);
  parts.push(`- MDM Notes: ${val('mdmNotes')||'â€”'}`);
  parts.push('');
  parts.push('TOTALS');
  parts.push(`- Lines Subtotal: ${fmt(t.linesSubtotal)}`);
  parts.push(`- Accessories: ${fmt(t.accTotal)}; Services: ${fmt(t.svcTotal)}; Insurance: ${fmt(t.insTotal)}`);
  parts.push(`- Tax: ${fmt(t.tax)} ${t.taxExempt?'(Exempt)':''}`);
  parts.push(`= GRAND TOTAL: ${fmt(t.grand)}`);

  document.getElementById('summary').textContent=parts.join('\n');

  // keep CSV preview in sync with latest values
  refreshCSVPreview();
}


function buildIntakePayload(){
  const docType = [...document.querySelectorAll('input[name="doctype"]')].find(x=>x.checked)?.value || 'QUOTE';
  const t = computeTotals();
  return {
    wizard: {
      rep: document.getElementById('rep1')?.value || '',
      customerType: document.querySelector('input[name="wizCustomerType"]:checked')?.value || '',
      docType,
      scope: document.querySelector('input[name="wizScope"]:checked')?.value || ''
    },
    sales: {
      primary: document.getElementById('rep1')?.value || '',
      secondary: document.getElementById('rep2')?.value || '',
      referral: document.getElementById('refPartner')?.value || '',
      carrierRep: { name: val('carrierRepName'), email: val('carrierRepEmail') },
      cucRep: val('cucRep')
    },
    billing: {
      company: val('billCompany'), contact: val('billContact'), phone: val('billPhone'), email: val('billEmail'),
      street: val('billStreet'), suite: val('billSuite'), city: val('billCity'), state: val('billState'), zip: val('billZip')
    },
    payment: { method: val('payMethod'), terms: val('payTerms'), agreement: bool('hasAgreement'), taxExempt: bool('taxExempt') },
    shipping: {
      company: val('shipCompany'), contact: val('shipContact'), phone: val('shipPhone'), email: val('shipEmail'),
      street: val('shipStreet'), suite: val('shipSuite'), city: val('shipCity'), state: val('shipState'), zip: val('shipZip'),
      residence: bool('resShip')
    },
    shippingOptions: { pay: val('shipPay'), speed: val('shipSpeed'), shortShip: val('shortShip'),
      req: val('reqShipDate'), expected: val('expShipDate') },
    items: getItems(),
    accessory: {
      includeBC: document.getElementById('bcInclude')?.checked || false,
      sku: val('accSku'), desc: val('accDesc'),
      perUnitQty: val('accQty'), perUnitSell: val('accSell')
    },
    insurance: { plan: val('insPlan'), ded: val('insDed'), term: val('insTerm'), sell: val('insSell') },
    sim: { card: val('simCard'), handling: val('simHandling'), pairing: val('pairingOption') },
    licenses: { vendor: val('licVendor'), duration: val('licDuration'), prorated: val('licProrated'), key: val('licKey'), contact: val('licContact') },
    mdm: {
      carrierSPF: bool('carrierSPF'), planCode: val('planCode'), subsidyNote: bool('subsidyNote'),
      abm: bool('mdmABM'), knox: bool('mdmKnox'), knoxAccount: val('knoxAccount'), zeroTouch: bool('mdmZeroTouch'),
      proServices: bool('mdmPro'),
      services: {
        enabled: bool('svcEnabled'),
        tier: val('svcTier'),
        minutes: val('svcMinutes'),
        sku: val('svcSKU'),
        costPer: val('svcCostPer'),
        total: val('svcCostTotal')
      },
      notes: val('mdmNotes')
    },
    totals: {
      linesSubtotal: t.linesSubtotal, accessories: t.accTotal, services: t.svcTotal, insurance: t.insTotal, tax: t.tax, grand: t.grand, taxExempt: t.taxExempt
    }
  };
}


function copySummary(){ if(!document.getElementById('summary').textContent) buildSummary(); navigator.clipboard.writeText(document.getElementById('summary').textContent||''); }
function validateForm(){
  const errs=[];
  if(!val('billCompany')) errs.push('Billing: Company Name');
  if(!val('billEmail')) errs.push('Billing: Email');
  if(!val('shipStreet')) errs.push('Shipping: Street');
  if(!val('shipCity')||!val('shipState')||!val('shipZip')) errs.push('Shipping: City/State/Zip');
  if(!val('payMethod')) errs.push('Payment: Method');
  const lines=getItems();
  lines.forEach((l,idx)=>{
    if(!(l.sku&&l.qty&&l.sell)) errs.push(`Line ${idx+1}: SKU, Qty, and Sell are required`);
  });
  alert(errs.length?`âŒ ${errs.length} issue(s):\n- ${errs.join('\n- ')}`:'âœ… Looks good.');
}

/* ===== CSV for OM Email ===== */
function csvEscape(v){
  const s = String(v ?? '');
  if (/[",\r\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}
function buildCSV(){
  const t = computeTotals();
  const lines = getItems();

  const top = [
    ['Document Type', [...document.querySelectorAll('input[name="doctype"]')].find(x=>x.checked)?.value || 'QUOTE'],
    ['New Customer', bool('flagNewCustomer') ? 'Yes' : 'No'],
    ['WCP', bool('flagWCP') ? 'Yes' : 'No'],
    ['Current Customer', bool('flagCurrentCustomer') ? 'Yes' : 'No'],
    ['3PL Restock', bool('flag3PL') ? 'Yes' : 'No'],
  ];

  const sales = [
    ['Primary Rep', val('rep1')], ['Secondary Rep', val('rep2')], ['Referral Partner', val('refPartner')],
    ['Carrier Rep Name', val('carrierRepName')], ['Carrier Rep Email', val('carrierRepEmail')], ['CUC Rep', val('cucRep')]
  ];

  const billing = [
    ['Company', val('billCompany')], ['Billing Contact', val('billContact')], ['Billing Phone', val('billPhone')], ['Billing Email', val('billEmail')],
    ['Billing Street', val('billStreet')], ['Billing Suite', val('billSuite')], ['Billing City', val('billCity')], ['Billing State', val('billState')], ['Billing Zip', val('billZip')]
  ];

  const payment = [
    ['Payment Method', val('payMethod')], ['Payment Terms', val('payTerms')],
    ['Purchase Agreement', bool('hasAgreement') ? 'Yes' : 'No'], ['Tax Exempt', bool('taxExempt') ? 'Yes' : 'No']
  ];

  const shipping = [
    ['Ship Company/Care Of', val('shipCompany')], ['Ship Contact', val('shipContact')], ['Ship Phone', val('shipPhone')], ['Ship Email', val('shipEmail')],
    ['Ship Street', val('shipStreet')], ['Ship Suite', val('shipSuite')], ['Ship City', val('shipCity')], ['Ship State', val('shipState')], ['Ship Zip', val('shipZip')],
    ['Residence', bool('resShip') ? 'Yes' : 'No'],
    ['Ship Pay Method', val('shipPay')], ['Ship Speed', val('shipSpeed')], ['Short Ship', val('shortShip')],
    ['Requested Ship Date', val('reqShipDate')], ['Expected Ship Date', val('expShipDate')],
    ['Internal Notes', document.getElementById('notes')?.value || '']
  ];

  const itemsHeader = [
  'Line',
  'Description',
  'SKU',
  'Qty',
  'Sell Price',
  'Line Instruction',
  'Model / Part #',
  'Color',
  'Net Type',
  'Carrier',
  'Act Payout $',
  'MSRP',
  'Disc %',
  'New / CPO',
  'In Stock?',
  'Vendor',
  'Quoted Cost',
  'DLL / SPA Price / Deal Reg #',
  'Hold/Reservation #',
  'Delivery Lead Time',
  'EOL Confirm'
];

  const itemsRows = lines.length ? lines.map((l,i)=>[
  i+1,
  l.desc,
  l.sku,
  l.qty,
  l.sell,
  l.lineInstr,
  l.model,
  l.color,
  l.net,
  l.carrier,
  l.payout,
  l.msrp,
  l.disc,
  l.cond,
  l.stock,
  l.vendor,
  l.cost,
  l.deal,
  l.hold,
  l.leadtime,
  l.eol
]) : [['(no items)']];


  const accessory = [
    ['Accessory SKU', val('accSku')], ['Accessory Description', val('accDesc')],
    ['Accessory Qty (per unit)', val('accQty')], ['Accessory Sell Price', val('accSell')],
    ['Include Brick + Cable', document.getElementById('bcInclude')?.checked ? 'Yes' : 'No']
  ];

  const services = [
    ['Services Included', bool('svcEnabled') ? 'Yes' : 'No'], ['Services Tier', val('svcTier')],
    ['Services Minutes (per device)', val('svcMinutes')], ['Services SKU', val('svcSKU')], ['Services $/device', val('svcCostPer')], ['Services Total', val('svcCostTotal')]
  ];

  const insurance = [
    ['Insurance Plan', val('insPlan')], ['DecomposeOMEmail()ductible', val('insDed')], ['Coverage Term', val('insTerm')], ['Insurance Sell Price', val('insSell')]
  ];

  const sim = [
    ['SIM Card', val('simCard')], ['Pairing Option', val('pairingOption')], ['SIM Handling', val('simHandling')], ['Helix SIM Questionnaire', val('simQuestionnaire')]
  ];

  const licenses = [
    ['License Vendor', val('licVendor')], ['License Duration', val('licDuration')], ['Prorated Price', val('licProrated')], ['License Key / Simba Code', val('licKey')], ['New SKU Contact', val('licContact')]
  ];

  const mdm = [
    ['Carrier SPF Subsidy', bool('carrierSPF')?'Yes':'No'], ['Business Internet Plan Code', val('planCode')], ['Subsidy Verbiage', bool('subsidyNote')?'Yes':'No'],
    ['ABM Enrollment', bool('mdmABM')?'Yes':'No'], ['Knox Enrollment (KME)', bool('mdmKnox')?'Yes':'No'], ['Knox Account #', val('knoxAccount')],
    ['Android Zero Touch', bool('mdmZeroTouch')?'Yes':'No'], ['MDM Pro Services', bool('mdmPro')?'Yes':'No'], ['MDM Notes', val('mdmNotes')]
  ];

  const totals = [
    ['Lines Subtotal', fmt(t.linesSubtotal)],
    ['Accessories', fmt(t.accTotal)], ['Services', fmt(t.svcTotal)], ['Insurance', fmt(t.insTotal)],
    ['Tax', `${fmt(t.tax)}${t.taxExempt ? ' (Exempt)' : ''}`],
    ['Grand Total', fmt(t.grand)]
  ];

  const chunks = [];
  function pushSection(title, rows){
    chunks.push([title]);
    rows.forEach(r=>chunks.push(r));
    chunks.push(['']);
  }
  pushSection('DOCUMENT', top);
  pushSection('SALES / PARTNER', sales);
  pushSection('BILLING', billing);
  pushSection('PAYMENT', payment);
  pushSection('SHIPPING', shipping);

  chunks.push(['ITEMS']);
  chunks.push(itemsHeader);
  itemsRows.forEach(r=>chunks.push(r));
  chunks.push(['']);

  pushSection('ACCESSORY', accessory);
  pushSection('SERVICES', services);
  pushSection('INSURANCE', insurance);
  pushSection('SIM / PAIRING', sim);
  pushSection('LICENSES', licenses);
  pushSection('MDM & CARRIER SUBSIDY', mdm);
  pushSection('TOTALS', totals);

  return chunks.map(row => row.map(csvEscape).join(',')).join('\r\n');
}
function refreshCSVPreview(){
  const csv = buildCSV();
  const ta = document.getElementById('csvPreview');
  if(ta){ ta.value = csv; }
  updateMailtoLink(); // keep mailto fresh
}
function copyCSVToClipboard(){
  const ta = document.getElementById('csvPreview');
  const txt = ta?.value || buildCSV();
  navigator.clipboard.writeText(txt);
  alert('CSV copied to clipboard.');
}
function downloadCSVFile(){
  const csv = document.getElementById('csvPreview')?.value || buildCSV();
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const company = (val('billCompany') || 'intake').replace(/[^\w.-]+/g,'_');
  a.href = url;
  a.download = `connectus_intake_${company}.csv`;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}
function composeOMEmail(){
  const to = encodeURIComponent(document.getElementById('emailTo')?.value || 'service@connectuscorp.com');
  const subj = encodeURIComponent(document.getElementById('emailSubject')?.value || 'New Intake â€” CSV Summary');
  const csv = document.getElementById('csvPreview')?.value || buildCSV();
  const bodyText = `Hello Order Management,\r\n\r\nPlease find the intake details below in CSV format.\r\n\r\n${csv}\r\n\r\nâ€” ConnectUS Intake`;
  const body = encodeURIComponent(bodyText);
  window.location.href = `mailto:${to}?subject=${subj}&body=${body}`;
}
// Utility: cap body length so mail clients don't choke
function truncateForMailto(str, max = 6000){
  if (str.length <= max) return str;
  return str.slice(0, max - 80) + "\n\nâ€¦(truncated)";
}

// Open mail with the human-readable Summary instead of CSV
function composeOMEmailNoCSV(){
  const toRaw   = document.getElementById('emailTo')?.value || 'service@connectuscorp.com';
  const subjRaw = document.getElementById('emailSubject')?.value || 'New Intake â€” Summary';

  const oiText  = getSelText('oiType') || 'Standard Order'
  const summaryText = (document.getElementById('summary')?.textContent || '').trim() || '(no summary available)';
  const company = (document.getElementById('billCompany')?.value || '').trim();
   
  const header  = `Hello Order Management,\n\n${company ? `Company: ${company}\n` : ''}Below is the intake summary:\n\n`;
  const footer  = `\n\nâ€” ConnectUS Intake`;
  const bodyText = header + summaryText + footer;

  const to   = encodeURIComponent(toRaw);
  const subj = encodeURIComponent(subjRaw);
  const body = encodeURIComponent(bodyText);

  const href = `mailto:${to}?subject=${subj}&body=${body}`;
  console.log("Opening:", href); // debug
  openMailto(href);
}


function buildMailtoHref(){
  const to = encodeURIComponent(document.getElementById('emailTo')?.value || 'service@connectuscorp.com');
  const subj = encodeURIComponent(document.getElementById('emailSubject')?.value || 'New Intake â€” CSV Summary');
  const csv = document.getElementById('csvPreview')?.value || buildCSV();
  const bodyText = `Hello Order Management,\r\n\r\nPlease find the intake details below in CSV format.\r\n\r\n${csv}\r\n\r\nâ€” ConnectUS Intake`;
  const body = encodeURIComponent(bodyText);
  return `mailto:${to}?subject=${subj}&body=${body}`;
}
function updateMailtoLink(){
  const a = document.getElementById('mailtoHref');
  if(!a) return;
  a.href = buildMailtoHref();
  a.textContent = 'Open in default mail app';
}
function setMailAppLinkFromPreview(){
  const to      = document.getElementById('sspTo')?.value?.trim() || '';
  const subject = document.getElementById('sspSubject')?.value?.trim() || 'Sales Order';
  const body    = (typeof buildCSV === 'function')
                    ? buildCSV()
                    : (document.getElementById('csvPreview')?.value || '');
  const a = document.getElementById('openMailApp');
  if (!a) return;
  const href = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  a.setAttribute('href', href);
}
// update link before navigating
document.getElementById('openMailApp')?.addEventListener('click', (e)=>{
  setMailAppLinkFromPreview();
});
/* ===== Demo flow ===== */
const DEMO_CUSTOMER_FULL={
  "company":"Acme Corp",
  "billing":{"contact":"John Doe","phone":"555-1111","email":"john@acme.com","street":"1 Main St","suite":"Ste 100","city":"Philadelphia","state":"PA","zip":"19104"},
  "shipping":{"company":"Acme Warehouse","contact":"Jane Smith","phone":"555-2222","email":"wh@acme.com","street":"500 Dock Rd","suite":"","city":"Philadelphia","state":"PA","zip":"19112"},
  "payment":{"method":"Credit Card","terms":"Due on receipt","taxExempt":true,"agreement":false},
  "shippingOptions":{"pay":"Prepaid","speed":"Ground","shortShip":"No"},
  "carrierRep":{"name":"Verizon Biz Rep","email":"vrep@vz.com"},
  "rep":{"primary":"Lucas Currin","secondary":"â€”"}
};
document.getElementById('btnDemoFlow').addEventListener('click', ()=>{
  openDrawer('drawerWCP');
  document.getElementById('wcpQuery').value='Acme Corp';
  document.getElementById('wcpPaste').value=JSON.stringify(DEMO_CUSTOMER_FULL,null,2);
  applyPastedCustomer('wcpPaste');
  addRow(QUOTE_REQUEST_MAP["QR-2025-00123"]);
  document.getElementById('svcEnabled').checked = true; document.getElementById('svcTier').value = '1'; tierToMinutes(); recalcServices();
  document.querySelector('.tab[data-tab="shipping"]').click();
  buildSummary();
  openDrawer('drawerEmail');
});

/* ===== Utilities ===== */
function setByPath(obj,path,val){ const ks=path.split('.'); let r=obj; ks.slice(0,-1).forEach(k=>{ if(!(k in r)) r[k]={}; r=r[k]; }); r[ks.pop()]=val; }
function pick(...vals){ return vals.find(v=>v!==undefined && v!==null && String(v).length>0) || ''; }
function setVal(id, v) {
  const el = document.getElementById(id);
  if (!el || v === undefined || v === null) return;
  const prev = el.value;
  el.value = v;
  if (prev !== v) {
    el.dispatchEvent(new Event('input',  { bubbles: true }));
    el.dispatchEvent(new Event('change', { bubbles: true }));
  }
}

function selectByText(id,txt){ const sel=document.getElementById(id); if(!sel) return; [...sel.options].forEach((o,i)=>{ if(o.text.trim().toLowerCase()===String(txt).trim().toLowerCase()) sel.selectedIndex=i; }); }
function selectByTextExact(id, text) {
  const s = document.getElementById(id);
  if (!s || text == null) return;
  const t = String(text).trim().toLowerCase();
  let done = false;
  for (const o of s.options) {
    if (o.text.trim().toLowerCase() === t) { s.value = o.value; done = true; break; }
  }
  if (!done) {
    for (const o of s.options) {
      if (String(o.value).trim().toLowerCase() === t) { s.value = o.value; break; }
    }
  }
  s.dispatchEvent(new Event('change', { bubbles: true }));
}


/* ===== Autosize Inputs (Items table) ===== */
const __fitMeasure = document.createElement('span');
__fitMeasure.style.cssText = [
  'position:absolute','visibility:hidden','white-space:pre','top:-9999px','left:-9999px',
  'font:inherit','letter-spacing:inherit'
].join(';');
document.body.appendChild(__fitMeasure);

function autosizeWidth(el){
  if(!el) return;
  const txt = el.value || el.placeholder || '';
  // mirror computed typography so measurement matches
  const cs = window.getComputedStyle(el);
  __fitMeasure.style.font = cs.font;
  __fitMeasure.style.letterSpacing = cs.letterSpacing;

  __fitMeasure.textContent = txt.replace(/\s/g, '\u00A0'); // keep spaces
  const padding = 18; // a little breathing room
  const min = 72, max = 560;

  // Set width based on measured text
  const w = Math.min(Math.max(__fitMeasure.offsetWidth + padding, min), max);
  el.style.width = w + 'px';
}

function wireAutosize(el){
  if(!el) return;
  el.classList.add('autosize');
  autosizeWidth(el);
  // reflow on user edits & when placeholder is removed
  el.addEventListener('input', ()=>autosizeWidth(el));
  el.addEventListener('change', ()=>autosizeWidth(el));
  // if fonts load late, reflow once
  window.requestAnimationFrame(()=>autosizeWidth(el));
}


/* Simple clear to avoid undefined handler */
function clearAll(){
  // Clear all inputs/checkboxes/selects in visible panels
  document.querySelectorAll('input, select, textarea').forEach(el=>{
    if(el.id==='emailTo' || el.id==='emailSubject') return; // keep OM default
    if(el.type==='checkbox' || el.type==='radio'){ el.checked = false; }
    else if(el.tagName==='SELECT'){ el.selectedIndex = 0; }
    else{ el.value=''; 
        
      // Keep legacy toggle bar hidden after clear
  const tb = document.getElementById('toggleBar');
  if (tb) { tb.style.display = 'none'; tb.setAttribute('aria-hidden','true'); }

    }
  
    // Wizard reset
  document.querySelectorAll('input[name="wizCustomerType"], input[name="wizDocType"], input[name="wizScope"]').forEach(i=>i.checked=false);
  const s2 = document.getElementById('wizStep2'); if(s2) s2.style.display = 'none';
  const s3 = document.getElementById('wizStep3'); if(s3) s3.style.display = 'none';
  setWizardDone(false);
  showIntakeWork(false);
  const wh = document.getElementById('wizHint'); if(wh) wh.textContent = 'Complete steps 1â€“3 to unlock the intake tabs.';

  });
  // Reset items table
  document.getElementById('itemsBody').innerHTML='';
  addRow(); // leave one empty row
  // Totals + summary
  refreshTotals();
  document.getElementById('summary').textContent='';
  refreshCSVPreview();
}

/* ===== Sales Rep Management panel logic ===== */
function renderRepList(){
  const list = getReps();
  const target = document.getElementById('repList');
  target.innerHTML='';
  if(list.length===0){ target.textContent='No reps yet.'; return; }
  const tbl=document.createElement('table'); tbl.className='table';
  tbl.innerHTML=`<thead><tr><th>Name</th><th>Email</th><th>Slug</th><th>Actions</th></tr></thead>`;
  const tb=document.createElement('tbody');
  list.forEach(r=>{
    const tr=document.createElement('tr');
    const actions=el('td',{},[
      el('button',{class:'ghost',onclick:()=>loadRepIntoForm(r)},[document.createTextNode('Edit')]),
      el('button',{class:'bad',style:'margin-left:8px',onclick:()=>deleteRep(r.name)},[document.createTextNode('Delete')])
    ]);
    tr.innerHTML=`<td>${r.name}</td><td>${r.email}</td><td>${r.slug||''}</td>`;
    tr.appendChild(actions);
    tb.appendChild(tr);
  });
  tbl.appendChild(tb);
  target.appendChild(tbl);
  populateRepSelects();
}
function populateRepSelects(){
  const reps=getReps();
  const primary=document.getElementById('rep1'); const secondary=document.getElementById('rep2');
  const mk=(sel,isPrimary)=>{
    sel.innerHTML='';
    if(isPrimary){
      const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='Select Primary Sales Rep'; sel.appendChild(opt0);
    }else{
      const optdash=document.createElement('option'); optdash.textContent='â€”'; sel.appendChild(optdash);
    }
    reps.forEach(r=>{ const o=document.createElement('option'); o.text=r.name; sel.appendChild(o); });
    const other=document.createElement('option'); other.textContent='Other'; sel.appendChild(other);
  };
  mk(primary,true); mk(secondary,false);
}
function loadRepIntoForm(r){
  setVal('repNameInput', r.name);
  setVal('repEmailInput', r.email);
  setVal('repSlugInput', r.slug||'');
  document.getElementById('repTemplatePick').value='custom';
  document.getElementById('repTemplateText').value=r.template||'';
}
function deleteRep(name){
  if(!confirm(`Delete ${name}?`)) return;
  const left=getReps().filter(r=>r.name!==name);
  saveReps(left); renderRepList();
}
document.getElementById('repTemplatePick').addEventListener('change', e=>{
  const v=e.target.value;
  if(BASE_TEMPLATES[v]){
    document.getElementById('repTemplateText').value=BASE_TEMPLATES[v];
  }
});
document.getElementById('btnSaveRep').addEventListener('click', ()=>{
  const name=val('repNameInput'); const email=val('repEmailInput'); const slug=val('repSlugInput'); const template=document.getElementById('repTemplateText').value||'';
  if(!name||!email){ alert('Name and Email are required.'); return; }
  const reps=getReps();
  const idx=reps.findIndex(r=>r.name===name);
  const item={name,email,slug,template};
  if(idx>=0) reps[idx]=item; else reps.push(item);
  saveReps(reps);
  renderRepList();
  alert('Rep saved.');
});
document.getElementById('btnResetRepForm').addEventListener('click', ()=>{
  setVal('repNameInput',''); setVal('repEmailInput',''); setVal('repSlugInput',''); document.getElementById('repTemplateText').value='';
});

/* ===== Wire up Email drawer open ===== */
document.getElementById('btnOpenEmail').addEventListener('click', ()=> {
  setTimeout(()=>{ 
    refreshCSVPreview();
    updateMailtoLink();
  }, 50);
});

document.getElementById('btnSubmitIntake')?.addEventListener('click', async ()=>{
  const btn = document.getElementById('btnSubmitIntake');
  const status = document.getElementById('submitStatus');
  try{
    const errs = [];
    if(!val('billCompany')) errs.push('Billing Company');
    if(!val('billEmail')) errs.push('Billing Email');
    if(getItems().length === 0) errs.push('At least one Item line');
    if(errs.length){ alert(`Please complete: ${errs.join(', ')}`); return; }

    btn.disabled = true; btn.textContent = 'Submittingâ€¦';
    status.textContent = 'Sending to serverâ€¦';

    const payload = buildIntakePayload();
    const resp = await api('/intake', { method:'POST', body: payload });

    status.textContent = `Saved: ${resp.id || '(ok)'}`;
    alert('Intake submitted successfully.');
  }catch(err){
    status.textContent = 'Error';
    alert(`Submit failed: ${err.message}`);
  }finally{
    btn.disabled = false; btn.textContent = 'Submit Intake';
    setTimeout(()=> status.textContent='', 3000);
  }
});


/* Keep mailto fresh when inputs change */
['emailTo','emailSubject','csvPreview'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', updateMailtoLink);
});

/* ===== Init ===== */
(function init(){
  // Panels default
  renderRepList();
  populateWizardRepSelect();
  populateSimDropdowns();

  
    // Autosize any existing inputs in the Items table
  document.querySelectorAll('#itemsBody input').forEach(wireAutosize);


    // Gate intake UI on first load
  if(isWizardDone()){
    showIntakeWork(true);
  }else{
    showIntakeWork(false);
  }
  
    // Keep legacy toggle bar hidden
  const tb = document.getElementById('toggleBar');
  if (tb) { tb.style.display = 'none'; tb.setAttribute('aria-hidden','true'); }



  // Intake default UI
  addRow(); // one editable row
  if(document.querySelector('#itemsBody tr')){ showSubtabs(); document.getElementById('totalsBox').style.display=''; }
  tierToMinutes(); recalcServices();

  // Ensure CSV preview is primed
  refreshCSVPreview();
})();

 /* ===== Items: SKU suffix rules ===== */

// Column indexes (0-based) based on your header order
const COL_SKU = 3;       // "OrderTime SKU"
const COL_NEWCPO = 11;   // "New / CPO"

// Evaluate one row for suffix rules
function evalRowSuffixRules(tr){
  const tds = [...tr.querySelectorAll('td')];
  if(!tds.length) return;

  // Get SKU text
  const skuEl = tds[COL_SKU]?.querySelector('input,textarea,select');
  const sku = (skuEl?.value || '').trim();

  // 1) If SKU ends with 10, 20, 29, 99, or 999 â†’ set New/CPO = CPO
  const cpoSuffixes = ['10','20','29','99','999'];
  const endsWithAny = (s, suffixes) => suffixes.some(suf => s.toLowerCase().endsWith(String(suf).toLowerCase()));
  if(sku && endsWithAny(sku, cpoSuffixes)){
    const ncEl = tds[COL_NEWCPO]?.querySelector('input,textarea,select');
    if(ncEl){
      ncEl.value = 'CPO';
      ncEl.dispatchEvent(new Event('input', { bubbles: true }));
      ncEl.dispatchEvent(new Event('change', { bubbles: true }));
    }
  }

  // Return whether SKU ends with '00' (used to toggle new panel)
  return sku && sku.toLowerCase().endsWith('00');
}

// Recompute whether we show the New Device tab/panel
function recomputeNewDeviceTabVisibility(){
  const body = document.getElementById('itemsBody');
  const rows = body ? [...body.querySelectorAll('tr')] : [];
  let needsTab = false;
  rows.forEach(tr => {
    const isNewDevice = evalRowSuffixRules(tr);
    if(isNewDevice) needsTab = true;
  });

  const tab = document.getElementById('tabNewDevice');
  const panel = document.getElementById('panelNewDevice');
  if(tab){
    tab.style.display = needsTab ? '' : 'none';
  }
  if(panel){
    // If hiding and it was the active subpanel, optionally revert to "Accessory"
    panel.style.display = needsTab ? '' : 'none';
    if(!needsTab){
      const active = document.querySelector('.subtab.active[data-sub="newdevice"]');
      if(active){
        active.classList.remove('active');
        const acc = document.querySelector('.subtab[data-sub="accessory"]');
        const accPanel = document.querySelector('[data-subpanel="accessory"]');
        if(acc){ acc.classList.add('active'); }
        if(accPanel){ accPanel.style.display = ''; }
      }
    }
    // ensure subtabs container is visible if any tab exists
    const subtabs = document.getElementById('subtabsArea');
    const panels = document.getElementById('subtabPanels');
    if(subtabs && panels){
      const anyTabVisible = [...subtabs.querySelectorAll('.subtab')].some(b => b.style.display !== 'none');
      if(anyTabVisible){ subtabs.style.display = ''; panels.style.display = ''; }
    }
  }
}

// Delegate keyup/change events on the Items table to catch SKU edits and newly added rows
window.addEventListener('DOMContentLoaded', () => {
  const body = document.getElementById('itemsBody');
  if(!body) return;

  body.addEventListener('input', (e) => {
    const tr = e.target.closest('tr');
    if(!tr) return;
    // Only react when the change is in the SKU column
    const cell = e.target.closest('td');
    if(!cell) return;
    const idx = [...tr.children].indexOf(cell);
    if(idx === COL_SKU){
      // Re-run rules for this row and refresh panel visibility
      evalRowSuffixRules(tr);
      recomputeNewDeviceTabVisibility();
    }
  });

  // Also run once after page load (in case of prefilled example)
  recomputeNewDeviceTabVisibility();
});

// New Device panel: dependent field visibility
window.addEventListener('DOMContentLoaded', () => {
  const stockSel = document.getElementById('ndStockOK');
  const leadWrap = document.getElementById('ndLeadWrap');
  if(stockSel && leadWrap){
    stockSel.addEventListener('change', () => {
      leadWrap.style.display = (stockSel.value === 'No') ? '' : 'none';
    });
  }
  const sameShip = document.getElementById('ndSameShip');
  const altShipWrap = document.getElementById('ndAltShipWrap');
  if(sameShip && altShipWrap){
    sameShip.addEventListener('change', () => {
      altShipWrap.style.display = (sameShip.value === 'No') ? '' : 'none';
    });
  }
  const svcSame = document.getElementById('ndSvcSame');
  const svcWrap = document.getElementById('ndSvcWrap');
  if(svcSame && svcWrap){
    svcSame.addEventListener('change', () => {
      svcWrap.style.display = (svcSame.value === 'No') ? '' : 'none';
    });
  }
});


</script>
<script>
// ===== Existing Sales Order: In-App Search + Apply =====

// Wire the search button + Enter key
document.getElementById('btnSoSearch')?.addEventListener('click', soRunSearch);
document.getElementById('soSearchInput')?.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter') soRunSearch();
});

async function soRunSearch(){
  const box = document.getElementById('soSearchResults');
  const q   = (document.getElementById('soSearchInput')?.value || '').trim();

  const looksDocNo = /^[A-Za-z\-]*\d[\w\-]*$/.test(q);
  if (looksDocNo) {
    box.innerHTML = 'Loading orderâ€¦';
    try {
      await soApplyByDocNo(q);           // uses /api/ordertime/salesorders/get?docNo=...
      box.innerHTML = '<div class="muted">Applied by DocNo.</div>';
    } catch (err) {
      box.innerHTML = `<div class="muted">Failed: ${String(err.message || err)}</div>`;
    }
    return;
  }

  if (!q) { box.innerHTML = '<div class="muted">Enter a query.</div>'; return; }

  box.innerHTML = 'Searchingâ€¦';
  try {
    const url = `/api/ordertime/salesorders/search?q=${encodeURIComponent(q)}&take=25`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
    const rows = await res.json();

    if (!Array.isArray(rows) || !rows.length) {
      box.innerHTML = '<div class="muted">No results.</div>';
      return;
    }

    // ... render rows w/ Apply buttons (keep your existing renderer)
  } catch (err) {
    console.error('SO search failed', err);
    box.innerHTML = `<div class="muted">Error: ${String(err.message || err)}</div>`;
  }
}


// Fetch full order (normalized) and apply to Intake
async function soApplyByDocNo(docNo){
  try {
    const res = await fetch(`/api/ordertime/salesorders/get?docNo=${encodeURIComponent(docNo)}`);
    if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
    const payload = await res.json();
    const order   = payload?.order || payload; // normalized here

    if (!order || !order.billing) throw new Error('No order data');

    // Persist docNo if you include it in CSV header later
    window.__cloneDocNo = order.docNo || docNo;

    // Apply Customer/Billing
    setVal('billCompany', order.billing.company);
    setVal('billContact', order.billing.contact);
    setVal('billPhone',   order.billing.phone);
    setVal('billEmail',   order.billing.email);
    setVal('billStreet',  order.billing.street);
    setVal('billSuite',   order.billing.suite);
    setVal('billCity',    order.billing.city);
    setVal('billState',   order.billing.state);
    setVal('billZip',     order.billing.zip);

    // Apply Shipping
    setVal('shipCompany', order.shipping.company || order.billing.company);
    setVal('shipContact', order.shipping.contact);
    setVal('shipPhone',   order.shipping.phone);
    setVal('shipEmail',   order.shipping.email);
    setVal('shipStreet',  order.shipping.street);
    setVal('shipSuite',   order.shipping.suite);
    setVal('shipCity',    order.shipping.city);
    setVal('shipState',   order.shipping.state);
    setVal('shipZip',     order.shipping.zip);
    const resBox = document.getElementById('resShip');
    if (resBox) resBox.checked = !!order.shipping.residence;

    // Optional: customer PO / terms if you expose them
    setVal('customerPO', order.customer?.po);
    setVal('payTerms',   order.customer?.terms);

    // Populate Items table
    await replaceItemsWithOrderLines(order.lines || []);

    // Surface intake tabs if your wizard gates them
    openIntakeTabs();

    // Close the drawer after applying
    closeDrawer?.('drawerClone');

  } catch (err) {
    alert(`Failed to apply Sales Order: ${String(err.message || err)}`);
    console.error(err);
  }
}

function setVal(id, v) {
  const el = document.getElementById(id);
  if (el) el.value = (v ?? '').toString();
}

function openIntakeTabs(){
  // Minimal: show Intake main panel + intake tabs
  document.querySelector('[data-mainpanel="intake"]')?.classList.add('active');
  document.querySelector('[data-mainpanel="reps"]')?.classList?.remove('active');
  document.querySelector('#intakeTabs')?.removeAttribute('style');
  document.getElementById('stepper')?.removeAttribute('style');
}

// Replace items table with order lines
async function replaceItemsWithOrderLines(lines){
  const body = document.getElementById('itemsBody');
  if (!body) return;

  // Clear
  body.innerHTML = '';

  // Add each line
  for (const L of lines) {
    // Use your existing helper that inserts a blank row with inputs/selects
    if (typeof addRow === 'function') addRow();
    const tr = body.querySelector('tr:last-child');
    if (!tr) continue;

    const tds = tr.querySelectorAll('td');

    // Your columns (adjust if your table differs):
    // 0:Desc, 1:Model, 2:Color, 3:OrderTime SKU, 4:Qty, 5:LTE/Wi-Fi/Both, 6:Carrier,
    // 7:Act Payout, 8:MSRP, 9:Disc %, 10:Sell Price, 11:New/CPO, 12:In Stock?, 13:Vendor,
    // 14:Quoted Cost, 15:DLL/SPA/DealReg, 16:Hold/Res, 17:Delivery Lead, 18:EOL Confirm, 19:Remove

    // Description
    setCellInput(tds[0], L.description || L.item || '');
    // SKU
    setCellInput(tds[3], L.sku || '');
    // Qty
    setCellInput(tds[4], (L.qty ?? '').toString());
    // LTE / Wi-Fi / Both
    setCellInput(tds[5], L.attributes?.lteWifiBoth || '');
    // Carrier
    setCellInput(tds[6], L.attributes?.carrier || '');
    // Sell Price
    setCellInput(tds[11], (L.unitPrice ?? '').toString());
    // New/CPO
    setCellInput(tds[12], L.attributes?.condition || '');

    // Optional: keep Line Item ID (hidden) if your CSV needs it
    const hidden = document.createElement('input');
    hidden.type  = 'hidden';
    hidden.name  = 'lineItemId';
    hidden.value = (L.lineId ?? '').toString();
    tr.appendChild(hidden);
  }

  // Reveal subtabs area if you hide it when empty
  document.getElementById('subtabsArea')?.removeAttribute('style');
  document.getElementById('subtabPanels')?.removeAttribute('style');
}

function setCellInput(td, val) {
  if (!td) return;
  const el = td.querySelector('input,textarea,select');
  if (el) el.value = (val ?? '').toString();
}
</script>

<!-- ===== Multi-Draft Save/Resume (Per Sales Rep) ===== -->
<script>
  const INTAKE_DRAFT_PREFIX = 'connectus_intake_draft_v2::';
  const INTAKE_MAX_DRAFTS_PER_REP = 5;

  function getCurrentRepContext() {
    const sel = document.getElementById('wizRepPick');
    if (!sel) return null;
    const name = sel.value || '';
    if (!name || name === 'Other') return null;

    let slug = name;
    try {
      if (typeof getRepByName === 'function') {
        const rep = getRepByName(name);
        if (rep && rep.slug) slug = rep.slug;
      }
    } catch (err) {
      console.warn('getRepByName failed', err);
    }

    return { name, slug };
  }

  function getRepDraftKey(ctx) {
    if (!ctx || !ctx.slug) return null;
    return INTAKE_DRAFT_PREFIX + ctx.slug;
  }

  function loadRepDrafts(ctx) {
    const key = getRepDraftKey(ctx);
    if (!key) return [];
    const raw = localStorage.getItem(key);
    if (!raw) return [];
    try {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed.drafts)) return parsed.drafts;
      // Backwards compat: if we ever stored a single draft
      if (parsed && parsed.fields) return [parsed];
      return [];
    } catch (err) {
      console.error('Failed to parse drafts JSON', err);
      return [];
    }
  }

  function saveRepDrafts(ctx, drafts) {
    const key = getRepDraftKey(ctx);
    if (!key) return;
    const payload = { drafts: drafts || [] };
    localStorage.setItem(key, JSON.stringify(payload));
  }

  function collectIntakeDraftState() {
    const panel = document.querySelector('[data-mainpanel="intake"]');
    if (!panel) return null;

    const now = Date.now();
const data = {
  ts: now,
  fields: {},
  itemsHTML: null,
  itemsData: []          // ðŸ”¹ NEW: store values per cell
};

// Capture all inputs/selects/textareas with an ID inside Intake panel
panel.querySelectorAll('input[id], select[id], textarea[id]').forEach(el => {
  const id = el.id;
  if (!id) return;

  if (el.type === 'checkbox' || el.type === 'radio') {
    data.fields[id] = { type: el.type, checked: el.checked };
  } else {
    data.fields[id] = { type: 'value', value: el.value };
  }
});

// ðŸ” Capture Items table body HTML (all lines, QR IDs, SKUs, Qty, etc.)
const itemsBody = document.getElementById('itemsBody');
if (itemsBody) {
  // Keep the structure (rows, columns, buttons, etc.)
  data.itemsHTML = itemsBody.innerHTML;

  // Also capture the values in each cell so we can restore them later
  const rows = Array.from(itemsBody.querySelectorAll('tr'));
  data.itemsData = rows.map(tr => {
    const cells = Array.from(tr.querySelectorAll('td'));
    return cells.map(td => {
      const el = td.querySelector('input,select,textarea');
      if (!el) return null;

      if (el.type === 'checkbox' || el.type === 'radio') {
        return { type: el.type, checked: el.checked };
      }

      return { type: 'value', value: el.value };
    });
  });
}

return data;

  }

  function buildDraftLabel() {
    const billCompany = document.getElementById('billCompany')?.value?.trim();
    const shipCompany = document.getElementById('shipCompany')?.value?.trim();
    const custLabel = billCompany || shipCompany || 'Untitled';

    let docType = 'Unknown';
    try {
      const checked = document.querySelector('input[name="doctype"]:checked');
      if (checked && checked.value) docType = checked.value;
    } catch (_) {}

    return `${custLabel} â€” ${docType}`;
  }

  function saveIntakeDraft() {
    const ctx = getCurrentRepContext();
    if (!ctx) {
      alert('Select a Sales Rep in Step 1 before saving a draft.');
      return;
    }

    const state = collectIntakeDraftState();
    if (!state) {
      alert('Nothing to save right now.');
      return;
    }

    const label = buildDraftLabel();
    const draft = {
  id: state.ts,  // simple unique id
  ts: state.ts,
  label,
  fields: state.fields,
  itemsHTML: state.itemsHTML,
  itemsData: state.itemsData || []   // ðŸ”¹ NEW
};


    let drafts = loadRepDrafts(ctx);
    drafts.push(draft);

    // Keep newest first, limit count
    drafts.sort((a, b) => b.ts - a.ts);
    if (drafts.length > INTAKE_MAX_DRAFTS_PER_REP) {
      drafts = drafts.slice(0, INTAKE_MAX_DRAFTS_PER_REP);
    }

    saveRepDrafts(ctx, drafts);

    const status = document.getElementById('submitStatus');
    if (status) {
      const dt = new Date(draft.ts);
      status.textContent = `Draft saved (${ctx.name} Â· ${label}) at ` + dt.toLocaleString();
    }

    alert(`Draft saved for ${ctx.name}:\n${label}`);
  }

  function applyIntakeDraft(draft) {
    if (!draft || !draft.fields) return false;

    // Restore fields
    for (const [id, meta] of Object.entries(draft.fields)) {
      const el = document.getElementById(id);
      if (!el) continue;

      if (meta.type === 'checkbox' || meta.type === 'radio') {
        el.checked = !!meta.checked;
      } else {
        el.value = meta.value ?? '';
      }
    }

    // Restore Items table HTML + values
const itemsBody = document.getElementById('itemsBody');
if (itemsBody && typeof draft.itemsHTML === 'string') {
  // First restore the structure
  itemsBody.innerHTML = draft.itemsHTML;

  // Then restore the cell values if we have them
  if (Array.isArray(draft.itemsData)) {
    const rows = Array.from(itemsBody.querySelectorAll('tr'));

    draft.itemsData.forEach((rowData, rIndex) => {
      if (!Array.isArray(rowData)) return;
      const tr = rows[rIndex];
      if (!tr) return;

      const cells = Array.from(tr.querySelectorAll('td'));
      rowData.forEach((cellData, cIndex) => {
        if (!cellData) return;
        const td = cells[cIndex];
        if (!td) return;

        const el = td.querySelector('input,select,textarea');
        if (!el) return;

        if (cellData.type === 'checkbox' || cellData.type === 'radio') {
          el.checked = !!cellData.checked;
        } else {
          el.value = cellData.value ?? '';
        }
      });
    });
  }
}

// Ensure intake UI is visible
if (typeof openIntakeTabs === 'function') {
  openIntakeTabs();
}


    const status = document.getElementById('submitStatus');
    if (status) {
      const dt = draft.ts ? new Date(draft.ts) : null;
      const when = dt ? dt.toLocaleString() : '';
      status.textContent = when
        ? `Resumed draft: ${draft.label} (${when})`
        : `Resumed draft: ${draft.label}`;
    }

    return true;
  }

  function promptAndLoadDraftForCurrentRep() {
    const ctx = getCurrentRepContext();
    if (!ctx) return;

    const drafts = loadRepDrafts(ctx);
    if (!drafts.length) return;

    if (drafts.length === 1) {
      const d = drafts[0];
      const dt = d.ts ? new Date(d.ts).toLocaleString() : '';
      const msg = dt
        ? `A saved draft for ${ctx.name} from ${dt} was found:\n${d.label}\n\nDo you want to load it?`
        : `A saved draft for ${ctx.name} was found:\n${d.label}\n\nDo you want to load it?`;
      if (confirm(msg)) {
        const ok = applyIntakeDraft(d);
        if (!ok) alert('Saved draft could not be loaded (it may be corrupted).');
      }
      return;
    }

    // Multiple drafts: let the rep pick one via prompt
    let list = `Saved drafts for ${ctx.name}:\n\n`;
    drafts.forEach((d, idx) => {
      const dt = d.ts ? new Date(d.ts).toLocaleString() : '';
      list += `${idx + 1}) ${d.label}${dt ? ' â€” ' + dt : ''}\n`;
    });
    list += `\nEnter the number of the draft to load, or Cancel to skip.`;

    const choice = prompt(list);
    if (!choice) return;
    const idx = parseInt(choice, 10);
    if (isNaN(idx) || idx < 1 || idx > drafts.length) {
      alert('Invalid choice; no draft loaded.');
      return;
    }

    const selected = drafts[idx - 1];
    const ok = applyIntakeDraft(selected);
    if (!ok) {
      alert('Saved draft could not be loaded (it may be corrupted).');
    }
  }

  function clearIntakeDraft() {
    const ctx = getCurrentRepContext();
    if (!ctx) {
      alert('Select a Sales Rep in Step 1 to clear drafts.');
      return;
    }

    const drafts = loadRepDrafts(ctx);
    if (!drafts.length) {
      alert(`No drafts found for ${ctx.name} on this browser.`);
      return;
    }

    if (!confirm(`This will delete ALL saved drafts for ${ctx.name} on this browser. Continue?`)) {
      return;
    }

    saveRepDrafts(ctx, []); // wipe
    const status = document.getElementById('submitStatus');
    if (status) status.textContent = `All drafts cleared for ${ctx.name}.`;
    alert(`All drafts cleared for ${ctx.name} on this browser.`);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const saveBtn  = document.getElementById('btnSaveDraft');
    const clearBtn = document.getElementById('btnClearDraft');
    const repSel   = document.getElementById('wizRepPick');

    if (saveBtn)  saveBtn.addEventListener('click', saveIntakeDraft);
    if (clearBtn) clearBtn.addEventListener('click', clearIntakeDraft);

    if (repSel) {
      repSel.addEventListener('change', () => {
        // When rep changes, offer to load one of their drafts (if any)
        promptAndLoadDraftForCurrentRep();
      });
    }
  });
</script>

</body>
</html>
